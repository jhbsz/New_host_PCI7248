VERSION 5.00
Object = "{648A5603-2C6E-101B-82B6-000000000014}#1.1#0"; "MSCOMM32.OCX"
Begin VB.Form Tester 
   Caption         =   "Alcor Tester 1.35 build 2006-12-21"
   ClientHeight    =   8490
   ClientLeft      =   60
   ClientTop       =   450
   ClientWidth     =   11400
   BeginProperty Font 
      Name            =   "MS Sans Serif"
      Size            =   9.75
      Charset         =   0
      Weight          =   400
      Underline       =   0   'False
      Italic          =   0   'False
      Strikethrough   =   0   'False
   EndProperty
   LinkTopic       =   "Form1"
   ScaleHeight     =   8490
   ScaleWidth      =   11400
   Begin VB.CommandButton Rec_Mp34 
      Caption         =   "Rec Mp34"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   12
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   615
      Left            =   10200
      TabIndex        =   67
      Top             =   5400
      Width           =   1215
   End
   Begin VB.CommandButton Rec_Mp33 
      Caption         =   "Rec Mp33"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   12
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   615
      Left            =   10200
      TabIndex        =   66
      Top             =   4800
      Width           =   1215
   End
   Begin VB.CommandButton Rec_MP32 
      Caption         =   "Rec Mp32"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   12
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   615
      Left            =   10200
      TabIndex        =   65
      Top             =   4200
      Width           =   1215
   End
   Begin VB.CommandButton Rec_MP31 
      Caption         =   "Rec Mp31"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   12
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   615
      Left            =   10200
      TabIndex        =   64
      Top             =   3600
      Width           =   1215
   End
   Begin VB.CommandButton MP3_Rec 
      Caption         =   "Rec MP3"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   12
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   615
      Left            =   10200
      TabIndex        =   63
      Top             =   3000
      Width           =   1215
   End
   Begin VB.CommandButton Command8 
      Caption         =   "ShowTable"
      Height          =   735
      Left            =   9840
      TabIndex        =   60
      Top             =   2160
      Width           =   1215
   End
   Begin VB.TextBox Text24 
      Height          =   375
      Left            =   8280
      TabIndex        =   58
      Text            =   "Text24"
      Top             =   9120
      Width           =   1335
   End
   Begin VB.TextBox Text23 
      Height          =   375
      Left            =   8280
      TabIndex        =   56
      Text            =   "Text23"
      Top             =   8040
      Width           =   1335
   End
   Begin VB.TextBox Text22 
      Height          =   375
      Left            =   8280
      TabIndex        =   54
      Text            =   "Text22"
      Top             =   7080
      Width           =   1335
   End
   Begin VB.TextBox Text21 
      Height          =   375
      Left            =   8280
      TabIndex        =   52
      Text            =   "Text21"
      Top             =   6120
      Width           =   1335
   End
   Begin VB.TextBox Text20 
      Height          =   375
      Left            =   6720
      TabIndex        =   50
      Text            =   "Text20"
      Top             =   9120
      Width           =   1335
   End
   Begin VB.TextBox Text19 
      Height          =   375
      Left            =   6720
      TabIndex        =   48
      Text            =   "Text19"
      Top             =   8040
      Width           =   1335
   End
   Begin VB.TextBox Text18 
      Height          =   360
      Left            =   6720
      TabIndex        =   46
      Text            =   "Text18"
      Top             =   7080
      Width           =   1335
   End
   Begin VB.TextBox Text17 
      Height          =   375
      Left            =   6720
      TabIndex        =   44
      Text            =   "Text17"
      Top             =   6120
      Width           =   1335
   End
   Begin VB.TextBox Text16 
      Height          =   375
      Left            =   5280
      TabIndex        =   42
      Text            =   "Text16"
      Top             =   9120
      Width           =   1215
   End
   Begin VB.TextBox Text15 
      Height          =   375
      Left            =   5280
      TabIndex        =   40
      Text            =   "Text15"
      Top             =   8040
      Width           =   1215
   End
   Begin VB.TextBox Text14 
      Height          =   375
      Left            =   5280
      TabIndex        =   39
      Text            =   "Text14"
      Top             =   7080
      Width           =   1215
   End
   Begin VB.TextBox Text13 
      Height          =   375
      Left            =   5280
      TabIndex        =   38
      Text            =   "Text13"
      Top             =   6120
      Width           =   1215
   End
   Begin VB.TextBox Text12 
      Height          =   375
      Left            =   3960
      TabIndex        =   34
      Text            =   "Text12"
      Top             =   9120
      Width           =   1215
   End
   Begin VB.TextBox Text11 
      Height          =   375
      Left            =   3960
      TabIndex        =   33
      Text            =   "Text11"
      Top             =   8040
      Width           =   1215
   End
   Begin VB.TextBox Text10 
      Height          =   375
      Left            =   3960
      TabIndex        =   32
      Text            =   "Text10"
      Top             =   7080
      Width           =   1215
   End
   Begin VB.TextBox Text9 
      Height          =   375
      Left            =   3960
      TabIndex        =   31
      Text            =   "Text9"
      Top             =   6120
      Width           =   1215
   End
   Begin VB.TextBox Text8 
      Height          =   375
      Left            =   8280
      TabIndex        =   26
      Text            =   "Text8"
      Top             =   5040
      Width           =   1335
   End
   Begin VB.TextBox Text7 
      Height          =   375
      Left            =   6840
      TabIndex        =   25
      Text            =   "Text7"
      Top             =   5040
      Width           =   1335
   End
   Begin VB.TextBox Text6 
      Height          =   375
      Left            =   5400
      TabIndex        =   24
      Text            =   "Text6"
      Top             =   5040
      Width           =   1335
   End
   Begin VB.TextBox Text4 
      Height          =   375
      Left            =   2280
      TabIndex        =   23
      Text            =   "Text4"
      Top             =   5040
      Width           =   1455
   End
   Begin VB.TextBox Text2 
      Height          =   615
      Left            =   2280
      TabIndex        =   18
      Text            =   "Text2"
      Top             =   5640
      Width           =   1455
   End
   Begin VB.TextBox txtmsg 
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   3495
      Left            =   720
      MultiLine       =   -1  'True
      TabIndex        =   17
      Text            =   "TesterFrm.frx":0000
      Top             =   6360
      Width           =   3135
   End
   Begin VB.TextBox Text1 
      Height          =   615
      Left            =   720
      TabIndex        =   16
      Text            =   "Text1"
      Top             =   5640
      Width           =   1455
   End
   Begin MSCommLib.MSComm MSComm2 
      Left            =   7920
      Top             =   1320
      _ExtentX        =   1005
      _ExtentY        =   1005
      _Version        =   393216
      DTREnable       =   -1  'True
   End
   Begin MSCommLib.MSComm MSComm1 
      Left            =   7320
      Top             =   1320
      _ExtentX        =   1005
      _ExtentY        =   1005
      _Version        =   393216
      DTREnable       =   -1  'True
   End
   Begin VB.TextBox Text5 
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   375
      Left            =   3960
      TabIndex        =   12
      Text            =   "Text5"
      Top             =   5040
      Width           =   1335
   End
   Begin VB.TextBox Text3 
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   375
      Left            =   720
      TabIndex        =   11
      Text            =   "Text3"
      Top             =   5040
      Width           =   1455
   End
   Begin VB.CommandButton Command4 
      Caption         =   "關閉程式"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   12
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   735
      Left            =   7560
      TabIndex        =   10
      Top             =   2160
      Width           =   2295
   End
   Begin VB.Timer Timer1 
      Interval        =   100
      Left            =   8640
      Top             =   1440
   End
   Begin VB.CommandButton Command1 
      BackColor       =   &H008080FF&
      Caption         =   "啟動測試端功能"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   12
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   735
      Left            =   5280
      MaskColor       =   &H0080C0FF&
      TabIndex        =   0
      Top             =   2160
      Width           =   2295
   End
   Begin VB.Label Label35 
      Caption         =   "Label35"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   12
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   495
      Left            =   9840
      TabIndex        =   62
      Top             =   840
      Width           =   1575
   End
   Begin VB.Label Label34 
      Caption         =   "Label34"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   12
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   375
      Left            =   9840
      TabIndex        =   61
      Top             =   240
      Width           =   1455
   End
   Begin VB.Label Label33 
      BackColor       =   &H00FFFFFF&
      Caption         =   "UNKNOW DEVICE"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   9.75
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00C00000&
      Height          =   375
      Left            =   720
      TabIndex        =   59
      Top             =   3600
      Width           =   2295
   End
   Begin VB.Label Label32 
      Caption         =   "Label32"
      Height          =   495
      Left            =   8280
      TabIndex        =   57
      Top             =   8520
      Width           =   1335
   End
   Begin VB.Label Label31 
      Caption         =   "Label31"
      Height          =   495
      Left            =   8280
      TabIndex        =   55
      Top             =   7560
      Width           =   1455
   End
   Begin VB.Label Label30 
      Caption         =   "Label30"
      Height          =   375
      Left            =   8280
      TabIndex        =   53
      Top             =   6600
      Width           =   1335
   End
   Begin VB.Label Label29 
      Caption         =   "Label29"
      Height          =   495
      Left            =   8400
      TabIndex        =   51
      Top             =   5640
      Width           =   1215
   End
   Begin VB.Label Label28 
      Caption         =   "Label28"
      Height          =   495
      Left            =   6720
      TabIndex        =   49
      Top             =   8520
      Width           =   1335
   End
   Begin VB.Label Label27 
      Caption         =   "Label27"
      Height          =   495
      Left            =   6720
      TabIndex        =   47
      Top             =   7560
      Width           =   1335
   End
   Begin VB.Label Label26 
      Caption         =   "Label26"
      Height          =   375
      Left            =   6720
      TabIndex        =   45
      Top             =   6600
      Width           =   1335
   End
   Begin VB.Label Label25 
      Caption         =   "Label25"
      Height          =   495
      Left            =   6840
      TabIndex        =   43
      Top             =   5640
      Width           =   1335
   End
   Begin VB.Label Label24 
      Caption         =   "Label24"
      Height          =   495
      Left            =   5280
      TabIndex        =   41
      Top             =   8520
      Width           =   1095
   End
   Begin VB.Label Label23 
      Caption         =   "Label23"
      Height          =   495
      Left            =   5280
      TabIndex        =   37
      Top             =   7560
      Width           =   1215
   End
   Begin VB.Label Label22 
      Caption         =   "Label22"
      Height          =   375
      Left            =   5280
      TabIndex        =   36
      Top             =   6600
      Width           =   1455
   End
   Begin VB.Label Label21 
      Caption         =   "Label21"
      Height          =   495
      Left            =   5280
      TabIndex        =   35
      Top             =   5640
      Width           =   1455
   End
   Begin VB.Label Label20 
      Caption         =   "Label20"
      Height          =   495
      Left            =   3960
      TabIndex        =   30
      Top             =   8520
      Width           =   1215
   End
   Begin VB.Label Label19 
      Caption         =   "Label19"
      Height          =   615
      Left            =   3960
      TabIndex        =   29
      Top             =   7560
      Width           =   1335
   End
   Begin VB.Label Label18 
      Caption         =   "Label18"
      Height          =   375
      Left            =   3960
      TabIndex        =   28
      Top             =   6600
      Width           =   1215
   End
   Begin VB.Label Label17 
      Caption         =   "Label17"
      Height          =   495
      Left            =   3960
      TabIndex        =   27
      Top             =   5640
      Width           =   1095
   End
   Begin VB.Line Line1 
      X1              =   720
      X2              =   9720
      Y1              =   5520
      Y2              =   5520
   End
   Begin VB.Label Label16 
      Alignment       =   2  'Center
      Caption         =   "BIN5"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   375
      Left            =   8400
      TabIndex        =   22
      Top             =   4560
      Width           =   1335
   End
   Begin VB.Label Label15 
      Alignment       =   2  'Center
      Caption         =   "BIN4"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   375
      Left            =   6960
      TabIndex        =   21
      Top             =   4560
      Width           =   1335
   End
   Begin VB.Label Label14 
      Alignment       =   2  'Center
      Caption         =   "BIN3"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   375
      Left            =   5520
      TabIndex        =   20
      Top             =   4560
      Width           =   1335
   End
   Begin VB.Label Label13 
      Alignment       =   2  'Center
      Caption         =   "BIN2"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   375
      Left            =   4080
      TabIndex        =   19
      Top             =   4560
      Width           =   1335
   End
   Begin VB.Label Label12 
      Caption         =   "Label12"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   735
      Left            =   3120
      TabIndex        =   15
      Top             =   2040
      Width           =   1815
   End
   Begin VB.Label Label11 
      Alignment       =   2  'Center
      Caption         =   "FAIL"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   375
      Left            =   2400
      TabIndex        =   14
      Top             =   4560
      Width           =   1455
   End
   Begin VB.Label Label10 
      Alignment       =   2  'Center
      Caption         =   "PASS"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   375
      Left            =   840
      TabIndex        =   13
      Top             =   4560
      Width           =   1455
   End
   Begin VB.Label Label9 
      Alignment       =   2  'Center
      BackColor       =   &H00FFFFFF&
      Caption         =   "Label9"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00FF0000&
      Height          =   375
      Left            =   720
      TabIndex        =   9
      Top             =   4080
      Width           =   8895
   End
   Begin VB.Label Label8 
      Alignment       =   2  'Center
      BackColor       =   &H00FFFFFF&
      Caption         =   "test result"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00C00000&
      Height          =   375
      Left            =   8400
      TabIndex        =   8
      Top             =   3600
      Width           =   1215
   End
   Begin VB.Label Label7 
      Alignment       =   2  'Center
      BackColor       =   &H00FFFFFF&
      Caption         =   "step5"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00C00000&
      Height          =   375
      Left            =   7200
      TabIndex        =   7
      Top             =   3600
      Width           =   1095
   End
   Begin VB.Label Label6 
      Alignment       =   2  'Center
      BackColor       =   &H00FFFFFF&
      Caption         =   "step4"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00C00000&
      Height          =   375
      Left            =   6240
      TabIndex        =   6
      Top             =   3600
      Width           =   975
   End
   Begin VB.Label Label4 
      Alignment       =   2  'Center
      BackColor       =   &H00FFFFFF&
      Caption         =   "step2"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00C00000&
      Height          =   375
      Left            =   4080
      TabIndex        =   5
      Top             =   3600
      Width           =   1095
   End
   Begin VB.Label Label5 
      Alignment       =   2  'Center
      BackColor       =   &H00FFFFFF&
      Caption         =   "step3"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00C00000&
      Height          =   375
      Left            =   5160
      TabIndex        =   4
      Top             =   3600
      Width           =   1095
   End
   Begin VB.Label Label3 
      Alignment       =   2  'Center
      BackColor       =   &H00FFFFFF&
      Caption         =   "step1"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00C00000&
      Height          =   375
      Left            =   3120
      TabIndex        =   3
      Top             =   3600
      Width           =   975
   End
   Begin VB.Label Label2 
      Alignment       =   2  'Center
      BackColor       =   &H00FFFFFF&
      Caption         =   "Label2"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00C00000&
      Height          =   375
      Left            =   720
      TabIndex        =   2
      Top             =   3000
      Width           =   8895
   End
   Begin VB.Label Label1 
      Alignment       =   2  'Center
      BackColor       =   &H0000FFFF&
      Caption         =   "PC 測試端 TESTER "
      BeginProperty Font 
         Name            =   "Arial"
         Size            =   26.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   1080
      Left            =   6000
      TabIndex        =   1
      Top             =   120
      Width           =   3705
   End
End
Attribute VB_Name = "Tester"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit
Dim InquiryString(0 To 3, 0 To 36) As Byte
Dim AU6375ASHangTime As Single
Dim OldTimer
Const UNKNOW = 0
Const PASS = 1
Const WRITE_FAIL = 2
Const READ_FAIL = 3
Const PREVIOUS_SLOT_FAIL = 4

Dim SDWriteFail As Long
Dim SDReadFail As Long

Dim CFWriteFail As Long
Dim CFReadFail As Long

Dim XDWriteFail As Long
Dim XDReadFail As Long

Dim MSWriteFail As Long
Dim MSReadFail As Long

Dim MiniSDWriteFail As Long
Dim MiniSDReadFail As Long
Dim UnknowDeviceFail As Long
Function Read_DataAU9331(LBA As Long, Lun As Byte, CBWDataTransferLength As Long) As Byte
Dim CBW(0 To 30) As Byte
Dim NumberOfBytesWritten As Long
Dim CBWDataTransferLen(0 To 3) As Byte
  
Dim TransferLen As Long
Dim TransferLenLSB As Byte
Dim TransferLenMSB As Byte
Dim i As Integer
Dim tmpV(0 To 2) As Long
Dim opcode As Byte

Dim CSW(0 To 12) As Byte

Dim NumberOfBytesRead As Long

For i = 0 To 30
   
        CBW(i) = 0
    
Next i

For i = 0 To CBWDataTransferLength
ReadData(i) = 0
Next

Const CBWSignature_0 = &H55
Const CBWSignature_1 = &H53
Const CBWSignature_2 = &H42
Const CBWSignature_3 = &H43


Const CBWTag_0 = &H1
Const CBWTag_1 = &H2
Const CBWTag_2 = &H3
Const CBWTag_3 = &H4


'/////////////////// CBW signature

CBW(0) = CBWSignature_0
CBW(1) = CBWSignature_1
CBW(2) = CBWSignature_2
CBW(3) = CBWSignature_3

'/////////////////  CBW Tag

CBW(4) = CBWTag_0
CBW(5) = CBWTag_1
CBW(6) = CBWTag_2
CBW(7) = CBWTag_3

CBWDataTransferLen(0) = (CBWDataTransferLength Mod 256)
tmpV(0) = Int(CBWDataTransferLength / 256)
CBWDataTransferLen(1) = (tmpV(0) Mod 256)
tmpV(1) = Int(tmpV(0) / 256)
CBWDataTransferLen(2) = (tmpV(1) Mod 256)
tmpV(2) = Int((tmpV(1) / 256))
CBWDataTransferLen(3) = (tmpV(2) Mod 256)

CBW(8) = CBWDataTransferLen(0)  '00
CBW(9) = CBWDataTransferLen(1)  '08
CBW(10) = CBWDataTransferLen(2) '00
CBW(11) = CBWDataTransferLen(3) '00

'///////////////  CBW Flag
CBW(12) = &H80                 '80

'////////////// LUN
CBW(13) = Lun                    '00

'///////////// CBD Len
CBW(14) = &HA                '0a

'////////////  UFI command

CBW(15) = &H28
CBW(16) = Lun * 32
LBAByte(0) = (LBA Mod 256)
tmpV(0) = Int(LBA / 256)
LBAByte(1) = (tmpV(0) Mod 256)
tmpV(1) = Int(tmpV(0) / 256)
LBAByte(2) = (tmpV(1) Mod 256)
tmpV(2) = Int((tmpV(1) / 256))
LBAByte(3) = (tmpV(2) Mod 256)

CBW(17) = LBAByte(3)         '00
CBW(18) = LBAByte(2)         '00
CBW(19) = LBAByte(1)         '00
CBW(20) = LBAByte(0)         '40

'/////////////  Reverve
CBW(21) = 0

'//////////// Transfer Len

TransferLen = Int(CBWDataTransferLength / 512)

TransferLenLSB = (TransferLen Mod 256)
tmpV(0) = Int(TransferLen / 256)
TransferLenMSB = (tmpV(0) / 256)

CBW(22) = TransferLenMSB      '00
CBW(23) = TransferLenLSB      '04

For i = 24 To 30
    CBW(i) = 0
Next

'\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
 
Dim result As Long

'1. CBW command

 
result = WriteFile _
       (WriteHandle, _
       CBW(0), _
       31, _
       NumberOfBytesWritten, _
       0)    'out

 

'2. Readdata stage
 
result = ReadFile _
         (ReadHandle, _
          ReadData(0), _
         CBWDataTransferLength, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in

 
 

'3. CSW data
 result = ReadFile _
         (ReadHandle, _
          CSW(0), _
          13, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in
 
 
'4. CSW status

If CSW(12) = 1 Then
    Read_DataAU9331 = 1
Else
     Read_DataAU9331 = 0
   
End If

 
End Function
Function OpenPipe9369() As Byte
Dim WritePathName As String
Dim ReadPathName As String

OpenPipe9369 = 0
'WritePathName = Left(DevicePathName, Len(DevicePathName) - 2) & "\PIPE0"   '
WritePathName = DevicePathName
'Debug.Print Lba
'Debug.Print "WritePathName="; WritePathName
WriteHandle9369 = CreateFile _
             (WritePathName, _
            GENERIC_READ Or GENERIC_WRITE, _
            (FILE_SHARE_READ Or FILE_SHARE_WRITE), _
             Security, _
             OPEN_EXISTING, _
             0&, _
            0)
'Debug.Print "write handle"; WriteHandle
If WriteHandle9369 = 0 Then
  OpenPipe9369 = 0
  Exit Function
End If
OpenPipe9369 = 1
End Function
Function ClosePipe9369() As Integer
On Error Resume Next
 
CloseHandle (WriteHandle9369)


End Function

Sub AU6254TestOld1(rv0 As Byte, rv1 As Byte, rv2 As Byte, rv3 As Byte, rv4 As Byte)
 On Error Resume Next
 Dim TestCounter As Integer
 Dim TimeInterval
 Dim HubEmuCounter As Integer
 Dim ContinueRun As Integer
 Dim PwrTime As Single
 
 ContinueRun = 1
 PwrTime = 0.7
 
 
 txtmsg.Text = ""
              
                If PCI7248InitFinish = 0 Then
                  PCI7248ExistAU6254
                End If
                          
               '====================================
               '            Hub exist test3
               ' ====================================
               '****************************
                'For HubEmuCounter = 1 To 5
               '****************************
                 
                  CardResult = DO_WritePort(card, Channel_P1A, &HFF)
                  Print "1"
                  Call MsecDelay(0.5)
                  Cls
                  Print "2"
                  CardResult = DO_WritePort(card, Channel_P1A, &H1E)
                  Call MsecDelay(0.5) ' Hub Power on
                  If CardResult <> 0 Then
                      MsgBox "Power on fail"
                      End
                  End If
                  ReaderExist = 0
                  rv0 = 0
                  OldTimer = Timer
                  Cls
                  Print "3"
                  Do
                      Call MsecDelay(0.2)
                      DoEvents
                      rv0 = AU6254_GetDevice(0, 1, "6254")
                      TimeInterval = Timer - OldTimer
                  Loop While rv0 = 0 And TimeInterval < 5
                 
                  Print "rv0 ="; rv0; "TimeInterval="; TimeInterval
                  
                 '****************************
              '  Next HubEmuCounter
              '  MsgBox "Ok"
              '  Exit Sub
                '****************************
                
                If rv0 <> 1 Then 'Hub unknow
                     rv1 = 4
                     rv2 = 4
                     rv3 = 4
                     rv4 = 4
                     If ContinueRun = 0 Then
                        Exit Sub
                     End If
                End If
        
                Print "rv0="; rv0; "--- Hub Exist"
    
                '==========================  Hub Detect
                '1. usb 2.0 reader
                '2. usb 1.0 flash
                '3, usb 6610
                '4. usb keyboard
        
               '======== PWR ctrl
                CardResult = DO_WritePort(card, Channel_P1A, &H1C)
                Call MsecDelay(PwrTime)
                CardResult = DO_WritePort(card, Channel_P1A, &H18)
                Call MsecDelay(PwrTime)
                CardResult = DO_WritePort(card, Channel_P1A, &H10)
                Call MsecDelay(PwrTime)
                CardResult = DO_WritePort(card, Channel_P1A, &H0)
                Call MsecDelay(PwrTime)
                
                '===== 6335 test usb 2.0 speed
                HubPort = 0
                ReaderExist = 0
                rv1 = 0
                ClosePipe
                    'rv1 = AU6610Test
                rv1 = CBWTest_New_AU9254(0, 1, "6335")
                ClosePipe
 
                 
               Print "rv1="; rv1; "--- 2.0 speed and isochrous pipe test"
              
                '****************************
              '  Next HubEmuCounter
              '  MsgBox "Ok"
              '  Exit Sub
                '****************************
                
               If rv1 <> 1 Then
                   
                    rv2 = 4
                    rv3 = 4
                    rv4 = 4
                    If ContinueRun = 0 Then
                        Exit Sub
                    End If
                End If
                
                 Print "rv1="; rv1; "--- 2.0 speed and isochrous pipe test"
                 
                 
               '=================================
               '   test usb 1.1 flash
               '================================
            
                LBA = LBA + 1
                ReaderExist = 0
                ClosePipe6331
                  rv2 = CBWTest_New6331(0, 1, "6331")
                ClosePipe6331
           
                Print "rv2="; rv2; "--- 2.0 speed and Bulk r/w"
                Print " UsbSpeedTestResult="; UsbSpeedTestResult; "---usb speed error r/w"
                
                
                If rv2 <> 1 Then
                
                   If rv2 = 0 Then
                   rv2 = 2
                   End If
             
                   rv3 = 4
                   rv4 = 4
                   If ContinueRun = 0 Then
                        Exit Sub
                    End If
                End If
                 
                
               '=================================
               '   test 6610 for isochrous pipe
               '================================
               
               
                CardResult = DO_WritePort(card, Channel_P1A, &H0)     ' usb 2.0 falsh
               
                Call MsecDelay(1)
               
                HubPort = 1
                ReaderExist = 0
                ClosePipe
                rv3 = CBWTest_New_AU9254(0, 1, "9369")
                ClosePipe
             
             
                Print "rv3="; rv3; "--- 1.1 speed and isochrorous r/w"
               
               
                 CardResult = DO_ReadPort(card, Channel_P1B, LightON)
                 If rv3 <> 1 Then
                        If rv3 = 0 Then
                          rv3 = 2
                        End If
                    
                       
                      rv4 = 4
                    If ContinueRun = 0 Then
                        Exit Sub
                    End If
                     
                  Else
                  
                     ' If LightON <> 243 Then
                     '     rv3 = 2
                      '   End If
                  
                     
                  End If
                
                
                 
                
                
                
               '=================================
               '   test usb 1.1 key board
               '================================
              
                 txtmsg.Text = ""
                 txtmsg.SetFocus
                 
                 HubPort = 2
                 ReaderExist = 0
                 ClosePipe
                   rv4 = CBWTest_New_AU9254(0, 1, "9462")
                 ClosePipe
                
                ' ReaderExist = 0
                ' ClosePipe
                '   rv4 = CBWTest_New_AU9254(0, 1, "9462")
                ' ClosePipe
        
                  '  CardResult = DO_WritePort(card, Channel_P1A, &HE)    ' usb 2.0 falsh
                
              '  Call MsecDelay(4)
                
                ' keybaord control
                 '  CardResult = DO_ReadPort(card, Channel_P1B, LightON)
                 '  Call MsecDelay(0.1)
                '   CardResult = DO_WritePort(card, Channel_P1CH, &H0)
                 '   Call MsecDelay(0.3)
                 
                 ' CardResult = DO_WritePort(card, Channel_P1CH, &H1)
                  '    Call MsecDelay(1.2)
                
                 
                    
                 ' CardResult = DO_WritePort(card, Channel_P1CH, &H0)
                 '   Call MsecDelay(0.2)
                  'CardResult = DO_WritePort(card, Channel_P1A, &HFF)   ' close power
                   
                 ' Print " LightON="; LightON
                  
                  
                   
                   
                   
               '    If InStr(txtmsg.Text, "..") <> 0 Then
                  
                '      rv4 = 1
                    
                '      If LightON = 238 Then
                '      rv4 = 1
                     
                 '    Else
                 '     Print "GPO Fail"
                     
                  '   End If
                     
               '  Else
               '    Print "Keyboard fail"
                    
                 
               '  End If
               
                  
                  If rv4 <> 1 Then
                      rv4 = 2
                   End If
                   Print "rv4="; rv4; "--- 12 MHZ speed and interrupt  r/w"
                
                
                    
                 If rv0 = 1 Or rv1 = 1 Or rv2 = 1 Or rv3 = 1 Or rv4 = 1 Then
                  
                    If rv0 <> 1 Then
                     ReaderExist = 0
                     rv0 = AU6254_GetDevice(0, 1, "6254")
                    End If
                    
                  If rv1 <> 1 Then
                  
                    HubPort = 0
                    ReaderExist = 0
                    ClosePipe
                    'rv1 = AU6610Test
                    rv1 = CBWTest_New_AU9254(0, 1, "6335")
                    ClosePipe
                    
                  End If
                  
                  
                  If rv2 <> 1 Then
                     ReaderExist = 0
                    ClosePipe6331
                    rv2 = CBWTest_New6331(0, 1, "6331")
                    ClosePipe6331
                  End If
                  
                  If rv3 <> 1 Then
                    HubPort = 1
                    ReaderExist = 0
                    ClosePipe
                    rv3 = CBWTest_New_AU9254(0, 1, "9369")
                    ClosePipe
                  End If
                  
                  If rv4 <> 1 Then
                  
                     HubPort = 2
                     ReaderExist = 0
                     ClosePipe
                     rv4 = CBWTest_New_AU9254(0, 1, "9462")
                     ClosePipe
        
                  End If
                 
                Print "RTrv0="; rv0
                Print "RTrv1="; rv1
                Print "RTrv2="; rv2
                Print "RTrv3="; rv3
                Print "RTrv4="; rv4

                
             End If
             
             
            '========== binning
             If rv0 = 0 Then   ' hub unknow  ,bin2
               rv1 = 4
               rv2 = 4
               rv3 = 4
               rv4 = 4
               Exit Sub
          End If
                
                
               If rv0 = 1 Then   ' hub unknow  , bin3
                 If rv1 = 0 Then  ' hub speed
                   rv1 = 2
                   rv2 = 4
                   rv3 = 4
                   rv4 = 4
                End If
                
                If rv1 * rv2 * rv3 * rv4 = 0 Then  ' bin4 down stream port unknow device
                    
                     If rv1 = 0 Then
                       PortFail = "port1 unknow device"
                    End If
                    
                       If rv2 = 0 Then
                       PortFail = "port2 unknow device"
                    End If
                    
                       If rv3 = 0 Then
                       PortFail = "port3 unknow device"
                    End If
                    
                       If rv4 = 0 Then
                       PortFail = "port4 unknow device"
                    End If
                      
                      
                    
                    rv1 = 1
                    rv2 = 1
                    rv3 = 2
                    rv4 = 4
                    
                  
                    
                    Exit Sub
                End If
                
                
                If rv2 = 2 Or rv4 = 2 Then ' bin5 down stream port unknow device
                    rv1 = 1
                    rv2 = 1
                    rv3 = 1
                    rv4 = 2
                End If
                
                Exit Sub
            End If
            
                


 End Sub

Function CBWTest_New9369(Lun As Byte, PreSlotStatus As Byte, Vid_PID As String) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim TmpString As String
Dim TmpInteger As Integer
Dim TimerCounter As Integer
Dim OldTimer
Dim CBWDataTransferLength As Long

   CBWDataTransferLength = 1024
 
'   For i = 0 To CBWDataTransferLength - 1
    
'         ReadData(i) = 0

'   Next

    If PreSlotStatus <> 1 Then
        CBWTest_New9369 = 4
        Exit Function
    End If
    '========================================
   
    CBWTest_New9369 = 0
    If LBA > 25 * 1024 Then
        LBA = 0
    End If
    '========================================
     TmpString = ""
    If ReaderExist = 0 Then
        Do
            DoEvents
            Call MsecDelay(0.1)
            TimerCounter = TimerCounter + 1
            TmpString = GetDeviceNameMulti9369(Vid_PID)
        Loop While TmpString = "" And TimerCounter < 10
    End If
    '=======================================
    If ReaderExist = 0 And TmpString <> "" Then
      ReaderExist = 1
    End If
    '=======================================
    If ReaderExist = 0 And TmpString = "" Then
      CBWTest_New9369 = 0   ' no readerExist
      ReaderExist = 0
      Exit Function
    End If
    '=======================================
    If OpenPipe9369 = 0 Then
      CBWTest_New9369 = 2   ' Write fail
      Exit Function
    End If
    Print DevicePathName
    '======================================
    
     ' for unitSpeed
    Dim Ret As Integer
    
    Ret = fnScsi2usb_TestUnitReady(WriteHandle9369)
    Ret = fnScsi2usb_TestUnitReady(WriteHandle9369)
    Ret = fnScsi2usb_Write(WriteHandle9369, 1, LBA, Pattern(0))
    Ret = fnScsi2usb_Read(WriteHandle9369, 1, LBA)
    
    Receive_DataBuffer
    
    Dim i2 As Integer
    
    For i2 = 1 To 500
        If Pattern(i2) <> ReceiveDataBuffer(i2 + 1) Then
        CBWTest_New9369 = 2
        Exit Function
        End If
    Next i2
    
     CBWTest_New9369 = 1
   
  End Function
Sub AU9331Test(rv0 As Byte, rv1 As Byte, rv2 As Byte, rv3 As Byte, rv4 As Byte)
 On Error Resume Next
 
             If PCI7248InitFinish = 0 Then
                  PCI7248Exist
              End If
              
            ' result = DIO_PortConfig(card, Channel_P1B, OUTPUT_PORT)
            ' CardResult = DO_WritePort(card, Channel_P1B, &H0)   ' 0111 1111
            
            CardResult = DO_WritePort(card, Channel_P1A, &H1)   ' 0111 1111
           
                 
             Call MsecDelay(0.2)
            ' CardResult = DO_WritePort(card, Channel_P1B, &H2)   ' 0111 1111
             CardResult = DO_WritePort(card, Channel_P1A, &H2)   ' 0111 1111
                  
                 
             Call MsecDelay(1.2)
             
            
              LBA = LBA + 1
                
                
                '//////////////////////////////////////////////////
                '
                '   no card insert
                '
                '/////////////////////////////////////////////////
                
                
                Print LBA
                
                ClosePipe
                 rv0 = CBWTest_New_no_card(0, 1, "vid_058f")
                ClosePipe
                Call LabelMenu(0, rv0, 1)
                
              
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv1 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                 ElseIf rv3 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv0 = PASS Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                  
                End If
                
                Print "Test Result"; TestResult
                       
       
                 
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 card change bit fail"
            
                 
                If TestResult = "PASS" Then
                  
                '   result = DIO_PortConfig(card, Channel_P1B, INPUT_PORT)
                '  CardResult = DO_WritePort(card, Channel_P1B, &H1)   ' 0111 1111
                  
                   CardResult = DO_WritePort(card, Channel_P1A, &H0)  ' 0110 0100
                    
                   Call MsecDelay(0.5)
                 
                 '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                 '
                 '  R/W test
                 '
                 '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                 
                
                'initial return value
                
                
                 
                rv1 = 0
                rv2 = 0
                rv3 = 0
               
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                Call LabelMenu(0, rv0, 1)
                ClosePipe
                 rv1 = CBWTest_NewAU9331(0, 1, "vid_058f")
               
                ClosePipe
                Call LabelMenu(0, rv1, rv0)
                 ' CardResult = DO_ReadPort(card, Channel_P1B, LightOFF)
                '                 If LightOFF <> 192 Then
                '                   UsbSpeedTestResult = GPO_FAIL
                '                  rv1 = 2
                '                 End If
                '   Call LabelMenu(0, rv1, rv0)
                      
     
                
                Print rv1, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                
              
                        
                        If rv0 = UNKNOW Then
                           UnknowDeviceFail = UnknowDeviceFail + 1
                           TestResult = "UNKNOW"
                        ElseIf rv0 = WRITE_FAIL Then
                            SDWriteFail = SDWriteFail + 1
                            TestResult = "SD_WF"
                        ElseIf rv0 = READ_FAIL Then
                            SDReadFail = SDReadFail + 1
                            TestResult = "SD_RF"
                        ElseIf rv1 = WRITE_FAIL Then
                            CFWriteFail = CFWriteFail + 1
                            TestResult = "CF_WF"
                        ElseIf rv1 = READ_FAIL Then
                            CFReadFail = CFReadFail + 1
                            TestResult = "CF_RF"
                        ElseIf rv2 = WRITE_FAIL Then
                            XDWriteFail = XDWriteFail + 1
                            TestResult = "XD_WF"
                        ElseIf rv2 = READ_FAIL Then
                            XDReadFail = XDReadFail + 1
                            TestResult = "XD_RF"
                         ElseIf rv3 = WRITE_FAIL Or rv4 = WRITE_FAIL Then
                            MSWriteFail = MSWriteFail + 1
                            TestResult = "MS_WF"
                        ElseIf rv3 = READ_FAIL Or rv4 = READ_FAIL Then
                            MSReadFail = MSReadFail + 1
                            TestResult = "MS_RF"
                        ElseIf rv1 * rv0 = PASS Then
                             TestResult = "PASS"
                        Else
                            TestResult = "Bin2"
                          
                        End If
                
               
                  
                End If
                CardResult = DO_WritePort(card, Channel_P1A, &HFF)
     
   


 End Sub

Sub AU6254Test(rv0 As Byte, rv1 As Byte, rv2 As Byte, rv3 As Byte, rv4 As Byte)
 On Error Resume Next
 Dim TestCounter As Integer
 Dim TimeInterval
 Dim HubEmuCounter As Integer
 Dim ContinueRun As Integer
 Dim PwrTime As Single
 Dim Au6254Speed As Integer
 
 ContinueRun = 1
 PwrTime = 0.8
 
 
 txtmsg.Text = ""
              
                If PCI7248InitFinish = 0 Then
                  PCI7248ExistAU6254
                End If
                          
               '====================================
               '            Hub exist test3
               ' ====================================
               '****************************
                'For HubEmuCounter = 1 To 5
               '****************************
                    WinExec "off.exe", 0
                    CardResult = DO_WritePort(card, Channel_P1CL, &H4)
                '  CardResult = DO_WritePort(card, Channel_P1A, &HFF)
                 ' Print "1"
                  Call MsecDelay(0.3) ' system let hub driver unload time
               
                  '============= dETECT FOR Disconnect fail
                   
                '  rv0 = AU6254_GetDevice(0, 1, "6254")
                '  If rv0 = 1 Then
                '     MsgBox " Chip Disconnect fail, wait for shutdown"
                     
                '      Do
                '      DoEvents
                '      Loop While (1)
                '  End If
                  
                  Cls
                  Print "2"
                    WinExec "on.exe", 0
                  CardResult = DO_WritePort(card, Channel_P1A, &H1E)
                  Call MsecDelay(3) ' Hub Power on
                  If CardResult <> 0 Then
                      MsgBox "Power on fail"
                      End
                  End If
                  ReaderExist = 0
                  rv0 = 0
                  OldTimer = Timer
                  Cls
                  Print "3"
                  Do
                      Call MsecDelay(0.2)
                      DoEvents
                      rv0 = AU6254_GetDevice(0, 1, "6254")
                      TimeInterval = Timer - OldTimer
                  Loop While rv0 = 0 And TimeInterval < 5
                 
                  Print "rv0 ="; rv0; "TimeInterval="; TimeInterval
                  
                 '****************************
              '  Next HubEmuCounter
              '  MsgBox "Ok"
              '  Exit Sub
                '****************************
                
                If rv0 <> 1 Then 'Hub unknow
                     rv1 = 4
                     rv2 = 4
                     rv3 = 4
                     rv4 = 4
                     If ContinueRun = 0 Then
                        Exit Sub
                     End If
                End If
        
                Print "rv0="; rv0; "--- Hub Exist"
    
                '==========================  Hub Detect
                '1. usb 2.0 reader
                '2. usb 1.0 flash
                '3, usb 6610
                '4. usb keyboard
        
               '======== PWR ctrl
                CardResult = DO_WritePort(card, Channel_P1A, &H1C)
                Call MsecDelay(PwrTime)
                CardResult = DO_WritePort(card, Channel_P1A, &H18)
                Call MsecDelay(PwrTime)
                CardResult = DO_WritePort(card, Channel_P1A, &H10)
                Call MsecDelay(PwrTime)
                CardResult = DO_WritePort(card, Channel_P1A, &H0)
                Call MsecDelay(PwrTime)
                
                '===== 6335 test usb 2.0 speed
                HubPort = 0
                ReaderExist = 0
                rv1 = 0
                ClosePipe
                    'rv1 = AU6610Test
                rv1 = CBWTest_New_AU9254(0, 1, "6335")
                ClosePipe
                Au6254Speed = UsbSpeedTestResult
                 
               Print "rv1="; rv1; "--- 2.0 speed and isochrous pipe test"
              
                '****************************
              '  Next HubEmuCounter
              '  MsgBox "Ok"
              '  Exit Sub
                '****************************
                
               If rv1 <> 1 Then
                   
                    rv2 = 4
                    rv3 = 4
                    rv4 = 4
                    If ContinueRun = 0 Then
                        Exit Sub
                    End If
                End If
                
                 Print "rv1="; rv1; "--- 2.0 speed and isochrous pipe test"
                 
                 
               '=================================
               '   test usb 1.1 flash
               '================================
                HubPort = 3
                LBA = LBA + 1
                ReaderExist = 0
                ClosePipe
                  rv2 = CBWTest_New_AU9254(0, 1, "1758")
                ClosePipe
           
                Print "rv2="; rv2; "--- 2.0 speed and Bulk r/w"
                Print " UsbSpeedTestResult="; UsbSpeedTestResult; "---usb speed error r/w"
                
                
                If rv2 <> 1 Then
                
                   
             
                   rv3 = 4
                   rv4 = 4
                   If ContinueRun = 0 Then
                        Exit Sub
                    End If
                End If
                 
                
               '=================================
               '   test 6610 for isochrous pipe
               '================================
               
               
              
               
               
                HubPort = 1
                ReaderExist = 0
                ClosePipe
                rv3 = CBWTest_New_AU9254(0, 1, "9369")
                ClosePipe
              
             
             
                Print "rv3="; rv3; "--- 1.1 speed and isochrorous r/w"
               
               
                 CardResult = DO_ReadPort(card, Channel_P1B, LightON)
                 If rv3 <> 1 Then
                        
                    
                       
                      rv4 = 4
                    If ContinueRun = 0 Then
                        Exit Sub
                    End If
                     
                  Else
                  
                     ' If LightON <> 243 Then
                     '     rv3 = 2
                      '   End If
                  
                     
                  End If
                
                
                 
                
                
                
               '=================================
               '   test usb 1.1 key board
               '================================
                  Call MsecDelay(1)
                 txtmsg.Text = ""
                 txtmsg.SetFocus
                 
                 HubPort = 2
                 ReaderExist = 0
                 ClosePipe
                   rv4 = CBWTest_New_AU9254(0, 1, "9462")
                 ClosePipe
                
                ' ReaderExist = 0
                ' ClosePipe
                '   rv4 = CBWTest_New_AU9254(0, 1, "9462")
                ' ClosePipe
        
                  '  CardResult = DO_WritePort(card, Channel_P1A, &HE)    ' usb 2.0 falsh
                
              '  Call MsecDelay(4)
                
                ' keybaord control
                 '  CardResult = DO_ReadPort(card, Channel_P1B, LightON)
                 '  Call MsecDelay(0.1)
                '   CardResult = DO_WritePort(card, Channel_P1CH, &H0)
                 '   Call MsecDelay(0.3)
                 
                 ' CardResult = DO_WritePort(card, Channel_P1CH, &H1)
                  '    Call MsecDelay(1.2)
                
                 
                    
                 ' CardResult = DO_WritePort(card, Channel_P1CH, &H0)
                 '   Call MsecDelay(0.2)
                  'CardResult = DO_WritePort(card, Channel_P1A, &HFF)   ' close power
                   
                 ' Print " LightON="; LightON
                  
                  
                   
                   
                   
               '    If InStr(txtmsg.Text, "..") <> 0 Then
                  
                '      rv4 = 1
                    
                '      If LightON = 238 Then
                '      rv4 = 1
                     
                 '    Else
                 '     Print "GPO Fail"
                     
                  '   End If
                     
               '  Else
               '    Print "Keyboard fail"
                    
                 
               '  End If
               
                  
                  'If rv4 <> 1 Then
                  '    rv4 = 2
                  ' End If
                   Print "rv4="; rv4; "--- 12 MHZ speed and interrupt  r/w"
                
                
                    
                 If rv0 = 1 Or rv1 = 1 Or rv2 = 1 Or rv3 = 1 Or rv4 = 1 Then
                 
                 
                    If rv0 * rv1 * rv2 * rv3 * rv4 = 1 Then
                      Rv1ContinueFail = 0
                    End If
                    
                  
                    If rv0 <> 1 Then
                    'Rv1ContinueFail = 0
                     ReaderExist = 0
                     rv0 = AU6254_GetDevice(0, 1, "6254")
                    End If
                    
                  If rv1 <> 1 Then
                  
                  
                   
                  
                  
                
                    HubPort = 0
                    ReaderExist = 0
                    ClosePipe
                    'rv1 = AU6610Test
                    rv1 = CBWTest_New_AU9254(0, 1, "6335")
                    ClosePipe
                     Au6254Speed = UsbSpeedTestResult
                     
                    
                   
                   
                     
                     
                  End If
                  
                  
                  If rv2 <> 1 Then
                    ' Rv1ContinueFail = 0
                     HubPort = 3
                     ReaderExist = 0
                    ClosePipe
                    rv2 = CBWTest_New_AU9254(0, 1, "6331")
                    ClosePipe
                  End If
                  
                  If rv3 <> 1 Then
                    'Rv1ContinueFail = 0
                    HubPort = 1
                    ReaderExist = 0
                      ClosePipe
                     rv3 = CBWTest_New_AU9254(0, 1, "9369")
                    ClosePipe
              
                  End If
                  
                  If rv4 <> 1 Then
                   '  Rv1ContinueFail = 0
                     HubPort = 2
                     ReaderExist = 0
                     ClosePipe
                     rv4 = CBWTest_New_AU9254(0, 1, "9462")
                     ClosePipe
        
                  End If
                  
                  
                    If rv1 + rv2 + rv3 + rv4 = 0 Then
                     
                      Rv1ContinueFail = Rv1ContinueFail + 1
                     End If
                      
                     
                     
                    If Rv1ContinueFail > 1 Then  ' use another AU6335 plug into to solve the hub hang probelm
                    CardResult = DO_WritePort(card, Channel_P1CL, &H0)
                    Call MsecDelay(2.5)
                    CardResult = DO_WritePort(card, Channel_P1CL, &H4)
                    Call MsecDelay(2)
                   End If
                 
                Print "RTrv0="; rv0
                Print "RTrv1="; rv1
                Print "RTrv2="; rv2
                Print "RTrv3="; rv3
                Print "RTrv4="; rv4

                
             End If
             
             
            '========== binning
             If rv0 = 0 Then   ' hub unknow  ,bin2
               rv1 = 4
               rv2 = 4
               rv3 = 4
               rv4 = 4
               Exit Sub
          End If
                
                
               If rv0 = 1 Then   ' hub unknow  , bin3
                 If rv1 = 0 Or Au6254Speed = 2 Then    ' hub speed
                   rv1 = 2
                   rv2 = 4
                   rv3 = 4
                   rv4 = 4
                   Exit Sub
                End If
                
                If rv1 * rv2 * rv3 * rv4 = 0 Then  ' bin4 down stream port unknow device
                    
                     If rv1 = 0 Then
                       PortFail = "port1 unknow device"
                    End If
                    
                       If rv2 = 0 Then
                       PortFail = "port2 unknow device"
                    End If
                    
                       If rv3 = 0 Then
                       PortFail = "port3 unknow device"
                    End If
                    
                       If rv4 = 0 Then
                       PortFail = "port4 unknow device"
                    End If
                      
                      
                    
                    rv1 = 1
                    rv2 = 1
                    rv3 = 2
                    rv4 = 4
                    
                  
                    
                    Exit Sub
                End If
                
                
                If rv2 >= 2 Or rv3 >= 2 Then ' bin5 down stream port unknow device
                    rv1 = 1
                    rv2 = 1
                    rv3 = 1
                    rv4 = 2
                End If
                
                Exit Sub
            End If
            
                


 End Sub
Function OpenPipe6331() As Byte
Dim WritePathName As String
Dim ReadPathName As String

OpenPipe6331 = 0
'WritePathName = Left(DevicePathName, Len(DevicePathName) - 2) & "\PIPE0"   '
WritePathName = DevicePathName
'Debug.Print Lba
'Debug.Print "WritePathName="; WritePathName
WriteHandle6331 = CreateFile _
             (WritePathName, _
            GENERIC_READ Or GENERIC_WRITE, _
            (FILE_SHARE_READ Or FILE_SHARE_WRITE), _
             Security, _
             OPEN_EXISTING, _
             0&, _
            0)
'Debug.Print "write handle"; WriteHandle
If WriteHandle6331 = 0 Then
  OpenPipe6331 = 0
  Exit Function
End If
OpenPipe6331 = 1
End Function

Function CBWTest_New6331(Lun As Byte, PreSlotStatus As Byte, Vid_PID As String) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim TmpString As String
Dim TmpInteger As Integer
Dim TimerCounter As Integer
Dim OldTimer
Dim CBWDataTransferLength As Long

   CBWDataTransferLength = 1024
 
'   For i = 0 To CBWDataTransferLength - 1
    
'         ReadData(i) = 0

'   Next

    If PreSlotStatus <> 1 Then
        CBWTest_New6331 = 4
        Exit Function
    End If
    '========================================
   
    CBWTest_New6331 = 0
    If LBA > 25 * 1024 Then
        LBA = 0
    End If
    '========================================
     TmpString = ""
    If ReaderExist = 0 Then
        Do
            DoEvents
            Call MsecDelay(0.1)
            TimerCounter = TimerCounter + 1
            TmpString = GetDeviceNameMulti6331(Vid_PID)
        Loop While TmpString = "" And TimerCounter < 10
    End If
    '=======================================
    If ReaderExist = 0 And TmpString <> "" Then
      ReaderExist = 1
    End If
    '=======================================
    If ReaderExist = 0 And TmpString = "" Then
      CBWTest_New6331 = 0   ' no readerExist
      ReaderExist = 0
      Exit Function
    End If
    '=======================================
    If OpenPipe6331 = 0 Then
      CBWTest_New6331 = 2   ' Write fail
      Exit Function
    End If
    Print DevicePathName
    '======================================
    
     ' for unitSpeed
    Dim Ret As Integer
    
    Ret = fnScsi2usb_TestUnitReady(WriteHandle6331)
    Ret = fnScsi2usb_TestUnitReady(WriteHandle6331)
    Ret = fnScsi2usb_Write(WriteHandle6331, 1, LBA, Pattern(0))
    Ret = fnScsi2usb_Read(WriteHandle6331, 1, LBA)
    
    Receive_DataBuffer
    
    Dim i2 As Integer
    
    For i2 = 1 To 500
        If Pattern(i2) <> ReceiveDataBuffer(i2 + 1) Then
        CBWTest_New6331 = 2
        Exit Function
        End If
    Next i2
    
     CBWTest_New6331 = 1
   
  End Function

 
 
Function CBWTest_New_AU6371(Lun As Byte, PreSlotStatus As Byte, Vid_PID As String) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim TmpString As String
Dim TmpInteger As Integer
Dim TimerCounter As Integer
Dim OldTimer
Dim CBWDataTransferLength As Long

   CBWDataTransferLength = 1024
 
'   For i = 0 To CBWDataTransferLength - 1
    
'         ReadData(i) = 0

'   Next

    If PreSlotStatus <> 1 Then
        CBWTest_New_AU6371 = 4
        Exit Function
    End If
    '========================================
   
    CBWTest_New_AU6371 = 0
    If LBA > 25 * 1024 Then
        LBA = 0
    End If
    '========================================
     TmpString = ""
    If ReaderExist = 0 Then
        Do
            DoEvents
            Call MsecDelay(0.1)
            TimerCounter = TimerCounter + 1
            TmpString = GetDeviceName(Vid_PID)
        Loop While TmpString = "" And TimerCounter < 10
    End If
    '=======================================
    If ReaderExist = 0 And TmpString <> "" Then
      ReaderExist = 1
    End If
    '=======================================
    If ReaderExist = 0 And TmpString = "" Then
      CBWTest_New_AU6371 = 0   ' no readerExist
      ReaderExist = 0
      Exit Function
    End If
    '=======================================
    If OpenPipe = 0 Then
      CBWTest_New_AU6371 = 2   ' Write fail
      Exit Function
    End If
 
    '======================================
    
     ' for unitSpeed
    
    TmpInteger = TestUnitSpeed(Lun)
    
    If TmpInteger = 0 Then
        
       CBWTest_New_AU6371 = 2   ' usb 2.0 high speed fail
       UsbSpeedTestResult = 2
       Exit Function
    End If
    
    
    
    TmpInteger = TestUnitReady(Lun)
    If TmpInteger = 0 Then
        TmpInteger = RequestSense(Lun)
        
        If TmpInteger = 0 Then
        
           CBWTest_New_AU6371 = 2  'Write fail
           Exit Function
        End If
        
    End If
    '======================================
    TmpInteger = Read_Data1(LBA, Lun, CBWDataTransferLength)
    
   ' TmpInteger = Read_Data1(Lba, Lun, CBWDataTransferLength)
    TmpInteger = Read_Data(LBA, Lun, CBWDataTransferLength)
      
    If TmpInteger = 0 Then
         CBWTest_New_AU6371 = 2  'write fail
          Exit Function
     End If
    
      
    TmpInteger = Write_Data(LBA, Lun, CBWDataTransferLength)
     
    If TmpInteger = 0 Then
        CBWTest_New_AU6371 = 2  'write fail
        Exit Function
    End If
    
    TmpInteger = Read_Data(LBA, Lun, CBWDataTransferLength)
     
    If TmpInteger = 0 Then
        CBWTest_New_AU6371 = 3    'Read fail
        Exit Function
    End If
     
    For i = 0 To CBWDataTransferLength - 1
    
        If ReadData(i) <> Pattern(i) Then
          CBWTest_New_AU6371 = 3    'Read fail
          Exit Function
        End If
    
    Next
    
    CBWTest_New_AU6371 = 1
        
    
    End Function
 
 Sub AU6254TestOld(rv0 As Byte, rv1 As Byte, rv2 As Byte, rv3 As Byte, rv4 As Byte)
 

   
              
                If PCI7248InitFinish = 0 Then
                  PCI7248ExistAU6254
                End If
                          
               '====================================
               '            Hub exist test
               ' ====================================
                CardResult = DO_WritePort(card, Channel_P1A, &H1E)   ' Hub Power on
                If CardResult <> 0 Then
                    MsgBox "Power on fail"
                    End
                End If
                ReaderExist = 0
                HubPort = 0
                Call MsecDelay(2.8)    'power on time
                rv0 = AU6254_GetDevice(0, 1, "6254")
                 
                  
                 If rv0 <> 1 Then
                    rv1 = 4
                    rv2 = 4
                    rv3 = 4
                    rv4 = 4
                    Exit Sub
                 End If
        
               
                '==========================  Hub Detect
                '1. usb 2.0 reader
                '2. usb 1.0 flash
                '3, usb 6610
                '4. usb keyboard
                 
                
                 CardResult = DO_WritePort(card, Channel_P1A, &H1C)   ' usb 2.0 falsh
                
                Call MsecDelay(0.8)    'power on time
                 
                If CardResult <> 0 Then
                    MsgBox "Power on fail"
                    End
                End If
                
                
                ' test usb 2.0 speed
                HubPort = 0
                ReaderExist = 0
                ClosePipe
                rv1 = CBWTest_New(0, 1, "9380")
                ClosePipe
                
                
                If rv1 <> 1 Then
                    
                    rv2 = 4
                    rv3 = 4
                    rv4 = 4
                     Exit Sub
                End If
                
                
                
               '=================================
               '   test usb 1.1 flash
               '================================
                
        
                 HubPort = 1
                 ReaderExist = 0
                ClosePipe
               '    rv2 = CBWTest_New(0, 1, "55AA")
                ClosePipe
                
                 rv2 = 1
                If rv2 <> 1 Then
             
                    rv3 = 4
                    rv4 = 4
                    'Exit Sub
                End If
                
                  Print "rv2="; rv2
               '=================================
               '   test 6610 for isochrous pipe
               '================================
                 
                
                CardResult = DO_WritePort(card, Channel_P1A, &H10)   ' usb 6610
                
                Call MsecDelay(0.8)    'power on time
                 
                If CardResult <> 0 Then
                    MsgBox "Power on fail"
                    End
                End If
                
                rv3 = AU6610Test
                Print "rv3="; rv3
                    
               '=================================
               '   test usb 1.1 key board
               '================================
                
                 txtmsg.Text = ""
                 txtmsg.SetFocus
        
                 CardResult = DO_WritePort(card, Channel_P1A, &H0)    ' usb 1.0 keyboard
                
                Call MsecDelay(4)    'power on time
                 
                If CardResult <> 0 Then
                    MsgBox "Power on fail"
                    End
                End If
                
                ' keybaord control
                
                 
                 
                  CardResult = DO_WritePort(card, Channel_P1CH, &H1)
                    Call MsecDelay(0.5)
                
                  CardResult = DO_WritePort(card, Channel_P1CH, &H2)
                    Call MsecDelay(0.5)
                    
                  CardResult = DO_WritePort(card, Channel_P1CH, &H4)
                    Call MsecDelay(0.5)
                    
                  CardResult = DO_WritePort(card, Channel_P1CH, &H8)
                    Call MsecDelay(0.5)
                    
                    
                  CardResult = DO_WritePort(card, Channel_P1A, &HFF)   ' close power
                   
                  Print txtmsg.Text
                  
                  If InStr(txtmsg.Text, "g=") <> "" Then
                    rv4 = 1
                  End If
                  

 End Sub
 Sub AU6254TestLoop(rv0 As Byte, rv1 As Byte, rv2 As Byte, rv3 As Byte, rv4 As Byte)
 On Error Resume Next
 Dim TestCounter As Integer
 Dim TimeInterval
 Dim HubEmuCounter As Integer
 txtmsg.Text = ""
              
                If PCI7248InitFinish = 0 Then
                  PCI7248ExistAU6254
                End If
                          
               '====================================
               '            Hub exist test3
               ' ====================================
               For HubEmuCounter = 1 To 10
                 
                  CardResult = DO_WritePort(card, Channel_P1A, &HFF)
                  Call MsecDelay(4)
                  CardResult = DO_WritePort(card, Channel_P1A, &H1E)
                  Call MsecDelay(0.5) ' Hub Power on
                  If CardResult <> 0 Then
                      MsgBox "Power on fail"
                      End
                  End If
                  ReaderExist = 0
                  OldTimer = Timer
                   rv0 = 0
                  Do
                      Call MsecDelay(0.2)
                      DoEvents
                      rv0 = AU6254_GetDevice(0, 1, "6254")
                      TimeInterval = Timer - OldTimer
                  Loop While rv0 = 0 And TimeInterval < 15
                 
                  Print "rv0 ="; rv0; "TimeInterval="; TimeInterval
                Next HubEmuCounter
                
                MsgBox "Ok"
                Exit Sub
                  If rv0 <> 1 Then
                     rv1 = 4
                     rv2 = 4
                     rv3 = 4
                     rv4 = 4
                    ' Exit Sub
                  End If
        
                 Print "rv0="; rv0; "--- Hub Exist"
             
                 
                
                '==========================  Hub Detect
                '1. usb 2.0 reader
                '2. usb 1.0 flash
                '3, usb 6610
                '4. usb keyboard
        
                
                ' test usb 2.0 speed
                 HubPort = 0
                 
                ReaderExist = 0
                
                
                
                ClosePipe
                    'rv1 = AU6610Test
                   rv1 = CBWTest_New_AU9254(0, 1, "6335")
                  
                ClosePipe
                 
                
                
                 
                 Print "rv1="; rv1; "--- 2.0 speed and isochrous pipe test"
                If rv1 <> 1 Then
                    If rv1 = 0 Then
                    rv0 = 0
                    rv1 = 4
                    End If
                     
                    rv2 = 4
                    rv3 = 4
                    rv4 = 4
                   '   Exit Sub
                End If
                
                 Print "rv1="; rv1; "--- 2.0 speed and isochrous pipe test"
                 
                 
               '=================================
               '   test usb 1.1 flash
               '================================
                
                 CardResult = DO_WritePort(card, Channel_P1A, &H18)     ' usb 2.0 falsh
               
                Call MsecDelay(2.8)
                
                 LBA = LBA + 1
                ReaderExist = 0
                ClosePipe6331
                 ' rv2 = CBWTest_New_AU9254(0, rv1, "6331")
                 rv2 = CBWTest_New6331(0, 1, "6331")
                ClosePipe6331
                  
                    Dim tp As String
            '   tp = Dir("F:\*.*")
               
            '   If InStr(tp, "6254") <> 0 Then  ' bulk transfer
            '      rv2 = 1
            '   End If
                  
               ' rv2 = 1
                
                Print "rv2="; rv2; "--- 2.0 speed and Bulk r/w"
                Print " UsbSpeedTestResult="; UsbSpeedTestResult; "---usb speed error r/w"
                 Print " file name 0f 6331="; tp; "---usb speed error r/w"
                If rv2 <> 1 Then
                
                   If rv2 = 0 Then
                   rv2 = 2
                   End If
             
                    rv3 = 4
                    rv4 = 4
                    ' Exit Sub
                End If
                 
                
               '=================================
               '   test 6610 for isochrous pipe
               '================================
               
               
                CardResult = DO_WritePort(card, Channel_P1A, &H0)     ' usb 2.0 falsh
               
                Call MsecDelay(1)
               
                 HubPort = 1
                ReaderExist = 0
                ClosePipe
                  rv3 = CBWTest_New_AU9254(0, 1, "9369")
                ClosePipe
             
             
                 Print "rv3="; rv3; "--- 1.1 speed and isochrorous r/w"
               
               
                   CardResult = DO_ReadPort(card, Channel_P1B, LightON)
                 If rv3 <> 1 Then
                        If rv3 = 0 Then
                          rv3 = 2
                        End If
                    
                       
                      rv4 = 4
                   '  Exit Sub
                     
                  Else
                  
                     ' If LightON <> 243 Then
                     '     rv3 = 2
                      '   End If
                  
                     
                End If
                
                
                 
                
                
                
               '=================================
               '   test usb 1.1 key board
               '================================
               ' CardResult = DO_WritePort(card, Channel_P1A, &HE)
               ' Call MsecDelay(3)
               '  rv3 = 1
                 txtmsg.Text = ""
                 txtmsg.SetFocus
                 
                 HubPort = 2
                 ReaderExist = 0
                 ClosePipe
                   rv4 = CBWTest_New_AU9254(0, 1, "9462")
                 ClosePipe
                
                ' ReaderExist = 0
                ' ClosePipe
                '   rv4 = CBWTest_New_AU9254(0, 1, "9462")
                ' ClosePipe
        
                  '  CardResult = DO_WritePort(card, Channel_P1A, &HE)    ' usb 2.0 falsh
                
              '  Call MsecDelay(4)
                
                ' keybaord control
                 '  CardResult = DO_ReadPort(card, Channel_P1B, LightON)
                 '  Call MsecDelay(0.1)
                '   CardResult = DO_WritePort(card, Channel_P1CH, &H0)
                 '   Call MsecDelay(0.3)
                 
                 ' CardResult = DO_WritePort(card, Channel_P1CH, &H1)
                  '    Call MsecDelay(1.2)
                
                 
                    
                 ' CardResult = DO_WritePort(card, Channel_P1CH, &H0)
                 '   Call MsecDelay(0.2)
                  'CardResult = DO_WritePort(card, Channel_P1A, &HFF)   ' close power
                   
                 ' Print " LightON="; LightON
                  
                  
                   
                   
                   
               '    If InStr(txtmsg.Text, "..") <> 0 Then
                  
                '      rv4 = 1
                    
                '      If LightON = 238 Then
                '      rv4 = 1
                     
                 '    Else
                 '     Print "GPO Fail"
                     
                  '   End If
                     
               '  Else
               '    Print "Keyboard fail"
                    
                 
               '  End If
                  
                   
                   
                  
                   
                  
                  If rv4 <> 1 Then
                      rv4 = 2
                  End If
                Print "rv4="; rv4; "--- 12 MHZ speed and interrupt  r/w"
                
                
                    If rv0 = 1 Or rv1 = 1 Or rv2 = 1 Or rv3 = 1 Or rv4 = 1 Then
                  
                  If rv0 <> 1 Then
                   rv0 = AU6254_GetDevice(0, 1, "6254")
                  End If
                  
                  If rv1 <> 1 Then
                  
                    HubPort = 0
                    ReaderExist = 0
                    ClosePipe
                    'rv1 = AU6610Test
                    rv1 = CBWTest_New_AU9254(0, 1, "6335")
                    ClosePipe
                    
                  End If
                  
                  
                  If rv2 <> 1 Then
                    ClosePipe6331
                    rv2 = CBWTest_New6331(0, 1, "6331")
                    ClosePipe6331
                  End If
                  
                  If rv3 <> 1 Then
                    HubPort = 1
                    ReaderExist = 0
                    ClosePipe
                    rv3 = CBWTest_New_AU9254(0, 1, "9369")
                    ClosePipe
                  End If
                  
                  If rv4 <> 1 Then
                  
                     HubPort = 2
                     ReaderExist = 0
                    ClosePipe
                    rv4 = CBWTest_New_AU9254(0, 1, "9462")
                    ClosePipe
        
                  End If
              
             Print "rv0="; rv0
             Print "rv1="; rv1
             Print "rv2="; rv2
             Print "rv3="; rv3
             Print "rv4="; rv4

                
             End If
                


 End Sub
  
 Sub AU6375ASTest(rv0 As Byte, rv1 As Byte, rv2 As Byte)

 
 
                ClosePipe
                If ChipName = "AU6375AS" Then

                rv0 = AU6375_GetDevice(0, 1, "6362")
                End If
                
                
                If ChipName = "AU6371AS" Then

                rv0 = AU6375_GetDevice(0, 1, "6387")
                End If
                
                  If ChipName = "AUHang" Then

                rv0 = AU6375_GetDevice(0, 1, "vid")
                End If
                
                
                ClosePipe
                If rv0 = 1 Then
                    OpenPipe
                    Print "testmode"
                     Print "Old Hang Time="; AU6375ASHangTime; " s"
                     If ChipName <> "AUHang" Then
                      rv1 = AU6375TestMode(0)
                     Else
                      rv1 = 1
                     End If
                     
                    ClosePipe
                    If rv1 = 1 Then
                        OpenPipe
                        Print "Endless"
                        
                        rv2 = AU6375EndLess(0)
                        
                        AU6375ASHangTime = Timer - OldTimer
                        Print "Hang Time="; AU6375ASHangTime; " s"
                        If AU6375ASHangTime > 3 Then
                            rv2 = 1   '============ hang success
                        Else
                            rv2 = 2
                        End If
                        
                        ' for system hang,
                        ' if fail chip, system no hang, host get rv2=2
                        ' if pass chip, system hang, host get nothing
                        
                        ClosePipe
                        Print "Endless over"
                    Else
                        rv1 = 2 ' rv1 fail
                        rv2 = 4

                    End If
          
                     
                Else
                    rv1 = 4  ' rv0 fail
                    rv2 = 4
                     
               End If
               
               
               
               
 End Sub
 
 Sub AU6375ASTestOld(rv0 As Byte, rv1 As Byte, rv2 As Byte)

 
 
                ClosePipe
                If ChipName = "AU6375AS" Then

                rv0 = AU6375_GetDevice(0, 1, "6362")
                End If
                
                
                If ChipName = "AU6371AS" Then

                rv0 = AU6375_GetDevice(0, 1, "6366")
                End If
                
                ClosePipe
                If rv0 = 1 Then
                    OpenPipe
                    Print "testmode"
                     Print "Old Hang Time="; AU6375ASHangTime; " s"
                    rv1 = AU6375TestMode(0)
                    ClosePipe
                    If rv1 = 1 Then
                        OpenPipe
                        Print "Endless"
                        
                        rv2 = AU6375EndLess(0)
                        
                        AU6375ASHangTime = Timer - OldTimer
                        Print "Hang Time="; AU6375ASHangTime; " s"
                        If AU6375ASHangTime > 3 Then
                            rv2 = 1   '============ hang success
                        Else
                            rv2 = 2
                        End If
                        
                        ' for system hang,
                        ' if fail chip, system no hang, host get rv2=2
                        ' if pass chip, system hang, host get nothing
                        
                        ClosePipe
                        Print "Endless over"
                    Else
                        rv1 = 2 ' rv1 fail
                        rv2 = 4

                    End If
          
                     
                Else
                    rv1 = 4  ' rv0 fail
                    rv2 = 4
                     
               End If
               
               
               
               
 End Sub
 
 
Public Function AU6610TestRC() As Integer
On Error Resume Next
AU6610TestRC = Test_RC

End Function
Function AU9520_GetDeviceName(Lun As Byte, PreSlotStatus As Byte, Vid_PID As String) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim TmpString As String
Dim TmpInteger As Integer
Dim TimerCounter As Integer
Dim OldTimer
Dim CBWDataTransferLength As Long

 

TmpString = ""
If ReaderExist = 0 Then
Do
DoEvents
 
               Call MsecDelay(0.1)
               TimerCounter = TimerCounter + 1
              TmpString = GetDeviceName(Vid_PID)
  
Loop While TmpString = "" And TimerCounter < 10
End If
If ReaderExist = 0 And TmpString <> "" Then
  ReaderExist = 1
End If

If ReaderExist = 0 And TmpString = "" Then
  AU9520_GetDeviceName = 0   ' no readerExist
  ReaderExist = 0
  Exit Function
End If
AU9520_GetDeviceName = 1
End Function

 

Function STDHex(VarReadData As Byte) As String
 
STDHex = Trim(CStr(Hex(VarReadData)))
If Len(STDHex) < 2 Then
STDHex = "0" & STDHex
End If




End Function


Function DumpTable_AU6375A31(SectorNo As Byte, CBWDataTransferLength As Long) As Byte
Dim CBW(0 To 30) As Byte
Dim NumberOfBytesWritten As Long
Dim CBWDataTransferLen(0 To 3) As Byte
  
Dim TransferLen As Long
Dim TransferLenLSB As Byte
Dim TransferLenMSB As Byte
Dim i As Integer
Dim tmpV(0 To 2) As Long
Dim opcode As Byte

Dim CSW(0 To 12) As Byte

Dim NumberOfBytesRead As Long

For i = 0 To 30
   
        CBW(i) = 0
    
Next i

For i = 0 To CBWDataTransferLength
ReadData(i) = 0
Next

Const CBWSignature_0 = &H55
Const CBWSignature_1 = &H53
Const CBWSignature_2 = &H42
Const CBWSignature_3 = &H43


Const CBWTag_0 = &H1
Const CBWTag_1 = &H2
Const CBWTag_2 = &H3
Const CBWTag_3 = &H4


'/////////////////// CBW signature

CBW(0) = CBWSignature_0
CBW(1) = CBWSignature_1
CBW(2) = CBWSignature_2
CBW(3) = CBWSignature_3

'/////////////////  CBW Tag

CBW(4) = CBWTag_0
CBW(5) = CBWTag_1
CBW(6) = CBWTag_2
CBW(7) = CBWTag_3

CBWDataTransferLen(0) = (CBWDataTransferLength Mod 256)
tmpV(0) = Int(CBWDataTransferLength / 256)
CBWDataTransferLen(1) = (tmpV(0) Mod 256)
tmpV(1) = Int(tmpV(0) / 256)
CBWDataTransferLen(2) = (tmpV(1) Mod 256)
tmpV(2) = Int((tmpV(1) / 256))
CBWDataTransferLen(3) = (tmpV(2) Mod 256)

CBW(8) = CBWDataTransferLen(0)  '00
CBW(9) = CBWDataTransferLen(1)  '08
CBW(10) = CBWDataTransferLen(2) '00
CBW(11) = CBWDataTransferLen(3) '00

'///////////////  CBW Flag
CBW(12) = &H80                 '80

'////////////// LUN
CBW(13) = 0                   '00

'///////////// CBD Len
CBW(14) = &H8               '0a

'////////////  UFI command

CBW(15) = &HC7
CBW(16) = &H12
 

CBW(17) = 0                 '00
CBW(18) = SectorNo         '00
CBW(19) = 0        '00
CBW(20) = 0         '40

'/////////////  Reverve
CBW(21) = 0

'//////////// Transfer Len

 

CBW(22) = 0    '00
CBW(23) = 0    '04

For i = 24 To 30
    CBW(i) = 0
Next

'\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
 
Dim result As Long

'1. CBW command

 
result = WriteFile _
       (WriteHandle, _
       CBW(0), _
       31, _
       NumberOfBytesWritten, _
       0)    'out

If result = 0 Then
 DumpTable_AU6375A31 = 0
 Exit Function
End If

'2. Readdata stage
 
result = ReadFile _
         (ReadHandle, _
          ReadData(0), _
          CBWDataTransferLength, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in

 
If result = 0 Then
 DumpTable_AU6375A31 = 0
 Exit Function
End If

'3. CSW data
 result = ReadFile _
         (ReadHandle, _
          CSW(0), _
          13, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in
 
If result = 0 Then
 DumpTable_AU6375A31 = 0
 Exit Function
End If
 
'4. CSW status


If CSW(12) = 1 Then
    DumpTable_AU6375A31 = 0
Else
    DumpTable_AU6375A31 = 1
    
    
   
End If

End Function

Function DumpTableTest2(Table As Byte) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim TmpString As String
Dim TmpInteger As Integer
Dim TimerCounter As Integer
Dim OldTimer
Dim CBWDataTransferLength As Long
Dim TmpValue As Byte
Dim TableStr As String
Dim TmpStr As String

   CBWDataTransferLength = 512
 
    For i = 0 To CBWDataTransferLength - 1
    
          ReadData(i) = 0

    Next

   
    '========================================
   
    DumpTableTest2 = 0
    
    '========================================
     TmpString = ""
    If ReaderExist = 0 Then
        Do
            DoEvents
            Call MsecDelay(0.1)
            TimerCounter = TimerCounter + 1
            TmpString = GetDeviceName("058f")
        Loop While TmpString = "" And TimerCounter < 10
    End If
    '=======================================
    If ReaderExist = 0 And TmpString <> "" Then
      ReaderExist = 1
    End If
    '=======================================
    If ReaderExist = 0 And TmpString = "" Then
      DumpTableTest2 = 0   ' no readerExist
      ReaderExist = 0
      Exit Function
    End If
    '=======================================
    If OpenPipe = 0 Then
      DumpTableTest2 = 2   ' Write fail
      Exit Function
    End If
  
     '======================================
    TmpInteger = TestUnitReady(2)   ' XD slot
    If TmpInteger = 0 Then
        TmpInteger = RequestSense(2)
        
        If TmpInteger = 0 Then
        
           DumpTableTest2 = 2  'Write fail
           Exit Function
        End If
        
    End If
    
    TmpInteger = Read_Data(2, 2, CBWDataTransferLength)
  '  TmpInteger = Read_Data(2, 2, CBWDataTransferLength) ' for card chanage error
    If TmpInteger = 0 Then
        DumpTableTest2 = 2  'write fail
        Exit Function
    End If
    
    
     '====================================== dump buffer 3
 '   TableStr = ""
    TmpValue = DumpTable_AU6375A31(4, CBWDataTransferLength)
    
    TableStr = TableStr & "BufferNo = 4" & vbCrLf
  
    For i = 0 To 511
        TmpStr = STDHex(ReadData(i))
        TableStr = TableStr & TmpStr & " "
    
    
       If Table = 0 Then
            If DumpTableNormal(i + 512 * 2) <> TmpStr Then
               DumpTableTest2 = 33
               Exit Function
             End If
       Else
             If DumpTableInverse(i + 512 * 2) <> TmpStr Then
               DumpTableTest2 = 33
               Exit Function
             End If
       End If
          
        
           If ((i + 1) Mod 16) = 0 Then
             TableStr = TableStr & vbCrLf
        
           End If
    
    Next i
  
      'TableShow.Text1.Text = TableStr
    
    '====================================== dump buffer 5
   
    TmpValue = DumpTable_AU6375A31(5, CBWDataTransferLength)
    
    TableStr = TableStr & "BufferNo = 5" & vbCrLf
  
    For i = 0 To 511
        TmpStr = STDHex(ReadData(i))
        TableStr = TableStr & TmpStr & " "
    
       If Table = 0 Then
            If DumpTableNormal(i + 512 * 3) <> TmpStr Then
              DumpTableTest2 = 34
              Exit Function
            End If
       Else
            If DumpTableInverse(i + 512 * 3) <> TmpStr Then
              DumpTableTest2 = 34
              Exit Function
            End If
       End If

        
        
           If ((i + 1) Mod 16) = 0 Then
             TableStr = TableStr & vbCrLf
        
           End If
    
    Next i
  
    '====================================== dump buffer 6
 
    TmpValue = DumpTable_AU6375A31(6, CBWDataTransferLength)
    
    TableStr = TableStr & "BufferNo = 6" & vbCrLf
  
    For i = 0 To 511
        TmpStr = STDHex(ReadData(i))
        TableStr = TableStr & TmpStr & " "
    
    
       If Table = 0 Then
            If DumpTableNormal(i + 512 * 4) <> TmpStr Then
              DumpTableTest2 = 35
              Exit Function
            End If
      Else
             If DumpTableInverse(i + 512 * 4) <> TmpStr Then
               DumpTableTest2 = 35
               Exit Function
             End If
      End If
        
           If ((i + 1) Mod 16) = 0 Then
             TableStr = TableStr & vbCrLf
        
           End If
    
    Next i
  
  
  ' TableShow.Text1.Text = TableStr
    
   DumpTableTest2 = 1

  End Function

Function DumpTableTest(Table As Byte) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim TmpString As String
Dim TmpInteger As Integer
Dim TimerCounter As Integer
Dim OldTimer
Dim CBWDataTransferLength As Long
Dim TmpValue As Byte
Dim TableStr As String
Dim TmpStr As String

   CBWDataTransferLength = 512
 
'   For i = 0 To CBWDataTransferLength - 1
    
'         ReadData(i) = 0

'   Next

   
    '========================================
   
    DumpTableTest = 0
    
    '========================================
     TmpString = ""
    If ReaderExist = 0 Then
        Do
            DoEvents
            Call MsecDelay(0.1)
            TimerCounter = TimerCounter + 1
            TmpString = GetDeviceName("058f")
        Loop While TmpString = "" And TimerCounter < 10
    End If
    '=======================================
    If ReaderExist = 0 And TmpString <> "" Then
      ReaderExist = 1
    End If
    '=======================================
    If ReaderExist = 0 And TmpString = "" Then
      DumpTableTest = 0   ' no readerExist
      ReaderExist = 0
      Exit Function
    End If
    '=======================================
    If OpenPipe = 0 Then
      DumpTableTest = 2   ' Write fail
      Exit Function
    End If
   
    
    
       TmpInteger = TestUnitReady(3)   ' MS slot
        If TmpInteger = 0 Then
        TmpInteger = RequestSense(3)
        
        If TmpInteger = 0 Then
        
           DumpTableTest = 2  'Write fail
           Exit Function
        End If
        
    End If
    
   
    '====================================== dump buffer 2
    TableStr = ""
    TmpValue = DumpTable_AU6375A31(2, CBWDataTransferLength)
    
    TableStr = "BufferNo = 2" & vbCrLf
  
    For i = 0 To 511
        TmpStr = STDHex(ReadData(i))
        TableStr = TableStr & TmpStr & " "
    
      If Table = 0 Then
         If DumpTableNormal(i) <> TmpStr Then
           DumpTableTest = 31                   ' read fail , table fail
          Exit Function
         End If
      Else
         
         If DumpTableInverse(i) <> TmpStr Then
           DumpTableTest = 31                   ' read fail , table fail
          Exit Function
         End If
      End If
        
           If ((i + 1) Mod 16) = 0 Then
             TableStr = TableStr & vbCrLf
        
           End If
    
    Next i
     
     
  
   '====================================== dump buffer 3
   
    TmpValue = DumpTable_AU6375A31(3, CBWDataTransferLength)
    
    TableStr = TableStr & "BufferNo = 3" & vbCrLf
  
    For i = 0 To 511
        TmpStr = STDHex(ReadData(i))
        TableStr = TableStr & TmpStr & " "
    
      If Table = 0 Then
        If DumpTableNormal(i + 512) <> TmpStr Then
          DumpTableTest = 32
          Exit Function
        End If
        
     Else
        If DumpTableInverse(i + 512) <> TmpStr Then
          DumpTableTest = 32
          Exit Function
        End If
        
    End If
        
           If ((i + 1) Mod 16) = 0 Then
             TableStr = TableStr & vbCrLf
        
           End If
    
    Next i
  
  
  
     '======================================
    TmpInteger = TestUnitReady(2)    ' XD slot
    If TmpInteger = 0 Then
        TmpInteger = RequestSense(2)
        
        If TmpInteger = 0 Then
        
           DumpTableTest = 2  'Write fail
           Exit Function
        End If
        
    End If
    
    TmpInteger = Read_Data(2, 2, CBWDataTransferLength)
      
    If TmpInteger = 0 Then
        DumpTableTest = 2  'write fail
        Exit Function
    End If
    
    
     '====================================== dump buffer 3
 '   TableStr = ""
    TmpValue = DumpTable_AU6375A31(4, CBWDataTransferLength)
    
    TableStr = TableStr & "BufferNo = 4" & vbCrLf
  
    For i = 0 To 511
        TmpStr = STDHex(ReadData(i))
        TableStr = TableStr & TmpStr & " "
    
    
       If Table = 0 Then
            If DumpTableNormal(i + 512 * 2) <> TmpStr Then
               DumpTableTest = 33
               Exit Function
             End If
       Else
             If DumpTableInverse(i + 512 * 2) <> TmpStr Then
               DumpTableTest = 33
               Exit Function
             End If
       End If
          
        
           If ((i + 1) Mod 16) = 0 Then
             TableStr = TableStr & vbCrLf
        
           End If
    
    Next i
  
      'TableShow.Text1.Text = TableStr
    
    '====================================== dump buffer 5
   
    TmpValue = DumpTable_AU6375A31(5, CBWDataTransferLength)
    
    TableStr = TableStr & "BufferNo = 5" & vbCrLf
  
    For i = 0 To 511
        TmpStr = STDHex(ReadData(i))
        TableStr = TableStr & TmpStr & " "
    
       If Table = 0 Then
            If DumpTableNormal(i + 512 * 3) <> TmpStr Then
              DumpTableTest = 34
              Exit Function
            End If
       Else
            If DumpTableInverse(i + 512 * 3) <> TmpStr Then
              DumpTableTest = 34
              Exit Function
            End If
       End If

        
        
           If ((i + 1) Mod 16) = 0 Then
             TableStr = TableStr & vbCrLf
        
           End If
    
    Next i
  
    '====================================== dump buffer 6
 
    TmpValue = DumpTable_AU6375A31(6, CBWDataTransferLength)
    
    TableStr = TableStr & "BufferNo = 6" & vbCrLf
  
    For i = 0 To 511
        TmpStr = STDHex(ReadData(i))
        TableStr = TableStr & TmpStr & " "
    
    
       If Table = 0 Then
            If DumpTableNormal(i + 512 * 4) <> TmpStr Then
              DumpTableTest = 35
              Exit Function
            End If
      Else
             If DumpTableInverse(i + 512 * 4) <> TmpStr Then
               DumpTableTest = 35
               Exit Function
             End If
      End If
        
           If ((i + 1) Mod 16) = 0 Then
             TableStr = TableStr & vbCrLf
        
           End If
    
    Next i
  
  
   'TableShow.Text1.Text = TableStr
    
   DumpTableTest = 1

  End Function
Sub ReadTable()
Dim i As Integer
Dim tmp As String
Dim Str As String
Dim j As Integer

' ===================== read normal table
i = 0
Open App.Path & "\DumpTableNormal.txt" For Input As #2

    Do While Not EOF(2)
    
        Input #2, tmp
        If Len(tmp) > 20 Then
           ' Str = ""
            For j = 1 To 16
            
            DumpTableNormal(i) = Mid(tmp, (j - 1) * 3 + 1, 2)
           ' Str = Str & DumpTableNormal(i)
            i = i + 1
            Next j
        End If
       ' Debug.Print Str
          
        
    Loop

Close #2
'MsgBox i
' ===================== read inverse table

i = 0
Open App.Path & "\DumpTableInverse.txt" For Input As #2

     Do While Not EOF(2)
    
        Input #2, tmp
        If Len(tmp) > 20 Then
            Str = ""
            For j = 1 To 16
            
            DumpTableInverse(i) = Mid(tmp, (j - 1) * 3 + 1, 2)
           Str = Str & DumpTableInverse(i)
            i = i + 1
            Next j
        End If
       Debug.Print Str
          
        
    Loop

Close #2


'MsgBox i
' ===================== read inverse table


End Sub
Function CBWTest_New_no_card(Lun As Byte, PreSlotStatus As Byte, Vid_PID As String) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim TmpString As String
Dim TmpInteger As Integer
Dim TimerCounter As Integer
Dim OldTimer
Dim CBWDataTransferLength As Long

If PreSlotStatus <> 1 Then
    CBWTest_New_no_card = 4
    Exit Function
End If
CBWDataTransferLength = 1024
CBWTest_New_no_card = 0
If LBA > 25 * 1024 Then
LBA = 0
End If

 TmpString = ""
If ReaderExist = 0 Then
Do
DoEvents
 
               Call MsecDelay(0.1)
            TimerCounter = TimerCounter + 1
              TmpString = GetDeviceName(Vid_PID)
  
Loop While TmpString = "" And TimerCounter < 10
End If
If ReaderExist = 0 And TmpString <> "" Then
  ReaderExist = 1
End If

If ReaderExist = 0 And TmpString = "" Then
  CBWTest_New_no_card = 0   ' no readerExist
  ReaderExist = 0
  Exit Function
End If

 


If OpenPipe = 0 Then
  CBWTest_New_no_card = 2   ' Write fail
  Exit Function
End If


'  TmpInteger = TestUnitSpeed(Lun)
    
 '   If TmpInteger = 0 Then
        
 '      CBWTest_New_no_card = 2   ' usb 2.0 high speed fail
 '      UsbSpeedTestResult = 2
 '      Exit Function
 '   End If
 '   TmpInteger = 0

 


TmpInteger = TestUnitReady(Lun)
If TmpInteger = 0 Then
    TmpInteger = RequestSense(Lun)
    
    
    If TmpInteger = 0 Or RequestSenseData(12) <> 58 Then
    
       CBWTest_New_no_card = 2  'Write fail
       Exit Function
    End If
    
End If





TmpInteger = TestUnitReady(Lun)

If TmpInteger = 0 Then
    TmpInteger = RequestSense(Lun)
    
    If TmpInteger = 0 Or RequestSenseData(12) <> 58 Then
    
       CBWTest_New_no_card = 2  'Write fail
       Exit Function
    End If
    
End If



CBWTest_New_no_card = 1
    

End Function

Function Write_Data(LBA As Long, Lun As Byte, CBWDataTransferLength As Long) As Byte

Dim CBW(0 To 30) As Byte
Dim CSW(0 To 12) As Byte
Dim NumberOfBytesWritten As Long
Dim NumberOfBytesRead As Long
Dim CBWDataTransferLen(0 To 3) As Byte
Dim TransferLen As Long
Dim TransferLenLSB As Byte
Dim TransferLenMSB As Byte
Dim i As Integer
Dim tmpV(0 To 2) As Long
Dim opcode As Byte

opcode = &H2A
'Buffer(0) = &H33 'CByte(Text2.Text)
'Buffer(1) = &H44


    For i = 0 To 30
    
        CBW(i) = 0
    
    Next i
    
Const CBWSignature_0 = &H55
Const CBWSignature_1 = &H53
Const CBWSignature_2 = &H42
Const CBWSignature_3 = &H43


Const CBWTag_0 = &H1
Const CBWTag_1 = &H2
Const CBWTag_2 = &H3
Const CBWTag_3 = &H4


'/////////////////// CBW signature

CBW(0) = CBWSignature_0
CBW(1) = CBWSignature_1
CBW(2) = CBWSignature_2
CBW(3) = CBWSignature_3

'/////////////////  CBW Tag

CBW(4) = CBWTag_0
CBW(5) = CBWTag_1
CBW(6) = CBWTag_2
CBW(7) = CBWTag_3

CBWDataTransferLen(0) = (CBWDataTransferLength Mod 256)
tmpV(0) = Int(CBWDataTransferLength / 256)
CBWDataTransferLen(1) = (tmpV(0) Mod 256)
tmpV(1) = Int(tmpV(0) / 256)
CBWDataTransferLen(2) = (tmpV(1) Mod 256)
tmpV(2) = Int((tmpV(1) / 256))
CBWDataTransferLen(3) = (tmpV(2) Mod 256)

CBW(8) = CBWDataTransferLen(0)  '00
CBW(9) = CBWDataTransferLen(1)  '08
CBW(10) = CBWDataTransferLen(2) '00
CBW(11) = CBWDataTransferLen(3) '00

'///////////////  CBW Flag
CBW(12) = &H0                 '80

'////////////// LUN
CBW(13) = Lun                    '00

'///////////// CBD Len
CBW(14) = &HA                '0a

'////////////  UFI command

CBW(15) = opcode
CBW(16) = Lun * 32
LBAByte(0) = (LBA Mod 256)
tmpV(0) = Int(LBA / 256)
LBAByte(1) = (tmpV(0) Mod 256)
tmpV(1) = Int(tmpV(0) / 256)
LBAByte(2) = (tmpV(1) Mod 256)
tmpV(2) = Int((tmpV(1) / 256))
LBAByte(3) = (tmpV(2) Mod 256)

CBW(17) = LBAByte(3)         '00
CBW(18) = LBAByte(2)         '00
CBW(19) = LBAByte(1)         '00
CBW(20) = LBAByte(0)         '40

'/////////////  Reverve
CBW(21) = 0

'//////////// Transfer Len

TransferLen = Int(CBWDataTransferLength / 512)

TransferLenLSB = (TransferLen Mod 256)
tmpV(0) = Int(TransferLen / 256)
TransferLenMSB = (tmpV(0) / 256)

CBW(22) = TransferLenMSB      '00
CBW(23) = TransferLenLSB      '04

For i = 24 To 30
    CBW(i) = 0
Next

 
'1. CBW output
 
result = WriteFile _
       (WriteHandle, _
       CBW(0), _
       31, _
       NumberOfBytesWritten, _
       0)    'out

If result = 0 Then
    Write_Data = 0
    Exit Function
End If
 
'2, Output data
result = WriteFile _
       (WriteHandle, _
       Pattern(0), _
       CBWDataTransferLength, _
       NumberOfBytesWritten, _
       0)    'out

 
If result = 0 Then
    Write_Data = 0
    Exit Function
End If

'3 . CSW
result = ReadFile _
         (ReadHandle, _
          CSW(0), _
          13, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in
        
If result = 0 Then
    Write_Data = 0
    Exit Function
End If
 
 
 
If CSW(12) = 1 Then
Write_Data = 0

Else
Write_Data = 1
End If
End Function

Function InquiryScSiString(Lun As Byte, CBWDataTransferLength As Long, ScSiRecMode As Byte) As Byte
Dim CBW(0 To 30) As Byte
Dim NumberOfBytesWritten As Long
Dim CBWDataTransferLen(0 To 3) As Byte
  
Dim TransferLen As Long
Dim TransferLenLSB As Byte
Dim TransferLenMSB As Byte
Dim i As Integer
Dim tmpV(0 To 2) As Long
Dim opcode As Byte

Dim CSW(0 To 12) As Byte

Dim NumberOfBytesRead As Long

'Dim Capacity(0 To 7) As Byte

 
For i = 0 To 30
   
        CBW(i) = 0
    
Next i

For i = 0 To CBWDataTransferLength
ReadData(i) = 0
Next

Const CBWSignature_0 = &H55
Const CBWSignature_1 = &H53
Const CBWSignature_2 = &H42
Const CBWSignature_3 = &H43


Const CBWTag_0 = &H1
Const CBWTag_1 = &H2
Const CBWTag_2 = &H3
Const CBWTag_3 = &H4


'/////////////////// CBW signature

CBW(0) = CBWSignature_0
CBW(1) = CBWSignature_1
CBW(2) = CBWSignature_2
CBW(3) = CBWSignature_3

'/////////////////  CBW Tag

CBW(4) = CBWTag_0
CBW(5) = CBWTag_1
CBW(6) = CBWTag_2
CBW(7) = CBWTag_3

 
CBW(8) = &H24  '00
CBW(9) = &H0  '08
CBW(10) = &H0 '00
CBW(11) = &H0 '00

'///////////////  CBW Flag
CBW(12) = &H80                 '80

'////////////// LUN
CBW(13) = Lun                    '00

'///////////// CBD Len
CBW(14) = &H6               '0a

'////////////  UFI command

CBW(15) = &H12
CBW(16) = Lun * 32
 
CBW(17) = &H0         '00
CBW(18) = &H0        '00
CBW(19) = &H24       '00
CBW(20) = &H0         '40

'/////////////  Reverve
CBW(21) = 0

'//////////// Transfer Len

 
CBW(22) = &H0     '00
CBW(23) = &H0     '04

For i = 24 To 30
    CBW(i) = 0
Next

'\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
 
Dim result As Long

'1. CBW command

 
result = WriteFile _
       (WriteHandle, _
       CBW(0), _
       31, _
       NumberOfBytesWritten, _
       0)    'out

If result = 0 Then
 InquiryScSiString = 0
 Exit Function
End If

'2. Readdata stage
 
result = ReadFile _
         (ReadHandle, _
          ReadData(0), _
         CBWDataTransferLength, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in


If result = 0 Then
  InquiryScSiString = 0
 Exit Function
End If




' ============ Record function
If ScSiRecMode = 0 Then

                For i = 0 To CBWDataTransferLength - 1
                Debug.Print "k", i, Hex(ReadData(i))
                 If ReadData(i) <> InquiryString(Lun, i) Then
                  
                   InquiryScSiString = 2  ' card format capacity has problem
                   Exit Function
                 End If
                
                
                Next i

                 
 

Else



' ============ Record function
 
Select Case Lun
Case 0

                Open App.Path & "\SCSI0.txt" For Output As #4

                     For i = 0 To 35
                        Print #4, ReadData(i)
                     Next i
                 Close #4
                 
Case 1
                Open App.Path & "\SCSI1.txt" For Output As #4

                     For i = 0 To 35
                        Print #4, ReadData(i)
                     Next i
                 Close #4


Case 2

                 Open App.Path & "\SCSI2.txt" For Output As #4

                     For i = 0 To 35
                        Print #4, ReadData(i)
                     Next i
                 Close #4

Case 3
                
                  Open App.Path & "\SCSI3.txt" For Output As #4

                     For i = 0 To 35
                        Print #4, ReadData(i)
                     Next i
                 Close #4



End Select

End If

'3. CSW data
 result = ReadFile _
         (ReadHandle, _
          CSW(0), _
          13, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in
 
If result = 0 Then
 InquiryScSiString = 0
 Exit Function
End If
 
'4. CSW status

If CSW(12) = 1 Then
     InquiryScSiString = 0
Else
     InquiryScSiString = 1
   
End If

 
End Function

Function Read_Capacity(LBA As Long, Lun As Byte, CBWDataTransferLength As Long) As Byte
Dim CBW(0 To 30) As Byte
Dim NumberOfBytesWritten As Long
Dim CBWDataTransferLen(0 To 3) As Byte
  
Dim TransferLen As Long
Dim TransferLenLSB As Byte
Dim TransferLenMSB As Byte
Dim i As Integer
Dim tmpV(0 To 2) As Long
Dim opcode As Byte

Dim CSW(0 To 12) As Byte

Dim NumberOfBytesRead As Long

Dim Capacity(0 To 7) As Byte

'Capacity(0) = &H0
'Capacity(1) = &H78
'Capacity(2) = &HFF
'Capacity(3) = &HFF
'Capacity(4) = &H0
'Capacity(5) = &H0
'Capacity(6) = &H2
'Capacity(7) = &H0

Capacity(0) = &H0
Capacity(1) = &H7C
Capacity(2) = &H7F
Capacity(3) = &HFD
Capacity(4) = &H0
Capacity(5) = &H0
Capacity(6) = &H2
Capacity(7) = &H0

For i = 0 To 30
   
        CBW(i) = 0
    
Next i

For i = 0 To CBWDataTransferLength
ReadData(i) = 0
Next

Const CBWSignature_0 = &H55
Const CBWSignature_1 = &H53
Const CBWSignature_2 = &H42
Const CBWSignature_3 = &H43


Const CBWTag_0 = &H1
Const CBWTag_1 = &H2
Const CBWTag_2 = &H3
Const CBWTag_3 = &H4


'/////////////////// CBW signature

CBW(0) = CBWSignature_0
CBW(1) = CBWSignature_1
CBW(2) = CBWSignature_2
CBW(3) = CBWSignature_3

'/////////////////  CBW Tag

CBW(4) = CBWTag_0
CBW(5) = CBWTag_1
CBW(6) = CBWTag_2
CBW(7) = CBWTag_3

 
CBW(8) = &H8  '00
CBW(9) = &H0  '08
CBW(10) = &H0 '00
CBW(11) = &H0 '00

'///////////////  CBW Flag
CBW(12) = &H80                 '80

'////////////// LUN
CBW(13) = Lun                    '00

'///////////// CBD Len
CBW(14) = &HA                '0a

'////////////  UFI command

CBW(15) = &H25
CBW(16) = Lun * 32
 
CBW(17) = &H0         '00
CBW(18) = &H0        '00
CBW(19) = &H0        '00
CBW(20) = &H0         '40

'/////////////  Reverve
CBW(21) = 0

'//////////// Transfer Len

 
CBW(22) = &H0     '00
CBW(23) = &H0     '04

For i = 24 To 30
    CBW(i) = 0
Next

'\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
 
Dim result As Long

'1. CBW command

 
result = WriteFile _
       (WriteHandle, _
       CBW(0), _
       31, _
       NumberOfBytesWritten, _
       0)    'out

If result = 0 Then
 Read_Capacity = 0
 Exit Function
End If

'2. Readdata stage
 
result = ReadFile _
         (ReadHandle, _
          ReadData(0), _
         CBWDataTransferLength, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in




 
If result = 0 Then
  Read_Capacity = 0
 Exit Function
End If


For i = 0 To CBWDataTransferLength - 1
Debug.Print "k", i, Hex(ReadData(i)), Capacity(i)
'If ReadData(i) <> Capacity(i) Then
  
 ' Read_Capacity = 2  ' card format capacity has problem
  'Exit Function
'End If


Next i


'3. CSW data
 result = ReadFile _
         (ReadHandle, _
          CSW(0), _
          13, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in
 
If result = 0 Then
 Read_Capacity = 0
 Exit Function
End If
 
'4. CSW status

If CSW(12) = 1 Then
     Read_Capacity = 0
Else
      Read_Capacity = 1
   
End If

 
End Function

Function Read_Data1(LBA As Long, Lun As Byte, CBWDataTransferLength As Long) As Byte
Dim CBW(0 To 30) As Byte
Dim NumberOfBytesWritten As Long
Dim CBWDataTransferLen(0 To 3) As Byte
  
Dim TransferLen As Long
Dim TransferLenLSB As Byte
Dim TransferLenMSB As Byte
Dim i As Integer
Dim tmpV(0 To 2) As Long
Dim opcode As Byte

Dim CSW(0 To 12) As Byte

Dim NumberOfBytesRead As Long

For i = 0 To 30
   
        CBW(i) = 0
    
Next i

For i = 0 To CBWDataTransferLength
ReadData(i) = 0
Next

Const CBWSignature_0 = &H55
Const CBWSignature_1 = &H53
Const CBWSignature_2 = &H42
Const CBWSignature_3 = &H43


Const CBWTag_0 = &H1
Const CBWTag_1 = &H2
Const CBWTag_2 = &H3
Const CBWTag_3 = &H4


'/////////////////// CBW signature

CBW(0) = CBWSignature_0
CBW(1) = CBWSignature_1
CBW(2) = CBWSignature_2
CBW(3) = CBWSignature_3

'/////////////////  CBW Tag

CBW(4) = CBWTag_0
CBW(5) = CBWTag_1
CBW(6) = CBWTag_2
CBW(7) = CBWTag_3

CBWDataTransferLen(0) = (CBWDataTransferLength Mod 256)
tmpV(0) = Int(CBWDataTransferLength / 256)
CBWDataTransferLen(1) = (tmpV(0) Mod 256)
tmpV(1) = Int(tmpV(0) / 256)
CBWDataTransferLen(2) = (tmpV(1) Mod 256)
tmpV(2) = Int((tmpV(1) / 256))
CBWDataTransferLen(3) = (tmpV(2) Mod 256)

CBW(8) = CBWDataTransferLen(0)  '00
CBW(9) = CBWDataTransferLen(1)  '08
CBW(10) = CBWDataTransferLen(2) '00
CBW(11) = CBWDataTransferLen(3) '00

'///////////////  CBW Flag
CBW(12) = &H80                 '80

'////////////// LUN
CBW(13) = Lun                    '00

'///////////// CBD Len
CBW(14) = &HA                '0a

'////////////  UFI command

CBW(15) = &H28
CBW(16) = Lun * 32
LBAByte(0) = (LBA Mod 256)
tmpV(0) = Int(LBA / 256)
LBAByte(1) = (tmpV(0) Mod 256)
tmpV(1) = Int(tmpV(0) / 256)
LBAByte(2) = (tmpV(1) Mod 256)
tmpV(2) = Int((tmpV(1) / 256))
LBAByte(3) = (tmpV(2) Mod 256)

CBW(17) = LBAByte(3)         '00
CBW(18) = LBAByte(2)         '00
CBW(19) = LBAByte(1)         '00
CBW(20) = LBAByte(0)         '40

'/////////////  Reverve
CBW(21) = 0

'//////////// Transfer Len

TransferLen = Int(CBWDataTransferLength / 512)

TransferLenLSB = (TransferLen Mod 256)
tmpV(0) = Int(TransferLen / 256)
TransferLenMSB = (tmpV(0) / 256)

CBW(22) = TransferLenMSB      '00
CBW(23) = TransferLenLSB      '04

For i = 24 To 30
    CBW(i) = 0
Next

'\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
 
Dim result As Long

'1. CBW command

 
result = WriteFile _
       (WriteHandle, _
       CBW(0), _
       31, _
       NumberOfBytesWritten, _
       0)    'out

If result = 0 Then
 Read_Data1 = 0
 Exit Function
End If

'2. Readdata stage
 
result = ReadFile _
         (ReadHandle, _
          ReadData(0), _
         CBWDataTransferLength, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in

 
 

'3. CSW data
 result = ReadFile _
         (ReadHandle, _
          CSW(0), _
          13, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in
 
If result = 0 Then
 Read_Data1 = 0
 Exit Function
End If
 
'4. CSW status

If CSW(12) = 1 Then
    Read_Data1 = 0
Else
     Read_Data1 = 1
   
End If

 
End Function
Function Read_Data(LBA As Long, Lun As Byte, CBWDataTransferLength As Long) As Byte
Dim CBW(0 To 30) As Byte
Dim NumberOfBytesWritten As Long
Dim CBWDataTransferLen(0 To 3) As Byte
  
Dim TransferLen As Long
Dim TransferLenLSB As Byte
Dim TransferLenMSB As Byte
Dim i As Integer
Dim tmpV(0 To 2) As Long
Dim opcode As Byte

Dim CSW(0 To 12) As Byte

Dim NumberOfBytesRead As Long

For i = 0 To 30
   
        CBW(i) = 0
    
Next i

For i = 0 To CBWDataTransferLength
ReadData(i) = 0
Next

Const CBWSignature_0 = &H55
Const CBWSignature_1 = &H53
Const CBWSignature_2 = &H42
Const CBWSignature_3 = &H43


Const CBWTag_0 = &H1
Const CBWTag_1 = &H2
Const CBWTag_2 = &H3
Const CBWTag_3 = &H4


'/////////////////// CBW signature

CBW(0) = CBWSignature_0
CBW(1) = CBWSignature_1
CBW(2) = CBWSignature_2
CBW(3) = CBWSignature_3

'/////////////////  CBW Tag

CBW(4) = CBWTag_0
CBW(5) = CBWTag_1
CBW(6) = CBWTag_2
CBW(7) = CBWTag_3

CBWDataTransferLen(0) = (CBWDataTransferLength Mod 256)
tmpV(0) = Int(CBWDataTransferLength / 256)
CBWDataTransferLen(1) = (tmpV(0) Mod 256)
tmpV(1) = Int(tmpV(0) / 256)
CBWDataTransferLen(2) = (tmpV(1) Mod 256)
tmpV(2) = Int((tmpV(1) / 256))
CBWDataTransferLen(3) = (tmpV(2) Mod 256)

CBW(8) = CBWDataTransferLen(0)  '00
CBW(9) = CBWDataTransferLen(1)  '08
CBW(10) = CBWDataTransferLen(2) '00
CBW(11) = CBWDataTransferLen(3) '00

'///////////////  CBW Flag
CBW(12) = &H80                 '80

'////////////// LUN
CBW(13) = Lun                    '00

'///////////// CBD Len
CBW(14) = &HA                '0a

'////////////  UFI command

CBW(15) = &H28
CBW(16) = Lun * 32
LBAByte(0) = (LBA Mod 256)
tmpV(0) = Int(LBA / 256)
LBAByte(1) = (tmpV(0) Mod 256)
tmpV(1) = Int(tmpV(0) / 256)
LBAByte(2) = (tmpV(1) Mod 256)
tmpV(2) = Int((tmpV(1) / 256))
LBAByte(3) = (tmpV(2) Mod 256)

CBW(17) = LBAByte(3)         '00
CBW(18) = LBAByte(2)         '00
CBW(19) = LBAByte(1)         '00
CBW(20) = LBAByte(0)         '40

'/////////////  Reverve
CBW(21) = 0

'//////////// Transfer Len

TransferLen = Int(CBWDataTransferLength / 512)

TransferLenLSB = (TransferLen Mod 256)
tmpV(0) = Int(TransferLen / 256)
TransferLenMSB = (tmpV(0) / 256)

CBW(22) = TransferLenMSB      '00
CBW(23) = TransferLenLSB      '04

For i = 24 To 30
    CBW(i) = 0
Next

'\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
 
Dim result As Long

'1. CBW command

 
result = WriteFile _
       (WriteHandle, _
       CBW(0), _
       31, _
       NumberOfBytesWritten, _
       0)    'out

If result = 0 Then
 Read_Data = 0
 Exit Function
End If

'2. Readdata stage
 
result = ReadFile _
         (ReadHandle, _
          ReadData(0), _
         CBWDataTransferLength, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in

 
'If result = 0 Then
' Read_Data = 0
' Exit Function
'End If

'3. CSW data
 result = ReadFile _
         (ReadHandle, _
          CSW(0), _
          13, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in
 
If result = 0 Then
 Read_Data = 0
 Exit Function
End If
 
'4. CSW status

If CSW(12) = 1 Then
    Read_Data = 0
Else
     Read_Data = 1
   
End If

 
End Function
Function RequestSense(Lun As Byte) As Byte

Dim CBW(0 To 30) As Byte
Dim ReadData(0 To 17) As Byte
Dim CSW(0 To 12) As Byte
Dim i As Integer
Dim NumberOfBytesWritten As Long
 
Dim NumberOfBytesRead As Long

    For i = 0 To 30
    
        CBW(i) = 0
    
    Next i
    
    
     For i = 0 To 17
    
        RequestSenseData(i) = 0
    
    Next i

CBW(0) = &H55 'signature
CBW(1) = &H53
CBW(2) = &H42
CBW(3) = &H43


CBW(4) = &H1  'package ID
CBW(5) = &H2
CBW(6) = &H3
CBW(7) = &H4


CBW(8) = &H12
CBW(9) = &H0
CBW(10) = &H0
CBW(11) = &H0





CBW(12) = &H80 '    CBW FLAG 0000
CBW(13) = Lun
 
CBW(14) = &HA
CBW(15) = &H3

CBW(16) = Lun * 32
CBW(19) = &H12

'1. CBW
RequestSense = 0

result = WriteFile _
       (WriteHandle, _
       CBW(0), _
       31, _
       NumberOfBytesWritten, _
       0)    'out
 
 
If result = 0 Then
    RequestSense = 0
    Exit Function
End If
 
 
 
'2. Request Data input
'2. Request Data input
result = ReadFile _
         (ReadHandle, _
          RequestSenseData(0), _
          18, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in
          
          
          
If result = 0 Then
    RequestSense = 0
    Exit Function
End If
           
          
'3. CSW
 result = ReadFile _
         (ReadHandle, _
          CSW(0), _
          13, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in
        
If result = 0 Then
    RequestSense = 0
    Exit Function
End If
 

If CSW(12) = 1 Then
RequestSense = 0

Else
RequestSense = 1
End If
End Function


Function ClosePipe() As Integer
On Error Resume Next
CloseHandle (ReadHandle)

CloseHandle (WriteHandle)


End Function

Function ClosePipe6331() As Integer
On Error Resume Next
 
CloseHandle (WriteHandle6331)


End Function

Function OpenPipe() As Byte
Dim WritePathName As String
Dim ReadPathName As String

OpenPipe = 0
WritePathName = Left(DevicePathName, Len(DevicePathName) - 2) & "\PIPE0"   '
'Debug.Print Lba
'Debug.Print "WritePathName="; WritePathName
WriteHandle = CreateFile _
             (WritePathName, _
            GENERIC_READ Or GENERIC_WRITE, _
            (FILE_SHARE_READ Or FILE_SHARE_WRITE), _
             Security, _
             OPEN_EXISTING, _
             0&, _
            0)
'Debug.Print "write handle"; WriteHandle
If WriteHandle = 0 Then
  OpenPipe = 0
  Exit Function
End If

  
ReadPathName = Left(DevicePathName, Len(DevicePathName) - 2) & "\PIPE1"
 ReadHandle = CreateFile _
            (ReadPathName, _
            GENERIC_READ Or GENERIC_WRITE, _
            (FILE_SHARE_READ Or FILE_SHARE_WRITE), _
            Security, _
            OPEN_EXISTING, _
            0&, _
            0)
If ReadHandle = 0 Then
  OpenPipe = 0
  Exit Function
End If

OpenPipe = 1
End Function
Function AU6375EndLess(Lun As Byte) As Byte

On Error GoTo CancelHandle
Dim CBW(0 To 30) As Byte
Dim CSW(0 To 12) As Byte
Dim i As Integer
Dim NumberOfBytesWritten As Long
Dim NumberOfBytesRead As Long
Dim result As Long

     For i = 0 To 30
    
        CBW(i) = 0
    
    Next i

CBW(0) = &H55 'signature
CBW(1) = &H53
CBW(2) = &H42
'CBW(3) = &H43  ' orgioinal tag
CBW(3) = &H43 ' for test unit speed


CBW(4) = &H8   'package ID
CBW(5) = &HB0
CBW(6) = &H32
CBW(7) = &H84


CBW(8) = &H18
CBW(9) = &H0
CBW(10) = &H0
CBW(11) = &H0


CBW(12) = &H80  '    CBW FLAG 0000
 
CBW(13) = &H1
CBW(14) = &HA
CBW(15) = &H76

CBW(16) = &H4
CBW(17) = &H30
CBW(18) = &H35
CBW(19) = &H38

CBW(20) = &H46
CBW(21) = &H1
 
 


'1. CBW output

AU6375EndLess = 0
If ChipName = "AU6375AS" Then

        result = WriteFile _
               (WriteHandle, _
               CBW(0), _
               31, _
               NumberOfBytesWritten, _
               0)
        
        If result = 0 Then
             AU6375EndLess = 0
            Exit Function
        End If

End If


'2. CSW input
 OldTimer = Timer
 result = ReadFile _
         (ReadHandle, _
          CSW(0), _
          13, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in
Debug.Print "AU6375EndLess"
For i = 0 To 12
Debug.Print i, CSW(i)
Next i

If result = 0 Then
    AU6375EndLess = 0
   Exit Function
End If

 
'3 CSW Status
If CSW(12) = 1 Then
    AU6375EndLess = 0
    
    Else
    AU6375EndLess = 1
    End If

Exit Function

CancelHandle:

CancelIo (ReadHandle)



End Function

Function AU6375TestMode(Lun As Byte) As Byte
Dim CBW(0 To 30) As Byte
Dim CSW(0 To 12) As Byte
Dim i As Integer
Dim NumberOfBytesWritten As Long
Dim NumberOfBytesRead As Long
Dim result As Long

     For i = 0 To 30
    
        CBW(i) = 0
    
    Next i

CBW(0) = &H55 'signature
CBW(1) = &H53
CBW(2) = &H42
'CBW(3) = &H43  ' orgioinal tag
CBW(3) = &H43 ' for test unit speed


CBW(4) = &H8   'package ID
CBW(5) = &HB0
CBW(6) = &H32
CBW(7) = &H84


CBW(8) = &H0
CBW(9) = &H0
CBW(10) = &H0
CBW(11) = &H0


CBW(12) = &H0  '    CBW FLAG 0000
 
CBW(13) = &H1
CBW(14) = &HA
CBW(15) = &HC7

CBW(16) = &H4
CBW(17) = &H30
CBW(18) = &H35
CBW(19) = &H38

CBW(20) = &H46
CBW(21) = &H1
 
 


'1. CBW output

AU6375TestMode = 0

result = WriteFile _
       (WriteHandle, _
       CBW(0), _
       31, _
       NumberOfBytesWritten, _
       0)

If result = 0 Then
     AU6375TestMode = 0
    Exit Function
End If


'2. CSW input
 result = ReadFile _
         (ReadHandle, _
          CSW(0), _
          13, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in
Debug.Print "AU6375TestMode"
For i = 0 To 12
Debug.Print i, CSW(i)
Next i

If result = 0 Then
    AU6375TestMode = 0
   Exit Function
End If

 
'3 CSW Status
If CSW(4) = &H8 And CSW(5) = &HB0 And CSW(6) = &H32 And CSW(7) = &H84 Then
    AU6375TestMode = 1
    
    Else
    AU6375TestMode = 0
    End If

End Function


Function TestUnitSpeed(Lun As Byte) As Byte
Dim CBW(0 To 30) As Byte
Dim CSW(0 To 12) As Byte
Dim i As Integer
Dim NumberOfBytesWritten As Long
Dim NumberOfBytesRead As Long
Dim result As Long

     For i = 0 To 30
    
        CBW(i) = 0
    
    Next i

CBW(0) = &H55 'signature
CBW(1) = &H53
CBW(2) = &H42
'CBW(3) = &H43  ' orgioinal tag
CBW(3) = &H55  ' for test unit speed


CBW(4) = &H1  'package ID
CBW(5) = &H2
CBW(6) = &H3
CBW(7) = &H4


CBW(8) = &H0
CBW(9) = &H0
CBW(10) = &H0
CBW(11) = &H0


CBW(12) = &H80 '    CBW FLAG 0000
'CBW(13) = &H0
CBW(13) = Lun
CBW(14) = &H0
CBW(15) = &H0
CBW(16) = Lun * 32


'1. CBW output

TestUnitSpeed = 0

result = WriteFile _
       (WriteHandle, _
       CBW(0), _
       31, _
       NumberOfBytesWritten, _
       0)

If result = 0 Then
     TestUnitSpeed = 0
    Exit Function
End If


'2. CSW input
 result = ReadFile _
         (ReadHandle, _
          CSW(0), _
          13, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in
Debug.Print "TestUnit Speed"
For i = 0 To 12
Debug.Print i, CSW(i)
Next i

If result = 0 Then
    TestUnitSpeed = 0
   Exit Function
End If

 
'3 CSW Status
If CSW(12) = 1 Then
    TestUnitSpeed = 0
    
    Else
    TestUnitSpeed = 1
    End If

End Function
Function TestUnitReady(Lun As Byte) As Byte
Dim CBW(0 To 30) As Byte
Dim CSW(0 To 12) As Byte
Dim i As Integer
Dim NumberOfBytesWritten As Long
Dim NumberOfBytesRead As Long
Dim result As Long

     For i = 0 To 30
    
        CBW(i) = 0
    
    Next i

CBW(0) = &H55 'signature
CBW(1) = &H53
CBW(2) = &H42
CBW(3) = &H43


CBW(4) = &H1  'package ID
CBW(5) = &H2
CBW(6) = &H3
CBW(7) = &H4


CBW(8) = &H0
CBW(9) = &H0
CBW(10) = &H0
CBW(11) = &H0


CBW(12) = &H80 '    CBW FLAG 0000
'CBW(13) = &H0
CBW(13) = Lun
CBW(14) = &H0
CBW(15) = &H0
CBW(16) = Lun * 32


'1. CBW output

TestUnitReady = 0

result = WriteFile _
       (WriteHandle, _
       CBW(0), _
       31, _
       NumberOfBytesWritten, _
       0)

'If result = 0 Then
'    TestUnitReady = 0
'    Exit Function
'End If


'2. CSW input
 result = ReadFile _
         (ReadHandle, _
          CSW(0), _
          13, _
          NumberOfBytesRead, _
          HIDOverlapped)  'in

If result = 0 Then
    TestUnitReady = 0
    Exit Function
End If

 
'3 CSW Status
If CSW(12) = 1 Then
    TestUnitReady = 0
    
    Else
    TestUnitReady = 1
End If

End Function

Function CBWTest_New_8_Sector(Lun As Byte, PreSlotStatus As Byte, FailPosition As Integer, Times As Integer) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim TmpString As String
Dim TmpInteger As Integer
Dim TimerCounter As Integer
Dim OldTimer
Dim CBWDataTransferLength As Long
Dim j As Integer

 CBWDataTransferLength = 1024 * 4 ' 8 sector

   
    If PreSlotStatus <> 1 Then
        CBWTest_New_8_Sector = 4
        Exit Function
    End If
    '========================================
   
    CBWTest_New_8_Sector = 2
   
    '========================================
    
    
     If OpenPipe = 0 Then
       CBWTest_New_8_Sector = 2   ' Write fail
       Exit Function
     End If
  
    '====================================
     TmpInteger = TestUnitSpeed(Lun)
    
    If TmpInteger = 0 Then
        
       CBWTest_New_8_Sector = 2   ' usb 2.0 high speed fail
       UsbSpeedTestResult = 2
       Exit Function
    End If
    TmpInteger = 0
    
    TmpInteger = TestUnitReady(Lun)
     If TmpInteger = 0 Then
         TmpInteger = RequestSense(Lun)
        
         If TmpInteger = 0 Then
        
            CBWTest_New_8_Sector = 2  'Write fail
            Exit Function
         End If
        
     End If
  
  For j = 1 To Times
   
   
        If LBA > 25 * 1024 Then
            LBA = 0
        End If
    
       ' For i = 0 To CBWDataTransferLength - 1
        
       '      ReadData(i) = 0
    
       ' Next

      
        TmpInteger = Write_Data(LBA, Lun, CBWDataTransferLength)
         
        If TmpInteger = 0 Then
            CBWTest_New_8_Sector = 2  'write fail
            FailPosition = j
            Exit Function
        End If
    
        TmpInteger = Read_Data(LBA, Lun, CBWDataTransferLength)
         
        If TmpInteger = 0 Then
            CBWTest_New_8_Sector = 3    'Read fail
            FailPosition = j
            Exit Function
        End If
     
        For i = 0 To CBWDataTransferLength - 1
        
            If ReadData(i) <> Pattern(i) Then
              CBWTest_New_8_Sector = 3    'Read fail
              FailPosition = j
              Exit Function
            End If
        
        Next
        
        CBWTest_New_8_Sector = 1
           
        LBA = LBA + 1
  Next
    
    End Function

Function CBWTest_New_AU6390MB(Lun As Byte, PreSlotStatus As Byte, Vid_PID As String, Flash As Byte) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim TmpString As String
Dim TmpInteger As Integer
Dim TimerCounter As Integer
Dim OldTimer
Dim CBWDataTransferLength As Long
Dim HalfFlashCapacity As Long
Dim OldLba As Long

   CBWDataTransferLength = 1024 * 4  ' 8 sector, MB flash 2k/page, and it is 4 flash
                                    '  8 sector for 2 page for 2 flash
                                    ' the another 8 sector for another 2 flash set
   
'   For i = 0 To CBWDataTransferLength - 1
    
'         ReadData(i) = 0

'   Next

    If PreSlotStatus <> 1 Then
        CBWTest_New_AU6390MB = 4
        Exit Function
    End If
    '========================================
   
    CBWTest_New_AU6390MB = 0
    If Flash = 1 Or Flash = 0 Then
     If LBA > 3932160 Then
         LBA = 0
     End If
   End If
    '========================================
     TmpString = ""
    If ReaderExist = 0 Then
        Do
            DoEvents
            Call MsecDelay(0.1)
            TimerCounter = TimerCounter + 1
            TmpString = GetDeviceName(Vid_PID)
        Loop While TmpString = "" And TimerCounter < 10
    End If
    '=======================================
    If ReaderExist = 0 And TmpString <> "" Then
      ReaderExist = 1
    End If
    '=======================================
    If ReaderExist = 0 And TmpString = "" Then
      CBWTest_New_AU6390MB = 0    ' no readerExist
      ReaderExist = 0
      Exit Function
    End If
    '=======================================
    If OpenPipe = 0 Then
      CBWTest_New_AU6390MB = 2    ' Write fail
      Exit Function
    End If
 
    '======================================
    
     ' for unitSpeed
    
    TmpInteger = TestUnitSpeed(Lun)
    
    If TmpInteger = 0 Then
        
       CBWTest_New_AU6390MB = 2    ' usb 2.0 high speed fail
       UsbSpeedTestResult = 2
       Exit Function
    End If
    
    
    
    TmpInteger = TestUnitReady(Lun)
    If TmpInteger = 0 Then
        TmpInteger = RequestSense(Lun)
        
        If TmpInteger = 0 Then
        
           CBWTest_New_AU6390MB = 2   'Write fail
           Exit Function
        End If
        
    End If
    '======================================
   
    TmpInteger = Read_Data(LBA, Lun, CBWDataTransferLength)
      TmpInteger = Read_Data(LBA, Lun, CBWDataTransferLength)
    If TmpInteger = 0 Then
         CBWTest_New_AU6390MB = 2   'write fail
          Exit Function
     End If
    
      
   ' for AU6390MB to read capacity
   
   
     TmpInteger = Read_Capacity(LBA, Lun, 8)
      
    If TmpInteger = 0 Then
         CBWTest_New_AU6390MB = 3   'Read fail
          Exit Function
     ElseIf TmpInteger = 2 Then
           FlashCapacityError = 2
           CBWTest_New_AU6390MB = 3   'card format has problem
          Exit Function
          
     End If
      
      
     If Flash = 0 Then
      CBWTest_New_AU6390MB = 1
        Exit Function
     End If
      
 
 
    TmpInteger = Write_Data(LBA, Lun, CBWDataTransferLength)
     
    If TmpInteger = 0 Then
        CBWTest_New_AU6390MB = 2   'write fail
        Exit Function
    End If
    
    TmpInteger = Read_Data(LBA, Lun, CBWDataTransferLength)
     
    If TmpInteger = 0 Then
        CBWTest_New_AU6390MB = 3     'Read fail
        Exit Function
    End If
     
    For i = 0 To CBWDataTransferLength - 1
    
        If ReadData(i) <> Pattern(i) Then
          CBWTest_New_AU6390MB = 3     'Read fail
          Exit Function
        End If
    
    Next
  
    ' another 2 flash R/W
  
   
    
    
    CBWTest_New_AU6390MB = 1
        
    
    End Function
Function AU6254_GetDevice(Lun As Byte, PreSlotStatus As Byte, Vid_PID As String) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim TmpString As String
Dim TmpInteger As Integer
Dim TimerCounter As Integer
Dim OldTimer
Dim CBWDataTransferLength As Long

   CBWDataTransferLength = 1024
 
'   For i = 0 To CBWDataTransferLength - 1
    
'         ReadData(i) = 0

'   Next

    If PreSlotStatus <> 1 Then
        AU6254_GetDevice = 4
        Exit Function
    End If
    '========================================
   
    AU6254_GetDevice = 0
    If LBA > 25 * 1024 Then
        LBA = 0
    End If
    '========================================
     TmpString = ""
    If ReaderExist = 0 Then
        Do
            DoEvents
            Call MsecDelay(0.1)
            TimerCounter = TimerCounter + 1
            TmpString = GetDeviceNameHub(Vid_PID)
        Loop While TmpString = "" And TimerCounter < 10
    End If
    '=======================================
    If ReaderExist = 0 And TmpString <> "" Then
      ReaderExist = 1
    End If
    '=======================================
    If ReaderExist = 0 And TmpString = "" Then
      AU6254_GetDevice = 0   ' no readerExist
      ReaderExist = 0
      Exit Function
    End If
    '=======================================
 
     
    AU6254_GetDevice = 1
        
    
    End Function


Function AU6375_GetDevice(Lun As Byte, PreSlotStatus As Byte, Vid_PID As String) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim TmpString As String
Dim TmpInteger As Integer
Dim TimerCounter As Integer
Dim OldTimer
Dim CBWDataTransferLength As Long

   CBWDataTransferLength = 1024
 
'   For i = 0 To CBWDataTransferLength - 1
    
'         ReadData(i) = 0

'   Next

    If PreSlotStatus <> 1 Then
        AU6375_GetDevice = 4
        Exit Function
    End If
    '========================================
   
    AU6375_GetDevice = 0
    If LBA > 25 * 1024 Then
        LBA = 0
    End If
    '========================================
     TmpString = ""
    If ReaderExist = 0 Then
        Do
            DoEvents
            Call MsecDelay(0.1)
            TimerCounter = TimerCounter + 1
            TmpString = GetDeviceName(Vid_PID)
        Loop While TmpString = "" And TimerCounter < 10
    End If
    '=======================================
    If ReaderExist = 0 And TmpString <> "" Then
      ReaderExist = 1
    End If
    '=======================================
    If ReaderExist = 0 And TmpString = "" Then
      AU6375_GetDevice = 0   ' no readerExist
      ReaderExist = 0
      Exit Function
    End If
    '=======================================
    If OpenPipe = 0 Then
      AU6375_GetDevice = 5   ' Write fail
      Exit Function
    End If
 
    '======================================
    
     ' for unitSpeed
    
    TmpInteger = TestUnitSpeed(Lun)
    
    If TmpInteger = 0 Then
        
       AU6375_GetDevice = 2   ' usb 2.0 high speed fail
       UsbSpeedTestResult = 2
       Exit Function
    End If
    
    
    '==== Rec mode
   '   TmpInteger = InquiryScSiString(0, 36, 1)
   '   TmpInteger = InquiryScSiString(1, 36, 1)
   '   TmpInteger = InquiryScSiString(2, 36, 1)
   '   TmpInteger = InquiryScSiString(3, 36, 1)
      
      
   If ChipName = "AU6375AS" Then
   TmpInteger = InquiryScSiString(0, 36, 0)
     If TmpInteger = 0 Then
        
        AU6375_GetDevice = 2   ' usb 2.0 high speed fail
        
       Exit Function
     End If
    
    
     TmpInteger = InquiryScSiString(1, 36, 0)
     If TmpInteger = 0 Then
        
        AU6375_GetDevice = 2   ' usb 2.0 high speed fail
        
       Exit Function
     End If
     
      TmpInteger = InquiryScSiString(2, 36, 0)
     If TmpInteger = 0 Then
        
        AU6375_GetDevice = 2   ' usb 2.0 high speed fail
        
       Exit Function
     End If
     
     
     TmpInteger = InquiryScSiString(3, 36, 0)
     If TmpInteger = 0 Then
        
        AU6375_GetDevice = 2   ' usb 2.0 high speed fail
        
       Exit Function
     End If
     
   End If
     
     
    AU6375_GetDevice = 1
        
    
    End Function
Function CBWTest_New_3130(Lun As Byte, PreSlotStatus As Byte, Vid_PID As String) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim TmpString As String
Dim TmpInteger As Integer
Dim TimerCounter As Integer
Dim OldTimer
Dim CBWDataTransferLength As Long

   CBWDataTransferLength = 1024
 
'   For i = 0 To CBWDataTransferLength - 1
    
'         ReadData(i) = 0

'   Next

    If PreSlotStatus <> 1 Then
        CBWTest_New_3130 = 4
        Exit Function
    End If
    '========================================
   
    CBWTest_New_3130 = 0
   
    '========================================
     TmpString = ""
    If ReaderExist = 0 Then
        Do
            DoEvents
            Call MsecDelay(0.1)
            TimerCounter = TimerCounter + 1
            TmpString = GetDeviceName(Vid_PID)
        Loop While TmpString = "" And TimerCounter < 10
    End If
    '=======================================
    If ReaderExist = 0 And TmpString <> "" Then
      ReaderExist = 1
    End If
    '=======================================
    If ReaderExist = 0 And TmpString = "" Then
      CBWTest_New_3130 = 0   ' no readerExist
      ReaderExist = 0
      Exit Function
    End If
    '=======================================
    If OpenPipe = 0 Then
      CBWTest_New_3130 = 2   ' Write fail
      Exit Function
    End If
 
    '======================================
    
     ' for unitSpeed
    
    TmpInteger = TestUnitSpeed(Lun)
    
    If TmpInteger = 0 Then
        
       CBWTest_New_3130 = 2   ' usb 2.0 high speed fail
       UsbSpeedTestResult = 2
       Exit Function
    End If
    
    
    
    TmpInteger = TestUnitReady(Lun)
    If TmpInteger = 0 Then
        TmpInteger = RequestSense(Lun)
        
        If TmpInteger = 0 Then
        
           CBWTest_New_3130 = 2  'Write fail
           Exit Function
        End If
        
    End If
    '======================================
   
    TmpInteger = Read_Data(LBA, Lun, CBWDataTransferLength)
      
    If TmpInteger = 0 Then
         CBWTest_New_3130 = 2  'write fail
          Exit Function
     End If
    
      
    TmpInteger = Write_Data(LBA, Lun, CBWDataTransferLength)
     
    If TmpInteger = 0 Then
        CBWTest_New_3130 = 2  'write fail
        Exit Function
    End If
    
    TmpInteger = Read_Data(LBA, Lun, CBWDataTransferLength)
     
    If TmpInteger = 0 Then
        CBWTest_New_3130 = 3    'Read fail
        Exit Function
    End If
     
    For i = 0 To CBWDataTransferLength - 1
    
        If ReadData(i) <> Pattern(i) Then
          CBWTest_New_3130 = 3    'Read fail
          Exit Function
        End If
    
    Next
    
    CBWTest_New_3130 = 1
        
    
    End Function

Function CBWTest_New_AU9254(Lun As Byte, PreSlotStatus As Byte, Vid_PID As String) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim TmpString As String
Dim TmpInteger As Integer
Dim TimerCounter As Integer
Dim OldTimer
Dim CBWDataTransferLength As Long

   CBWDataTransferLength = 1024
 
'   For i = 0 To CBWDataTransferLength - 1
    
'         ReadData(i) = 0

'   Next

    If PreSlotStatus <> 1 Then
        CBWTest_New_AU9254 = 4
        Exit Function
    End If
    '========================================
   
    CBWTest_New_AU9254 = 0
    If LBA > 25 * 1024 Then
        LBA = 0
    End If
    '========================================
     TmpString = ""
    If ReaderExist = 0 Then
        Do
            DoEvents
            Call MsecDelay(0.1)
            TimerCounter = TimerCounter + 1
            TmpString = GetDeviceNameMulti(Vid_PID)
        Loop While TmpString = "" And TimerCounter < 10
    End If
    '=======================================
    If ReaderExist = 0 And TmpString <> "" Then
      ReaderExist = 1
    End If
    '=======================================
    If ReaderExist = 0 And TmpString = "" Then
      CBWTest_New_AU9254 = 0   ' no readerExist
      ReaderExist = 0
      Exit Function
    End If
    
    
  '  If Vid_PID = "6335" Or Vid_PID = "9369" Or Vid_PID = "6331" Or Vid_PID = "9462" Then
  '     CBWTest_New_AU9254 = 1   ' usb 2.0 high speed fail
  '      Exit Function
  ' End If
    
    
       If Vid_PID = "9462" Then
        CBWTest_New_AU9254 = 1   ' usb 2.0 high speed fail
         Exit Function
   End If
    '=======================================
    If OpenPipe = 0 Then
      CBWTest_New_AU9254 = 2   ' Write fail
      Exit Function
    End If
 
    '======================================
    
    

    
     ' for unitSpeed
  If Vid_PID = "6335" Then
      TmpInteger = TestUnitSpeed(Lun)
    
      If TmpInteger = 0 Then
        
         CBWTest_New_AU9254 = 2   ' usb 2.0 high speed fail
         UsbSpeedTestResult = 2
          Exit Function
      End If
       CBWTest_New_AU9254 = 1
      Exit Function
    End If
    
   TmpInteger = TestUnitReady(Lun)
    If TmpInteger = 0 Then
        TmpInteger = RequestSense(Lun)
        
        If TmpInteger = 0 Then
        
           CBWTest_New_AU9254 = 2  'Write fail
          Exit Function
        End If
        
    End If

    '======================================
    If ChipName = "AU6371" Or Vid_PID = "0054" Then
        TmpInteger = Read_Data1(LBA, Lun, CBWDataTransferLength)
    End If
     TmpInteger = Read_Data(LBA, Lun, CBWDataTransferLength)
   ' TmpInteger = Read_Data1(Lba, Lun, CBWDataTransferLength)
    TmpInteger = Read_Data(LBA, Lun, CBWDataTransferLength)
      
    If TmpInteger = 0 Then
         CBWTest_New_AU9254 = 2  'write fail
           Exit Function
     End If
    
      
    TmpInteger = Write_Data(LBA, Lun, CBWDataTransferLength)
     
    If TmpInteger = 0 Then
        CBWTest_New_AU9254 = 2  'write fail
        Exit Function
    End If
    
    TmpInteger = Read_Data(LBA, Lun, CBWDataTransferLength)
     
    If TmpInteger = 0 Then
        CBWTest_New_AU9254 = 3    'Read fail
        Exit Function
    End If
     
    For i = 0 To CBWDataTransferLength - 1
    
        If ReadData(i) <> Pattern(i) Then
          CBWTest_New_AU9254 = 3    'Read fail
          Exit Function
        End If
    
    Next
    
  CBWTest_New_AU9254 = 1
        
    
    End Function

Function CBWTest_NewAU9331(Lun As Byte, PreSlotStatus As Byte, Vid_PID As String) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim TmpString As String
Dim TmpInteger As Integer
Dim TimerCounter As Integer
Dim OldTimer
Dim CBWDataTransferLength As Long

   CBWDataTransferLength = 1024
 
'   For i = 0 To CBWDataTransferLength - 1
    
'         ReadData(i) = 0

'   Next

    If PreSlotStatus <> 1 Then
        CBWTest_NewAU9331 = 4
        Exit Function
    End If
    '========================================
   
    CBWTest_NewAU9331 = 0
    If LBA > 25 * 1024 Then
        LBA = 0
    End If
    '========================================
     TmpString = ""
    If ReaderExist = 0 Then
        Do
            DoEvents
            Call MsecDelay(0.1)
            TimerCounter = TimerCounter + 1
            TmpString = GetDeviceName(Vid_PID)
        Loop While TmpString = "" And TimerCounter < 10
    End If
    '=======================================
    If ReaderExist = 0 And TmpString <> "" Then
      ReaderExist = 1
    End If
    '=======================================
    If ReaderExist = 0 And TmpString = "" Then
      CBWTest_NewAU9331 = 0   ' no readerExist
      ReaderExist = 0
      Exit Function
    End If
    '=======================================
    If OpenPipe = 0 Then
      CBWTest_NewAU9331 = 2   ' Write fail
      Exit Function
    End If
 
    '======================================
    
     ' for unitSpeed
    
     TmpInteger = TestUnitSpeed(Lun)
    
     If TmpInteger = 0 Then
        
        CBWTest_NewAU9331 = 2   ' usb 2.0 high speed fail
        UsbSpeedTestResult = 2
        Exit Function
     End If
    
    
    
    TmpInteger = TestUnitReady(Lun)
    If TmpInteger = 0 Then
        TmpInteger = RequestSense(Lun)
        
        If TmpInteger = 0 Then
        
           CBWTest_NewAU9331 = 2  'Write fail
           Exit Function
        End If
        
    End If
    '======================================
  '  If ChipName = "AU6371" Or ChipName = "AU6371S3" Then
  '      TmpInteger = Read_Data1(LBA, Lun, CBWDataTransferLength)
  '  End If
    TmpInteger = 0
    TmpInteger = Read_DataAU9331(LBA, Lun, CBWDataTransferLength)
     
    
    CBWTest_NewAU9331 = TmpInteger
        
    
    End Function
Function CBWTest_New(Lun As Byte, PreSlotStatus As Byte, Vid_PID As String) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim TmpString As String
Dim TmpInteger As Integer
Dim TimerCounter As Integer
Dim OldTimer
Dim CBWDataTransferLength As Long

   CBWDataTransferLength = 1024
 
'   For i = 0 To CBWDataTransferLength - 1
    
'         ReadData(i) = 0

'   Next

    If PreSlotStatus <> 1 Then
        CBWTest_New = 4
        Exit Function
    End If
    '========================================
   
    CBWTest_New = 0
    If LBA > 25 * 1024 Then
        LBA = 0
    End If
    '========================================
     TmpString = ""
    If ReaderExist = 0 Then
        Do
            DoEvents
            Call MsecDelay(0.1)
            TimerCounter = TimerCounter + 1
            TmpString = GetDeviceName(Vid_PID)
        Loop While TmpString = "" And TimerCounter < 10
    End If
    '=======================================
    If ReaderExist = 0 And TmpString <> "" Then
      ReaderExist = 1
    End If
    '=======================================
    If ReaderExist = 0 And TmpString = "" Then
      CBWTest_New = 0   ' no readerExist
      ReaderExist = 0
      Exit Function
    End If
    '=======================================
    If OpenPipe = 0 Then
      CBWTest_New = 2   ' Write fail
      Exit Function
    End If
 
    '======================================
    
     ' for unitSpeed
    
     TmpInteger = TestUnitSpeed(Lun)
    
     If TmpInteger = 0 Then
        
        CBWTest_New = 2   ' usb 2.0 high speed fail
        UsbSpeedTestResult = 2
        Exit Function
     End If
    
    
    
    TmpInteger = TestUnitReady(Lun)
    If TmpInteger = 0 Then
        TmpInteger = RequestSense(Lun)
        
        If TmpInteger = 0 Then
        
           CBWTest_New = 2  'Write fail
           Exit Function
        End If
        
    End If
    '======================================
  '  If ChipName = "AU6371" Or ChipName = "AU6371S3" Then
  '      TmpInteger = Read_Data1(LBA, Lun, CBWDataTransferLength)
  '  End If
    
    TmpInteger = Read_Data1(LBA, Lun, CBWDataTransferLength)
    TmpInteger = Read_Data(LBA, Lun, CBWDataTransferLength)
      
    If TmpInteger = 0 Then
         CBWTest_New = 2  'write fail
          Exit Function
     End If
    
      
    TmpInteger = Write_Data(LBA, Lun, CBWDataTransferLength)
     
    If TmpInteger = 0 Then
        CBWTest_New = 2  'write fail
        Exit Function
    End If
    
    TmpInteger = Read_Data(LBA, Lun, CBWDataTransferLength)
     
    If TmpInteger = 0 Then
        CBWTest_New = 3    'Read fail
        Exit Function
    End If
     
    For i = 0 To CBWDataTransferLength - 1
    
        If ReadData(i) <> Pattern(i) Then
          CBWTest_New = 3    'Read fail
          Exit Function
        End If
    
    Next
    
    CBWTest_New = 1
        
    
    End Function
Function CBWTransfer_8_Block() As Byte
On Error Resume Next
Dim i As Integer
Dim TransferLen As Long
Dim TransferLenLSB As Byte
Dim TransferLenMSB As Byte
Dim rv As Byte
Dim tmpV(0 To 2) As Long
'to test reader by vary different address, because the memory card are demaged very serious

'////////////// Define const

Const CBWSignature_0 = &H55
Const CBWSignature_1 = &H53
Const CBWSignature_2 = &H42
Const CBWSignature_3 = &H43


Const CBWTag_0 = &H1
Const CBWTag_1 = &H2
Const CBWTag_2 = &H3
Const CBWTag_3 = &H4

Dim CBWDataTransferLength As Long
CBWDataTransferLength = 4096

'LBA = &H20
'OPCode = &H2A
'Lun = 0
'CDBLen = 10
'CBWFlag = &H0


rv = 0
For i = 0 To CBWDataTransferLength - 1
TransData(i) = Pattern(i)
'Debug.Print TransData(i)
Next i

 

'///////////// parameter list


'/////////////////// CBW signature

CBW(0) = CBWSignature_0
CBW(1) = CBWSignature_1
CBW(2) = CBWSignature_2
CBW(3) = CBWSignature_3

'/////////////////  CBW Tag

CBW(4) = CBWTag_0
CBW(5) = CBWTag_1
CBW(6) = CBWTag_2
CBW(7) = CBWTag_3

'////////////////  CBW Data Transfer


CBWDataTransferLen(0) = (CBWDataTransferLength Mod 256)
tmpV(0) = Int(CBWDataTransferLength / 256)
CBWDataTransferLen(1) = (tmpV(0) Mod 256)
tmpV(1) = Int(tmpV(0) / 256)
CBWDataTransferLen(2) = (tmpV(1) Mod 256)
tmpV(2) = Int((tmpV(1) / 256))
CBWDataTransferLen(3) = (tmpV(2) Mod 256)

CBW(8) = CBWDataTransferLen(0)  '00
CBW(9) = CBWDataTransferLen(1)  '08
CBW(10) = CBWDataTransferLen(2) '00
CBW(11) = CBWDataTransferLen(3) '00

'///////////////  CBW Flag
CBW(12) = CBWFlag                '80

'////////////// LUN
CBW(13) = Lun                    '00

'///////////// CBD Len
CBW(14) = CDBLen                 '0a

'////////////  UFI command

CBW(15) = opcode
CBW(16) = Lun * 32

'///////////// LBA


LBAByte(0) = (LBA Mod 256)
tmpV(0) = Int(LBA / 256)
LBAByte(1) = (tmpV(0) Mod 256)
tmpV(1) = Int(tmpV(0) / 256)
LBAByte(2) = (tmpV(1) Mod 256)
tmpV(2) = Int((tmpV(1) / 256))
LBAByte(3) = (tmpV(2) Mod 256)

CBW(17) = LBAByte(3)         '00
CBW(18) = LBAByte(2)         '00
CBW(19) = LBAByte(1)         '00
CBW(20) = LBAByte(0)         '40

'/////////////  Reverve
CBW(21) = 0

'//////////// Transfer Len

TransferLen = Int(CBWDataTransferLength / 512)

TransferLenLSB = (TransferLen Mod 256)
tmpV(0) = Int(TransferLen / 256)
TransferLenMSB = (tmpV(0) / 256)

CBW(22) = TransferLenMSB      '00
CBW(23) = TransferLenLSB      '04

For i = 24 To 30
    CBW(i) = 0
Next

rv = ReaderTester2(CBW(0), TransData(0), CSW(0))


If rv = 0 Or CSW(12) = 1 Then
    CBWTransfer_8_Block = 0
Else
   
 CBWTransfer_8_Block = 1
   For i = 0 To CBWDataTransferLength - 1
   
        If TransData(i) <> Pattern(i) Then
        
         CBWTransfer_8_Block = 0
         Exit Function
        End If
   ' Debug.Print TransData(i)
   Next i

   
   

   
End If

End Function

Function CBWTransfer() As Byte
On Error Resume Next
Dim i As Integer
Dim TransferLen As Long
Dim TransferLenLSB As Byte
Dim TransferLenMSB As Byte
Dim rv As Byte
Dim tmpV(0 To 2) As Long
'to test reader by vary different address, because the memory card are demaged very serious

'////////////// Define const

Const CBWSignature_0 = &H55
Const CBWSignature_1 = &H53
Const CBWSignature_2 = &H42
Const CBWSignature_3 = &H43


Const CBWTag_0 = &H1
Const CBWTag_1 = &H2
Const CBWTag_2 = &H3
Const CBWTag_3 = &H4

Dim CBWDataTransferLength As Long
CBWDataTransferLength = 1024

'LBA = &H20
'OPCode = &H2A
'Lun = 0
'CDBLen = 10
'CBWFlag = &H0


rv = 0
For i = 0 To CBWDataTransferLength - 1
TransData(i) = Pattern(i)
'Debug.Print TransData(i)
Next i



'///////////// parameter list


'/////////////////// CBW signature

CBW(0) = CBWSignature_0
CBW(1) = CBWSignature_1
CBW(2) = CBWSignature_2
CBW(3) = CBWSignature_3

'/////////////////  CBW Tag

CBW(4) = CBWTag_0
CBW(5) = CBWTag_1
CBW(6) = CBWTag_2
CBW(7) = CBWTag_3

'////////////////  CBW Data Transfer


CBWDataTransferLen(0) = (CBWDataTransferLength Mod 256)
tmpV(0) = Int(CBWDataTransferLength / 256)
CBWDataTransferLen(1) = (tmpV(0) Mod 256)
tmpV(1) = Int(tmpV(0) / 256)
CBWDataTransferLen(2) = (tmpV(1) Mod 256)
tmpV(2) = Int((tmpV(1) / 256))
CBWDataTransferLen(3) = (tmpV(2) Mod 256)

CBW(8) = CBWDataTransferLen(0)  '00
CBW(9) = CBWDataTransferLen(1)  '08
CBW(10) = CBWDataTransferLen(2) '00
CBW(11) = CBWDataTransferLen(3) '00

'///////////////  CBW Flag
CBW(12) = CBWFlag                '80

'////////////// LUN
CBW(13) = Lun                    '00

'///////////// CBD Len
CBW(14) = CDBLen                 '0a

'////////////  UFI command

CBW(15) = opcode
CBW(16) = Lun * 32

'///////////// LBA


LBAByte(0) = (LBA Mod 256)
tmpV(0) = Int(LBA / 256)
LBAByte(1) = (tmpV(0) Mod 256)
tmpV(1) = Int(tmpV(0) / 256)
LBAByte(2) = (tmpV(1) Mod 256)
tmpV(2) = Int((tmpV(1) / 256))
LBAByte(3) = (tmpV(2) Mod 256)

CBW(17) = LBAByte(3)         '00
CBW(18) = LBAByte(2)         '00
CBW(19) = LBAByte(1)         '00
CBW(20) = LBAByte(0)         '40

'/////////////  Reverve
CBW(21) = 0

'//////////// Transfer Len

TransferLen = Int(CBWDataTransferLength / 512)

TransferLenLSB = (TransferLen Mod 256)
tmpV(0) = Int(TransferLen / 256)
TransferLenMSB = (tmpV(0) / 256)

CBW(22) = TransferLenMSB      '00
CBW(23) = TransferLenLSB      '04

For i = 24 To 30
    CBW(i) = 0
Next

CBWTransfer = 0
rv = ReaderTester(CBW(0), TransData(0), CSW(0))


If rv = 0 Then       ' unknow device
    CBWTransfer = 0
    Exit Function
End If

If rv = 2 Or CSW(12) = 1 Then   ' fail
    CBWTransfer = 2
Else
   
CBWTransfer = 1
   For i = 0 To CBWDataTransferLength - 1
   
        If TransData(i) <> Pattern(i) Then
        
         CBWTransfer = 2  'fail
         Exit Function
        End If
   ' Debug.Print TransData(i)
   Next i
  
End If

End Function
Function CBWTest_8_Block(LunNo As Byte, PreSlotStatus As Byte, FailPosition As Integer, Times As Integer) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim ReadTest As Integer
Dim TmpLBA As Integer

If PreSlotStatus <> 1 Then
    CBWTest_8_Block = 4
    Exit Function
End If
 
WriteTest = 1
ReadTest = 1
 
FailPosition = 0
 
If LBA > 25 * 1024 Then
LBA = 0
End If

'// same as test unit ready
opcode = &H28
Lun = LunNo
CDBLen = 10
CBWFlag = &H80


'CBWTransfer   ' 2 block transfer

If CBWTransfer = 0 Then
  CBWTest_8_Block = 0
 Exit Function
End If



TmpLBA = LBA
'/// Write test
If WriteTest = 1 Then

 For i = 1 To Times
   
    opcode = &H2A
    CDBLen = 10
    CBWFlag = &H0
       If CBWTransfer_8_Block <> 0 Then
       
          CBWTest_8_Block = 2
          FailPosition = i
          Exit Function
        End If
     LBA = LBA + 8
   Next i
     
End If
 
LBA = TmpLBA
If ReadTest = 1 Then

  For i = 1 To Times
    opcode = &H28
    CDBLen = 10
    CBWFlag = &H80
    
          If CBWTransfer_8_Block <> 0 Then
             FailPosition = i
            CBWTest_8_Block = 3
          Exit Function
        End If
        LBA = LBA + 8
   Next i
   
 End If
    

CBWTest_8_Block = 1
    

End Function
Function CBWTest(LunNo As Byte, PreSlotStatus As Byte) As Byte
Dim i As Integer
Dim WriteTest As Integer

CBWTest = 0
If PreSlotStatus <> 1 Then
    CBWTest = 4
    Exit Function
End If


If LBA > 25 * 1024 Then
LBA = 0
End If

' set read command
opcode = &H28
Lun = LunNo
CDBLen = 10
CBWFlag = &H80

WriteTest = 1
 

If CBWTransfer = 0 Then
  CBWTest = 0
 Exit Function
End If


'/// Write test
If WriteTest = 1 Then

   'LBA = &H0 + i * 6
    opcode = &H2A
   'Lun = i
    CDBLen = 10
    CBWFlag = &H0
    
    If CBWTransfer <> 1 Then
       'Debug.Print "fail1", Hex(OPCode), Hex(LBA)
        
       If CBWTransfer <> 1 Then
         'Debug.Print "fail2", Hex(OPCode), Hex(LBA)
          CBWTest = 2
          Exit Function
        End If
      
     End If
End If
'/// read test
'LBA = &H0 + i * 6
opcode = &H28
'Lun = i
CDBLen = 10
CBWFlag = &H80
    
    If CBWTransfer <> 1 Then
    'Debug.Print "fail1", Hex(OPCode), Hex(LBA)
    
          If CBWTransfer <> 1 Then
            'Debug.Print "fail2", Hex(OPCode), Hex(LBA)
             CBWTest = 3
             Exit Function
          End If
     
  
    End If
    
   CBWTest = 1
    

End Function

Function ErrCode(ByRef v1 As Byte) As String

Select Case v1

Case &H1A
      ErrCode = "FAIL_LBA_BASE"
      
Case &H19
      ErrCode = "FAIL_READ_ORIGINAL_CAPACITY"
      
Case &H18
      ErrCode = "FAIL_SCSI_READTOC"
      
Case &H17
      ErrCode = "FAIL_SCSI_PLAYAUD10"
      
Case &H16
      ErrCode = "FAIL_LOW_LEVEL_FORMAT"
      
Case &H15
      ErrCode = "FAIL_BAD_BLOCK"
      
Case &H14
      ErrCode = "FAIL_WRITE_PROTECT"
      
Case &H13
      ErrCode = "FAIL_ANSWER_PASSWORD"
      
Case &H12
      ErrCode = "FAIL_MAP"
      
Case &H11
      ErrCode = "FAIL_RESERVED_COMPARE"
      
Case &H10
      ErrCode = "FAIL_RESERVED_READ"
      
Case &HF
      ErrCode = "FAIL_RESERVED_WRITE"
      
Case &HE
      ErrCode = "FAIL_CROSS_COMPARE"
      
Case &HD
      ErrCode = "FAIL_CROSS_READ"
      
Case &HC
      ErrCode = "FAIL_CROSS_WRITE"
      
Case &HB
      ErrCode = "FAIL_GET_CHIP_ID"
      
Case &HA
      ErrCode = "FAIL_GENERAL_COMPARE"
      
Case &H9
      ErrCode = "FAIL_GENERAL_READ"
      
Case &H8
      ErrCode = "FAIL_GENERAL_WRITE"
      
Case &H7
      ErrCode = "FAIL_PID_VID_COMAPRE"
      
      
Case &H6
      ErrCode = "FAIL_PID_VID_WRITE"
      
      
Case &H5
      ErrCode = "FAIL_PID_VID_READ"
      
      
Case &H4
      ErrCode = "FAIL_EXECUTE_TIMEOUT"
      
      
Case &H3
      ErrCode = "FAIL_HANDLE_INVALID"
      
      
Case &H2
      ErrCode = "FAIL_DEVICE_INVALID"
      
      
Case &H1
      ErrCode = "FAIL_FLASH_INVISIBLE"
      
      
Case &H0
      ErrCode = "PASS"
      
  

End Select


End Function



Private Sub Command2_Click()
Dim rv3, rv2
 ReaderExist = 0
 ClosePipe6331
                  rv2 = CBWTest_New6331(0, 1, "6331")
                ClosePipe6331
           
           
   ReaderExist = 0
 ClosePipe9369
                rv3 = CBWTest_New9369(0, 1, "9369")
                ClosePipe9369
              
Print rv2
Print rv3
End Sub



Private Sub Command4_Click()
End
End Sub



Private Sub Command8_Click()

'TableShow.Show
End Sub

 

Private Sub Form_Load()
Dim i As Integer
Dim tmp0 As Integer
Dim tmp1 As Integer

Dim tmp2 As Integer

Dim tmp3 As Integer

Dim tmp4 As Integer




MSComm1.CommPort = 1
MSComm1.Settings = "9600,N,8,1"
MSComm1.PortOpen = True

MSComm1.InBufferCount = 0
MSComm1.InputLen = 0
'MSComm1.DTREnable = True
'MSComm1.RTSEnable = True

MSComm2.CommPort = 2
MSComm2.Settings = "9600,N,8,1"
'MSComm2.PortOpen = True
Call ReadTable  '------------ for AU6375 test
Open App.Path & "\Pattern.txt" For Input As #2

    Do While Not EOF(2)
    
        Input #2, Pattern(i)
        i = i + 1
    Loop

Close #2
 
Open App.Path & "\MP3.txt" For Input As #3
Open App.Path & "\MP31.txt" For Input As #4
Open App.Path & "\MP32.txt" For Input As #5
Open App.Path & "\MP33.txt" For Input As #6
Open App.Path & "\MP34.txt" For Input As #7




   For i = 0 To 99
    
        Input #3, tmp0
        Input #4, tmp1
        Input #5, tmp2
        Input #6, tmp3
        Input #7, tmp4
        MP3Data(i) = CInt((CSng(tmp0) + CSng(tmp1) + CSng(tmp2) + CSng(tmp3) + CSng(tmp4)) * 0.2)
         
   Next i

Close #3
Close #4
Close #5
Close #6
Close #7


 
 
Open App.Path & "\SCSI0.txt" For Input As #3
Open App.Path & "\SCSI1.txt" For Input As #4
Open App.Path & "\SCSI2.txt" For Input As #5
Open App.Path & "\SCSI3.txt" For Input As #6




   For i = 0 To 35
    
        Input #3, InquiryString(0, i)
        Input #4, InquiryString(1, i)
        Input #5, InquiryString(2, i)
        Input #6, InquiryString(3, i)
      
   Next i

Close #3
Close #4
Close #5
Close #6
 
 
 


Dim lngResult As Long

    bReadyToClose = False
    bCurSlotNum = 0
    strAppPath = App.Path
    
    If (Right(strAppPath, 1) <> "\") Then
        strAppPath = strAppPath & "\"
    End If

    ' Connect to the smartcard resource manager
    lngResult = SCardEstablishContext(SCARD_SCOPE_SYSTEM, lngNull, lngNull, lngContext)
    
     If (lngResult <> 0) Then
     '    MsgBox ("SCardEstablishContext Failed")
     '     GoTo Error_Exit
      End If

    
    IsReaderLost = True
    lngResult = ConnectAlcorReader
   

    
  



Exit Sub

Error_Exit:
End


End Sub

Private Sub Form_Activate()
Call Command1_Click
End Sub
Private Sub Command1_Click()
On Error Resume Next
Const AllenTest = 0
Dim i As Integer

Dim TestCounter As Integer
Dim OldTimer
Dim receivestart As String
Dim goodchip As Long
Dim failchip As Long
Dim failchipBin2 As Long 'arch add 940411
Dim failchipBin3 As Long 'arch add 940411
Dim failchipBin4 As Long 'arch add 940411
Dim failchipBin5 As Long 'arch add 940411
Dim Endmsg As String


Dim DirName As String
Dim LogFile As String
Dim Counter As Integer
Dim f1 As String
Dim f2 As String
Dim v1 As Byte
Dim v2 As Byte
Dim v3 As Byte
Dim OldLba As Long



Dim rv As Byte
Dim rv0 As Byte
Dim rv1 As Byte
Dim rv2 As Byte
Dim rv3 As Byte
Dim rv4 As Byte
Dim rv5 As Byte
Dim rv6 As Byte
Dim rv7 As Byte

Dim AllChip As String
Dim OldChipName As String
 
Dim oldtime
Dim FailPosition As Integer

'Const UNKNOW_DEVICE = 0


Dim TesterReadyCounter As Integer

Dim OldTestResult As String
Dim buf

Const Ver = " v1.35"
'//////////////// need modify

AllChip = "AU6330"
AllChip = AllChip & "AU6331"
AllChip = AllChip & "AU6333"
AllChip = AllChip & "AU6363"
AllChip = AllChip & "AU6366"
AllChip = AllChip & "AU6367"
AllChip = AllChip & "AU6368"
AllChip = AllChip & "AU6369_1"
AllChip = AllChip & "AU6369_2"
AllChip = AllChip & "AU6369S2"
AllChip = AllChip & "AU6369S3"
AllChip = AllChip & "AU6375"
AllChip = AllChip & "AU6384"
AllChip = AllChip & "AU6385"
AllChip = AllChip & "AU6386"
AllChip = AllChip & "AU6386_D"
AllChip = AllChip & "AU6390"
AllChip = AllChip & "AU9368"
AllChip = AllChip & "AU9369S3"
AllChip = AllChip & "AU9368_1"
AllChip = AllChip & "AU9368_S"
AllChip = AllChip & "AU9510"
AllChip = AllChip & "AU9520"
AllChip = AllChip & "AU9720"


'\\\\\\\\\\\\\\\\\\\\\\\\\\\
' initial software labeling
'\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
Label17.Caption = "UNKNOW DEVICE"
Label18.Caption = "NO DEFINE"
Label19.Caption = "NO DEFINE"
Label20.Caption = "NO DEFINE"

Label21.Caption = "SD WRITE FAIL"
Label22.Caption = "SD READ FAIL"
Label23.Caption = "CF WRITE FAIL"
Label24.Caption = "CF READ FAIL"

Label25.Caption = "XD WRITE FAIL"
Label26.Caption = "XD READ FAIL"
Label27.Caption = "NO DEFINE"
Label28.Caption = "NO DEFINE"

Label29.Caption = "MS WRITE FAIL"
Label30.Caption = "MS READ FAIL"
Label31.Caption = "NO DEFINE"
Label32.Caption = "NO DEFINE"






Label12 = "Testing...."

Label12.BackColor = &H8080FF
Do
    
     OldChipName = ""
     ChipName = ""
     DoEvents
     UsbSpeedTestResult = 0
     FlashCapacityError = 0
     GPOFail = 0
     rv0 = 0
     rv1 = 0
     rv2 = 0
     rv3 = 0
     rv4 = 0
     rv5 = 0
     rv6 = 0
     rv7 = 0
     
    
    
         
    '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
    '
    ' Wait for begin Test command
    '
    '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
        ChipName = ""
        
         'Do
            '   MSComm1.Output = "Ready"
            '   TesterReadyCounter = TesterReadyCounter + 1
               'Print TesterReadyCounter
             '  DoEvents
             '  Call MsecDelay(0.1) ' comm time
             '  ChipName = MSComm1.Input
             ' fnScsi2usb2K_KillEXE ' clear removable device message box
              ' ChipName = "AU9368_1"
        ' Loop Until ChipName <> ""
         
         
        
         MSComm1.InBufferCount = 0
         MSComm1.OutBufferCount = 0
        Print "wait host comannd"
             
         Do
               
           
               MSComm1.Output = "Ready"
               Call MsecDelay(0.01)
               
               DoEvents
     
     
               buf = MSComm1.Input
               ChipName = ChipName & buf
              fnScsi2usb2K_KillEXE ' clear removable device message box
            '   ChipName = "AU6254"
         Loop Until InStr(1, ChipName, "AU") <> 0
          
          
          
          
          ReaderExist = 0
          ChipName = Right(ChipName, Len(ChipName) - InStr(1, ChipName, "AU") + 1)
         
          Cls
          
           Label1.Caption = ChipName & " Tester" & Ver
           Print "Get Host Command"
        '///////////////////////////////
        '
        '  Begin Test
        '
        '///////////////////////////////
         
         '=====  Initial all HMI interface
         
         TestResult = "FAIL"
         Label9 = ""
         Label3.BackColor = RGB(255, 255, 255)
         Label4.BackColor = RGB(255, 255, 255)
         Label5.BackColor = RGB(255, 255, 255)
         Label6.BackColor = RGB(255, 255, 255)
         Label7.BackColor = RGB(255, 255, 255)
         Label8.BackColor = RGB(255, 255, 255)
         
         
        '======= Test loop
         
         
         
         
         
        Print "Begin Test"
                
        oldtime = Timer
        Select Case ChipName
        
        
           Case "AU9368_B"
        
             LBA = LBA + 1
                
                OldLba = LBA
               
                FailPosition = 11
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(0, rv0, 1)
                ClosePipe
                rv1 = CBWTest_New(1, rv0, "vid_058f")
                Call LabelMenu(1, rv1, rv0)
                ClosePipe
                rv2 = CBWTest_New(2, rv1, "vid_058f")
                Call LabelMenu(2, rv2, rv1)
                ClosePipe
               
                rv3 = CBWTest_New_ALPS(2, rv2, "vid_058f")
                 ClosePipe
                   LBA = OldLba
                 If rv3 = 1 Then
                    FailPosition = 12
                   LBA = LBA + CLng(80000)
                  rv3 = CBWTest_New_ALPS(2, rv2, "vid_058f")
                   ClosePipe
                 End If
                  LBA = OldLba + 1
                 If rv3 = 1 Then
                   FailPosition = 13
                  LBA = LBA + CLng(160000)
                  rv3 = CBWTest_New_ALPS(2, rv2, "vid_058f")
                   ClosePipe
                End If
                
                If rv3 = 1 Then
                rv3 = CBWTest_New(3, rv2, "vid_058f")
                 ClosePipe
                End If
                
                LBA = OldLba
                Call LabelMenu(3, rv3, rv2)
                ClosePipe
                
                
                
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv1, " \\CF :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv2, " \\XD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv3, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                Print "FailPosition="; FailPosition
                
                'If rv0 = 1 And rv1 = 1 And rv2 = 1 And rv3 = 1 Then
                   ' TestResult = "PASS"
                'End If
                
                
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv1 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                 ElseIf rv3 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv3 * rv2 * rv1 * rv0 = PASS Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                  
                End If
        
          Case "AU9331"
        
           Call AU9331Test(rv0, rv1, rv2, rv3, rv4)
                 
                
           
           Case "AU6254"
        
           Call AU6254Test(rv0, rv1, rv2, rv3, rv4)
                Print " test hub disconnect -------"
               ' CardResult = DO_WritePort(card, Channel_P1A, &HFF)
                
                
           
                
                Print "rv0="; rv0
                Print "rv1="; rv1
                Print "rv2="; rv2
                Print "rv3="; rv3
                Print "rv4="; rv4
                 
                  
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                 ElseIf rv1 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv3 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv3 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                 ElseIf rv4 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv4 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv0 * rv1 * rv2 * rv3 * rv4 = 1 Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                  
                End If
                  
                  
                Call LabelMenu(0, rv0, 1)
                Call LabelMenu(1, rv1, rv0)
                Call LabelMenu(2, rv3, rv1)
                Call LabelMenu(3, rv4, rv3)
                
        
           Case "AU3130"
           
                If PCI7248InitFinish = 0 Then
                  PCI7248Exist
                End If
                
                
                 '=========================================
                '    POWER on
                '=========================================
                 CardResult = DO_WritePort(card, Channel_P1A, &H80)
                 
                 If CardResult <> 0 Then
                    MsgBox "Power off fail"
                    End
                 End If
                 
                 Call MsecDelay(0.05)
                 CardResult = DO_WritePort(card, Channel_P1A, &H2F)   ' usb Power Off
                
                 Call MsecDelay(0.8)    'power on time
                 
                  If CardResult <> 0 Then
                    MsgBox "Power on fail"
                    End
                 End If
                 
                
                
                ClosePipe
                LBA = LBA + 1
                OldLba = LBA
                LBA = LBA + 20000 ' 20000 mp3 shift
                rv0 = CBWTest_New_3130(0, 1, "vid_058f")
               
                
                
                LBA = OldLba
                'Print "a1"
                Call LabelMenu(0, rv0, 1)
                ClosePipe
                 
                 
                If rv0 = 1 Then
                              CardResult = DO_WritePort(card, Channel_P1A, &H8F)
                             
                             If CardResult <> 0 Then
                                MsgBox "Power off fail"
                                End
                             End If
                            ' mp3==================================================
                             Call MsecDelay(0.5)
                             
                             CardResult = DO_WritePort(card, Channel_P1A, &H9F)   ' MP3 Power Off
                               
                             Call MsecDelay(4)    'power on time and DAC initial time
                             
                             
                             CardResult = DO_WritePort(card, Channel_P1A, &H8F)   ' MP3 Power Off
                            
                           '  Call MsecDelay(3)    'play
                             
                              If CardResult <> 0 Then
                                MsgBox "Power on fail"
                                End
                             End If
                             
                    rv2 = AU3130Test
                  Else
                   rv2 = 4
                 End If
                 
                 Call LabelMenu(2, rv2, rv0)
                 
                  
                 ' Call MsecDelay(2)
                 
              '      Open App.Path & "\MP3.txt" For Output As #4

               '      For i = 0 To 100
                '    Print #4, gnBuffer(i)
                 '    Next i
                  

                  '  Close #4


                
                  
                '  dma2205.Hide
                 
                  
                  
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                 ElseIf rv1 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                 ElseIf rv3 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv0 * rv2 = 1 Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                  
                End If
           
           
           Case "AU9520V5", "AU9520_1", "AU9520V4"
           
                  Cls
                  If ChipName = "AU9520V4" Then
                  Print "====== 4.2  V test"
                  Call PowerSet(42)
                  Else
                   Print "====== 5.0 V test"
                  Call PowerSet(50)
                  
                  End If
                  
                 
                  rv0 = AU9520_2Slot
                 
                 Call LabelMenu(0, rv0, 1)
                 
                 If ChipName = "AU9520V5" Or ChipName = "AU9520V4" Then
                        If rv0 = 1 Then
                              If ChipName = "AU9520V4" Then
                                Call PowerSet(42)
                                Else
                                Call PowerSet(50)
                               End If
                  
                            rv2 = AU9520JJMode
                         
                        End If
                        Call LabelMenu(2, rv2, rv0)
                  Else
                       rv2 = 1
                        
                  End If
                 
              
                
               
                 
                 
                 If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv1 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                 ElseIf rv3 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv0 * rv2 = 1 Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                  
                End If
            Case "AU661048"
           
                If PCI7248InitFinish = 0 Then
                  PCI7248Exist
                End If
                
                
                 '=========================================
                '    POWER on
                '=========================================
                 CardResult = DO_WritePort(card, Channel_P1A, &HFF)
                 
                 If CardResult <> 0 Then
                    MsgBox "Power off fail"
                    End
                 End If
                 
                 Call MsecDelay(0.05)
                 CardResult = DO_WritePort(card, Channel_P1A, &H0)   'Power Enable
                
                 Call MsecDelay(1.2)    'power on time
                 
                  If CardResult <> 0 Then
                    MsgBox "Power on fail"
                    End
                 End If
           
           
                 rv0 = AU6610Test
                 
               
                 If rv0 = 1 Then
                   rv1 = 1
                   Call MsecDelay(0.2)    'power on time
                   rv2 = AU6610TestRC
                   
                  If rv2 = 0 Then  ' IR function fail
                     rv2 = 2
                   End If
                
               
                 ElseIf rv0 = 4 Then  ' speed error
        
                    rv1 = 2
                    rv2 = 4
                    
                  ElseIf rv0 = 0 Then  ' unknoew device
                  
                     rv1 = 4
                    rv2 = 4
                  
                 End If
                 
                 
                
                 
                 
                 
                 Print "rv0="; rv0
                 
                Print "rv1="; rv1
                 Print "rv2="; rv2
                Call LabelMenu(0, rv0, 1)
                Call LabelMenu(1, rv1, rv0)
                Call LabelMenu(2, rv2, rv1)
                   
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv1 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                 ElseIf rv3 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv0 * rv1 * rv2 = 1 Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                  
                End If
                 
                             
                
        
        
           Case "AU6610"
           
                If PCI7248InitFinish = 0 Then
                  PCI7248Exist
                End If
                
                
                 '=========================================
                '    POWER on
                '=========================================
                 CardResult = DO_WritePort(card, Channel_P1A, &HFF)
                 
                 If CardResult <> 0 Then
                    MsgBox "Power off fail"
                    End
                 End If
                 
                 Call MsecDelay(0.05)
                 CardResult = DO_WritePort(card, Channel_P1A, &H0)   'Power Enable
                
                 Call MsecDelay(1.2)    'power on time
                 
                  If CardResult <> 0 Then
                    MsgBox "Power on fail"
                    End
                 End If
           
           
                 rv0 = AU6610Test
                 
               
                 If rv0 = 1 Then
                 rv1 = 1
                  
                 ElseIf rv0 = 4 Then
        
                    rv1 = 2
                    rv0 = 1
             
                 End If
                 
                 Print "rv0="; rv0
                 
                Print "rv1="; rv1
                
                Call LabelMenu(0, rv0, 1)
                Call LabelMenu(1, rv1, rv0)
                   
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv1 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                 ElseIf rv3 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv0 * rv1 = 1 Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                  
                End If
                 
                 
                 
                 
           Case "AU6980MB", "AU6982IL"
           
                If PCI7248InitFinish = 0 Then
                  PCI7248Exist
                End If
                
                
                 '=========================================
                '    POWER on
                '=========================================
                 CardResult = DO_WritePort(card, Channel_P1A, &HFF)
                 
                 If CardResult <> 0 Then
                    MsgBox "Power off fail"
                    End
                 End If
                 
                 Call MsecDelay(0.05)
                 CardResult = DO_WritePort(card, Channel_P1A, &H0)  'Power Enable
                 Call MsecDelay(1.8)    'power on time
                 
                  If CardResult <> 0 Then
                    MsgBox "Power on fail"
                    End
                 End If
                 
           
                 
               LBA = LBA + 1   ' for dual channel
               
               Print LBA
               
                ClosePipe
                
                rv0 = CBWTest_New_AU6390MB(0, 1, "vid_058f", 0)
                 Call LabelMenu(0, rv0, 1)
                ClosePipe
                rv1 = CBWTest_New_AU6390MB(0, rv0, "vid_058f", 1)
                Call LabelMenu(1, rv1, rv0)
                 ClosePipe
                  OldLba = LBA
                  
                  LBA = LBA + 4079614 'org= 3932160=7C7FFD*0.5
                  LBA = LBA + 65535
                 ClosePipe
                 rv2 = CBWTest_New_AU6390MB(0, rv1, "vid_058f", 2)
                 ClosePipe
                Call LabelMenu(2, rv2, rv1)
                
                '============ AU6982IL  the second 2 MBG Flash begin ==========
                If ChipName = "AU6982IL" And rv2 = 1 Then
                
                    LBA = LBA + 4079614 'org= 3932160=7C7FFD*0.5
                    LBA = LBA + 65535
                   ClosePipe
                   rv2 = CBWTest_New_AU6390MB(0, rv1, "vid_058f", 2)
                   ClosePipe
                   Call LabelMenu(2, rv2, rv1)
                End If
                
                 If ChipName = "AU6982IL" And rv2 = 1 Then
                
                    LBA = LBA + 4079614 'org= 3932160=7C7FFD*0.5
                    LBA = LBA + 65535
                    ClosePipe
                   rv2 = CBWTest_New_AU6390MB(0, rv1, "vid_058f", 2)
                   ClosePipe
                   Call LabelMenu(2, rv2, rv1)
                End If
                 '============ AU6982IL  the second 2 MBG Flash begin ==========
                
                 LBA = OldLba
                
                ClosePipe
                
                 LightON = 0
                 CardResult = DO_ReadPort(card, Channel_P1B, LightON)
                  
                   If CardResult <> 0 Then
                    MsgBox "Read card detect light ON fail"
                    End
                   End If
                   
                   
                 If ChipName = "AU6980MB" Then
                       If rv2 = 1 Then
                          If LightON = 223 Then
                             rv3 = 1
                           Else
                             GPOFail = 2
                             rv3 = 2
                          End If
                       Else
                            rv3 = 4
        
                       End If
                End If
                 
                 
                   If ChipName = "AU6982IL" Then
                       If rv2 = 1 Then
                          If LightON = 254 Then
                             rv3 = 1
                           Else
                             GPOFail = 2
                             rv3 = 2
                          End If
                       Else
                            rv3 = 4
        
                       End If
                End If
                 
                 
                  Call LabelMenu(32, rv3, rv2)
                 
                     
                   CardResult = DO_WritePort(card, Channel_P1A, &HFF)
                 
                 If CardResult <> 0 Then
                    MsgBox "Power off fail"
                    End
                 End If
                  
                  
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv1 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                 ElseIf rv3 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv0 * rv1 * rv2 * rv3 = 1 Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                  
                End If
               
        
        
           
     
                
            
            Case "AU9520JJ"
            
                If PCI7248InitFinish = 0 Then
                  PCI7248Exist
                End If
                
                
                 '=========================================
                '    POWER on
                '=========================================
                 CardResult = DO_WritePort(card, Channel_P1CL, &HF)
                 
                 If CardResult <> 0 Then
                    MsgBox "Power off fail"
                    End
                 End If
                 
                 Call MsecDelay(0.05)
                 CardResult = DO_WritePort(card, Channel_P1CL, &HB)  'Power Enable
                 Call MsecDelay(0.8)    'power on time
                 
                  If CardResult <> 0 Then
                    MsgBox "Power on fail"
                    End
                 End If
                 
                 
                 '===========================================
                 'NO card test
                 '============================================
                   CardResult = DO_ReadPort(card, Channel_P1CH, LightOFF)
                  
                   If CardResult <> 0 Then
                    MsgBox "Read card detect light off fail"
                    End
                   End If
                   
                  
                   
                 
                '===========================================
                 'NO card test
                 '============================================
                  CardResult = DO_WritePort(card, Channel_P1CL, &HA)  'Power Enable + Slot0 enable
                   If CardResult <> 0 Then
                    MsgBox "Set card detect light on fail"
                    End
                   End If
                   Call MsecDelay(0.05)
                    CardResult = DO_ReadPort(card, Channel_P1CH, LightON)
                  
                   If CardResult <> 0 Then
                    MsgBox "Read light on fail"
                    End
                   End If
                   
                   
                  
                '===========================================
                 'R/W test
                 '============================================
                  
                If LightOFF <> 14 Or LightON <> 12 Then
                  TestResult = "Bin2"
                Else
            
                        PreviousStatus = 0
                        TestResultadd = "FAIL"
                        TestResultSmartCard = "FAIL" 'arch add 0321
                        ArchTest = False             'arch add 0321
                        Cls
                        
                        strReaderName = VenderString_AU9520JJ & " " & ProductString_AU9520JJ & " 0"   'slot 0
                        udtReaderStates(0).szReader = strReaderName & vbNullChar
                        txtmsg.Text = udtReaderStates(0).szReader
                        Print "Start to test slot0!"
                        Call StartTest
                        
                        If TestResultadd = "PASS" Then 'Arch define 940410
                       ' Call LabelMenu(5, 1, 1)
                            TestResult = "PASS"
                        Else
                            'TestResult = "FAIL"
                            TestResult = "Bin2"
                        End If
                End If
          
           Case "AU6366C", "AU6371", "AU6371S3", "AU6371EL"
            
                Dim ChipString As String
                
                Dim AU6371EL_SD As Byte
                Dim AU6371EL_CF As Byte
                Dim AU6371EL_XD As Byte
                Dim AU6371EL_MS As Byte
                Dim AU6371EL_MSP  As Byte
                Dim AU6371EL_BootTime As Single
                
                If ChipName = "AU6371S3" Then
                  ChipString = "vid_8751"
                Else
                  ChipString = "vid_058f"
                End If
                
                If ChipName = "AU6371EL" Then
                    AU6371EL_SD = 1
                    AU6371EL_CF = 2
                    AU6371EL_XD = 8
                    AU6371EL_MS = 32
                    AU6371EL_MSP = 64
                    AU6371EL_BootTime = 1.2
                 Else
                    AU6371EL_SD = 0
                    AU6371EL_CF = 0
                    AU6371EL_XD = 0
                    AU6371EL_MS = 0
                    AU6371EL_MSP = 0
                    AU6371EL_BootTime = 0
                End If
            
               If PCI7248InitFinish = 0 Then
                  PCI7248Exist
               End If
               
               ' result = DIO_PortConfig(card, Channel_P1B, OUTPUT_PORT)
               '  CardResult = DO_WritePort(card, Channel_P1B, &H0)
                
                LBA = LBA + 1
                         
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                rv4 = 0
                rv5 = 0
                rv6 = 0
                rv7 = 0
             
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                
                '=========================================
                '    POWER on
                '=========================================
                 CardResult = DO_WritePort(card, Channel_P1A, &HFF)
                    If CardResult <> 0 Then
                    MsgBox "Power off fail"
                    End
                 End If
                 Call MsecDelay(0.05)
                 
                 CardResult = DO_WritePort(card, Channel_P1A, &H7F - AU6371EL_SD)
                  
                 Call MsecDelay(1.2 + AU6371EL_BootTime)  'power on time
                 
                '===============================================
                '  SD Card test
                '================================================
                 
                
                  
                  
                 If CardResult <> 0 Then
                    MsgBox "Set SD Card Detect On Fail"
                    End
                 End If
                 
                   Call MsecDelay(0.01)
                 '===========================================
                 'NO card test
                 '============================================
                  
                  
                    CardResult = DO_ReadPort(card, Channel_P1B, LightOFF)
                  
                   If CardResult <> 0 Then
                    MsgBox "Read light off fail"
                    End
                   End If
                   
                   
                
                     ' set SD card detect down
                      CardResult = DO_WritePort(card, Channel_P1A, &H7E)
                      
                     If CardResult <> 0 Then
                        MsgBox "Set SD Card Detect Down Fail"
                        End
                     End If
                     Call MsecDelay(0.01)
                     
                     CardResult = DO_ReadPort(card, Channel_P1B, LightON)
                      If CardResult <> 0 Then
                          MsgBox "Read light On fail"
                          End
                      End If
                     
                     
                             
                           
                      ClosePipe
                      
                      
                      rv0 = CBWTest_New(0, 1, ChipString)
                            
                            
                      If rv0 <> 0 Then
                        If LightON <> &HBF Or LightOFF <> &HFF Then
                                  
                        UsbSpeedTestResult = GPO_FAIL
                                
                        End If
                      End If
                        
                     Call LabelMenu(0, rv0, 1)   ' no card test fail
                   
                 Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                ' allen debug
                '===============================================
                '  CF Card test
                '================================================
                If ChipName <> "AU6371S3" Then
                  CardResult = DO_WritePort(card, Channel_P1A, &H7F)
                  
                  If CardResult <> 0 Then
                    MsgBox "Set CF Card Detect On Fail"
                    End
                  End If
                  
                  
                    Call MsecDelay(0.01)
                 If rv0 = 1 Then
                     CardResult = DO_WritePort(card, Channel_P1A, &H7D)
                 End If
                 If CardResult <> 0 Then
                    MsgBox "Set CF Card Detect Down Fail"
                    End
                 End If
                  Call MsecDelay(AU6371EL_BootTime * 2)
                 If ChipName = "AU6371EL" Then
                   ReaderExist = 0
                 End If
                
                 ClosePipe
                 rv1 = CBWTest_New(0, rv0, ChipString)
                 ClosePipe
               Else
                  rv1 = 1  '----------- AU6371S3 dp not have CF slot
                 
               End If
                 
                 Call LabelMenu(1, rv1, rv0)
               
                      Print rv1, " \\CF :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                '===============================================
                '  SMC Card test  : stop these test for card not enough
                '================================================
              '    CardResult = DO_WritePort(card, Channel_P1A, &H7F)
                  
              '   If CardResult <> 0 Then
              '      MsgBox "Set SMC Card Detect On Fail"
              '      End
              '   End If
                  
              '   Call MsecDelay(0.01)
              '  If rv1 = 1 Then
              '      CardResult = DO_WritePort(card, Channel_P1A, &H7B)
              '  End If
               
              '  If CardResult <> 0 Then
              '      MsgBox "Set SMC Card Detect Down Fail"
              '      End
              '   End If
                 
              '  ClosePipe
              '  rv2 = CBWTest_New(0, rv1, "vid_058f")
              '  Call LabelMenu(21, rv2, rv1)
                
              '       Print rv2, " \\SMC :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
              
               If rv1 = 1 Then
                   rv2 = 1   ' to complete the SMC asbolish
               Else
                   rv2 = 0
               End If
              
                '===============================================
                '  XD Card test
                '================================================
                  CardResult = DO_WritePort(card, Channel_P1A, &H7F)
                  
                   
                If CardResult <> 0 Then
                    MsgBox "Set XD Card Detect On Fail"
                    End
                 End If
                  
                  
                 Call MsecDelay(0.01)
                If rv2 = 1 Then
                    CardResult = DO_WritePort(card, Channel_P1A, &H77)
                End If
                Call MsecDelay(AU6371EL_BootTime)
                If CardResult <> 0 Then
                    MsgBox "Set XD Card Detect Down Fail"
                    End
                 End If
                 
                   If ChipName = "AU6371EL" Then
                   ReaderExist = 0
                 End If
                
                ClosePipe
                rv3 = CBWTest_New(0, rv2, ChipString)
                Call LabelMenu(2, rv3, rv2)
                
                     Print rv3, " \\XD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                
                '===============================================
                '  MS Card test
                '================================================
                CardResult = DO_WritePort(card, Channel_P1A, &H7F)
                 Call MsecDelay(0.03)
                 
                If CardResult <> 0 Then
                    MsgBox "Set MS Card Detect On Fail"
                    End
                End If
                
                If rv3 = 1 Then
                    CardResult = DO_WritePort(card, Channel_P1A, &H6F)
                End If
                Call MsecDelay(AU6371EL_BootTime)
                 If CardResult <> 0 Then
                    MsgBox "Set MS Card Detect Down Fail"
                    End
                 End If
                  If ChipName = "AU6371EL" Then
                   ReaderExist = 0
                 End If
                
                
                ClosePipe
                rv4 = CBWTest_New(0, rv3, ChipString)
                Call LabelMenu(3, rv4, rv3)
                
                     Print rv4, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                   '===============================================
                '  MS Pro Card test
                '================================================
                If ChipName <> "AU6371EL" Then
                 CardResult = DO_WritePort(card, Channel_P1A, &H7F)
                
                 If CardResult <> 0 Then
                    MsgBox "Set MSPro Card Detect On Fail"
                    End
                 End If
                
                 Call MsecDelay(0.03)
                If rv4 = 1 Then
                    CardResult = DO_WritePort(card, Channel_P1A, &H5F)
                End If
                  Call MsecDelay(AU6371EL_BootTime * 2)
                 If CardResult <> 0 Then
                    MsgBox "Set MSPro Card Detect Down Fail"
                    End
                 End If
                 If ChipName = "AU6371EL" Then
                   ReaderExist = 0
                 End If
                
                ClosePipe
                rv5 = CBWTest_New(0, rv4, ChipString)
                Call LabelMenu(31, rv5, rv4)
                     Print rv5, " \\MSpro :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                ClosePipe
                Else
                
                rv5 = 1
                End If
                
                  CardResult = DO_WritePort(card, Channel_P1A, &HFF)   ' Close power
                
                
                      If rv0 = UNKNOW Then
                           UnknowDeviceFail = UnknowDeviceFail + 1
                           TestResult = "UNKNOW"
                        ElseIf rv0 = WRITE_FAIL Then
                            SDWriteFail = SDWriteFail + 1
                            TestResult = "SD_WF"
                        ElseIf rv0 = READ_FAIL Then
                            SDReadFail = SDReadFail + 1
                            TestResult = "SD_RF"
                        ElseIf rv1 = WRITE_FAIL Then
                            CFWriteFail = CFWriteFail + 1
                            TestResult = "CF_WF"
                        ElseIf rv1 = READ_FAIL Then
                            CFReadFail = CFReadFail + 1
                            TestResult = "CF_RF"
                        ElseIf rv2 = WRITE_FAIL Or rv3 = WRITE_FAIL Then
                            XDWriteFail = XDWriteFail + 1
                            TestResult = "XD_WF"
                        ElseIf rv2 = READ_FAIL Or rv3 = READ_FAIL Then
                            XDReadFail = XDReadFail + 1
                            TestResult = "XD_RF"
                         ElseIf rv4 = WRITE_FAIL Or rv5 = WRITE_FAIL Then
                            MSWriteFail = MSWriteFail + 1
                            TestResult = "MS_WF"
                        ElseIf rv4 = READ_FAIL Or rv5 = READ_FAIL Then
                            MSReadFail = MSReadFail + 1
                            TestResult = "MS_RF"
                       
                            
                        ElseIf rv5 * rv4 * rv3 * rv2 * rv1 * rv0 = PASS Then
                             TestResult = "PASS"
                        Else
                            TestResult = "Bin2"
                          
                        End If
              
           
                
                
                
                
             
        
            Case "AU6377"
            
              LBA = LBA + 1
                
                
               
                
                
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                rv4 = 0
               
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(0, rv0, 1)
                ClosePipe
                rv1 = CBWTest_New(1, rv0, "vid_058f")
                Call LabelMenu(1, rv1, rv0)
                ClosePipe
                rv2 = CBWTest_New(2, rv1, "vid_058f")
               Call LabelMenu(2, rv2, rv1)
                ClosePipe
                 
                rv3 = CBWTest_New(3, rv2, "vid_058f")
                Call LabelMenu(3, rv3, rv2)
                ClosePipe
                ClosePipe
                rv4 = CBWTest_New(4, rv3, "vid_058f")
                Call LabelMenu(10, rv4, rv3)
                ClosePipe
                
                
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv1, " \\CF :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv2, " \\XD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv3, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv4, " \\MiniSD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                
                
                'If rv0 = 1 And rv1 = 1 And rv2 = 1 And rv3 = 1 Then
                   ' TestResult = "PASS"
                'End If
                
                        
                        If rv0 = UNKNOW Then
                           UnknowDeviceFail = UnknowDeviceFail + 1
                           TestResult = "UNKNOW"
                        ElseIf rv0 = WRITE_FAIL Then
                            SDWriteFail = SDWriteFail + 1
                            TestResult = "SD_WF"
                        ElseIf rv0 = READ_FAIL Then
                            SDReadFail = SDReadFail + 1
                            TestResult = "SD_RF"
                        ElseIf rv1 = WRITE_FAIL Then
                            CFWriteFail = CFWriteFail + 1
                            TestResult = "CF_WF"
                        ElseIf rv1 = READ_FAIL Then
                            CFReadFail = CFReadFail + 1
                            TestResult = "CF_RF"
                        ElseIf rv2 = WRITE_FAIL Then
                            XDWriteFail = XDWriteFail + 1
                            TestResult = "XD_WF"
                        ElseIf rv2 = READ_FAIL Then
                            XDReadFail = XDReadFail + 1
                            TestResult = "XD_RF"
                         ElseIf rv3 = WRITE_FAIL Then
                            MSWriteFail = MSWriteFail + 1
                            TestResult = "MS_WF"
                        ElseIf rv3 = READ_FAIL Then
                            MSReadFail = MSReadFail + 1
                            TestResult = "MS_RF"
                        ElseIf rv4 = WRITE_FAIL Then
                            SDWriteFail = SDWriteFail + 1
                            TestResult = "SD_WF"
                        ElseIf rv4 = READ_FAIL Then
                            SDReadFail = SDReadFail + 1
                            TestResult = "SD_RF"
                            
                        ElseIf rv4 * rv3 * rv2 * rv1 * rv0 = PASS Then
                             TestResult = "PASS"
                        Else
                            TestResult = "Bin2"
                          
                        End If
                
               ' If rv2 * rv3 * rv1 = 0 Then
                '    MsgBox "rturn error"
                'End If
                  
               
            
        
                
        
            Case "AU6366S4"
                  
                     
                LBA = LBA + 1
                
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                
                Print LBA
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                '=========================================step1
                    ClosePipe
                    rv0 = CBWTest_New(0, 1, "vid_058f") 'testing SD CARD
                    Call LabelMenu(0, rv0, 1)
                    ClosePipe
                
                    If rv0 = UNKNOW Then
                       UnknowDeviceFail = UnknowDeviceFail + 1
                       TestResult = "UNKNOW"
                    ElseIf rv0 = WRITE_FAIL Then
                        SDWriteFail = SDWriteFail + 1
                        TestResult = "SD_WF"
                    ElseIf rv0 = READ_FAIL Then
                        SDReadFail = SDReadFail + 1
                        TestResult = "SD_RF"
                    ElseIf rv0 = PASS Then
                         TestResult = "SD_PASS"
                    Else
                        TestResult = "Bin2"
                    End If
                    
                    Print "Test Result = "; TestResult
                    MSComm1.OutBufferCount = 0
                    MSComm1.Output = TestResult   ' send out test result
                    Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                    Print "LBA="; LBA
                    
                '===========================================step2
                If TestResult = "SD_PASS" Then
                     TestResult = ""
                     ChipName = ""
                        Do
                            Call MsecDelay(0.1)
                            DoEvents
                            buf = MSComm1.Input
                            ChipName = ChipName & buf
                        Loop Until InStr(1, ChipName, "PASS") <> 0
                         
                    'Call MsecDelay(1) 'Allen
                    ClosePipe
                    rv1 = CBWTest_New(0, rv0, "vid_058f") 'testing CF CARD
                    Call LabelMenu(1, rv1, rv0)
                    ClosePipe
                                 
                    If rv1 = UNKNOW Then
                        UnknowDeviceFail = UnknowDeviceFail + 1
                        TestResult = "UNKNOW"
                    ElseIf rv1 = WRITE_FAIL Then
                        CFWriteFail = CFWriteFail + 1
                        TestResult = "CF_WF"
                    ElseIf rv1 = READ_FAIL Then
                        CFReadFail = CFReadFail + 1
                        TestResult = "CF_RF"
                    ElseIf rv1 = PASS Then
                        TestResult = "CF_PASS"
                    Else
                        TestResult = "Bin2"
                    End If
                
                    Print "Test Result = "; TestResult
                     MSComm1.OutBufferCount = 0
                     MSComm1.Output = TestResult   ' send out test result
                    Print rv1, " \\CF :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                    Print "LBA="; LBA
                 End If
                '==============================================step3
                If TestResult = "CF_PASS" Then
                    TestResult = ""
                    ChipName = ""
                    Do
                        Call MsecDelay(0.1)
                        DoEvents
                        buf = MSComm1.Input
                        ChipName = ChipName & buf
                    Loop Until InStr(1, ChipName, "PASS") <> 0
                    'Call MsecDelay(1) 'allen
                    ClosePipe
                    rv2 = CBWTest_New(0, rv1, "vid_058f") 'testing XD CARD
                    Call LabelMenu(2, rv2, rv1)
                    ClosePipe
                    If rv2 = UNKNOW Then
                        UnknowDeviceFail = UnknowDeviceFail + 1
                        TestResult = "UNKNOW"
                    ElseIf rv2 = WRITE_FAIL Then
                        XDWriteFail = XDWriteFail + 1
                        TestResult = "XD_WF"
                    ElseIf rv2 = READ_FAIL Then
                        XDReadFail = XDReadFail + 1
                        TestResult = "XD_RF"
                    ElseIf rv2 = PASS Then
                        TestResult = "XD_PASS"
                    Else
                        TestResult = "Bin2"
                    End If
                    
                    Print "Test Result = "; TestResult
                    MSComm1.OutBufferCount = 0
                    MSComm1.Output = TestResult   ' send out test result
                    Print rv2, " \\XD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                    Print "LBA="; LBA
                End If
                '==================================================step4
                If TestResult = "XD_PASS" Then
                     TestResult = ""
                      ChipName = ""
                        Do
                            Call MsecDelay(0.1)
                            DoEvents
                            buf = MSComm1.Input
                            ChipName = ChipName & buf
                        Loop Until InStr(1, ChipName, "PASS") <> 0
                    'Call MsecDelay(1) 'Allen
                    ClosePipe
                    rv3 = CBWTest_New(0, rv2, "vid_058f") 'testing MS CARD
                    Call LabelMenu(3, rv3, rv2)
                    ClosePipe
                
                    If rv0 = UNKNOW Then
                        UnknowDeviceFail = UnknowDeviceFail + 1
                        TestResult = "UNKNOW"
                    ElseIf rv3 = WRITE_FAIL Then
                        MSWriteFail = MSWriteFail + 1
                        TestResult = "MS_WF"
                    ElseIf rv3 = READ_FAIL Then
                        MSReadFail = MSReadFail + 1
                        TestResult = "MS_RF"
                    ElseIf rv3 = PASS Then
                        TestResult = "PASS"
                    Else
                        TestResult = "Bin2"
                    End If
                    Print "Test Result = "; TestResult
                    Print rv3, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                    Print "LBA="; LBA
                End If
               
                '====================================================
            
        
           
                
            Case "AU6375F", "AU6368F", "AU6376HV"
            
                
                If ChipName = "AU6376HV" Then
                         Call PowerSet(21)
                         If PCI7248InitFinish = 0 Then
                          PCI7248Exist
                         End If
                         
                         CardResult = DO_WritePort(card, Channel_P1B, &H0)
                        result = DIO_PortConfig(card, Channel_P1B, INPUT_PORT)
                         CardResult = DO_WritePort(card, Channel_P1A, &H0)  '
                           
                         Call MsecDelay(1.2)
                          
               End If
                
                
                
                
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                rv4 = 0
                rv5 = 0
                rv6 = 0
                rv7 = 0
                
                LBA = LBA + 1
                
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                   
            
                OldLba = LBA
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(0, rv0, 1)
                '//*LabelMenu(SlotNo As Byte, TestResult As Byte, PreSlotStatus As Byte)
                ClosePipe
                rv1 = CBWTest_New(1, rv0, "vid_058f")
                Call LabelMenu(1, rv1, rv0)
                ClosePipe
                rv2 = CBWTest_New(2, rv1, "vid_058f")
                Call LabelMenu(2, rv2, rv1)
                ClosePipe
                rv3 = CBWTest_New(3, rv2, "vid_058f")
                Call LabelMenu(3, rv3, rv2)
                ClosePipe
                rv4 = CBWTest_New_8_Sector(0, rv3, FailPosition, 20)
                LBA = OldLba
                Call LabelMenu(0, rv4, rv3)
                ClosePipe
                rv5 = CBWTest_New_8_Sector(1, rv4, FailPosition, 20)
                LBA = OldLba
                Call LabelMenu(1, rv5, rv4)
                ClosePipe
                rv6 = CBWTest_New_8_Sector(2, rv5, FailPosition, 20)
                LBA = OldLba
                Call LabelMenu(2, rv6, rv5)
                ClosePipe
                rv7 = CBWTest_New_8_Sector(3, rv6, FailPosition, 20)
                LBA = OldLba
                Call LabelMenu(3, rv7, rv6)
                ClosePipe
                
                
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv1, " \\CF :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv2, " \\XD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv3, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv4, " \\SD stress :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv5, " \\CF stress :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv6, " \\XD stress :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv7, " \\MS stress :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                Print "FailPosition="; FailPosition
                
                
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Or rv4 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Or rv4 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Or rv5 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv1 = READ_FAIL Or rv5 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Or rv6 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Or rv6 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                ElseIf rv3 = WRITE_FAIL Or rv7 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Or rv7 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv7 * rv6 * rv5 * rv4 * rv3 * rv2 * rv1 * rv0 = PASS Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                End If
                
                Call PowerSet(3)
                 CardResult = DO_WritePort(card, Channel_P1A, &H1)
                  result = DIO_PortConfig(card, Channel_P1B, OUTPUT_PORT)
            
                   CardResult = DO_WritePort(card, Channel_P1B, &H0)
                   
           
            
            Case "AU6369CF"
            
                rv0 = 0
                rv1 = 0
                
                LBA = LBA + 1
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
              
                Call LabelMenu(1, rv0, 1)
                ClosePipe
                               
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = PASS Then 'Arch define 941027
                   TestResult = "PASS"
                ElseIf rv0 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv0 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                Else
                    TestResult = "Bin2"
                End If
                        
                                
                Print rv0, " \\CF :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                
           
        
            Case "AU6368NC"
                  
                     
              
                LBA = LBA + 1
                
                
                '//////////////////////////////////////////////////
                '
                '   no card insert
                '
                '/////////////////////////////////////////////////
                
                
                Print LBA
                
                ClosePipe
                rv0 = CBWTest_New_no_card(0, 1, "vid_058f")
                'Print "a1"
                Call LabelMenu(0, rv0, 1)
                ClosePipe
                rv1 = CBWTest_New_no_card(1, rv0, "vid_058f")
               '  Print "a2"
                Call LabelMenu(1, rv1, rv0)
                ClosePipe
                
                rv2 = CBWTest_New_no_card(2, rv1, "vid_058f")
               '  Print "a3"
                Call LabelMenu(2, rv2, rv1)
                ClosePipe
                rv3 = CBWTest_New_no_card(3, rv2, "vid_058f")
                ' Print "a4"
                ClosePipe
                Call LabelMenu(3, rv3, rv2)
                
                
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv1 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                 ElseIf rv3 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv3 * rv2 * rv1 * rv0 = PASS Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                  
                End If
                
                Print "Test Result"; TestResult
                       
               
              
                 MSComm1.OutBufferCount = 0
                 MSComm1.Output = TestResult   ' send out test result
                 
                 
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 card change bit fail"
                Print rv1, " \\CF :0 Unknow device, 1 pass ,2 card change bit fail"
                Print rv2, " \\XD :0 Unknow device, 1 pass ,2 card change bit fail"
                Print rv3, " \\MS :0 Unknow device, 1 pass ,2 card change bit fail"
                 
                 
                If TestResult = "PASS" Then
                  
                     TestResult = ""
                      ChipName = ""
                        Do
                            Call MsecDelay(0.1)
                            DoEvents
                            buf = MSComm1.Input
                            ChipName = ChipName & buf
                        Loop Until InStr(1, ChipName, "PASS") <> 0
                 
                 
                 '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                 '
                 '  R/W test
                 '
                 '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                 
                
                'initial return value
                
                
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
               
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(0, rv0, 1)
                ClosePipe
                rv1 = CBWTest_New(1, rv0, "vid_058f")
                Call LabelMenu(1, rv1, rv0)
                ClosePipe
                rv2 = CBWTest_New(2, rv1, "vid_058f")
                Call LabelMenu(2, rv2, rv1)
                ClosePipe
                rv3 = CBWTest_New(3, rv2, "vid_058f")
                Call LabelMenu(3, rv3, rv2)
                ClosePipe
                
                
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv1, " \\CF :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv2, " \\XD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv3, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                
                
                'If rv0 = 1 And rv1 = 1 And rv2 = 1 And rv3 = 1 Then
                   ' TestResult = "PASS"
                'End If
                
                        
                        If rv0 = UNKNOW Then
                           UnknowDeviceFail = UnknowDeviceFail + 1
                           TestResult = "UNKNOW"
                        ElseIf rv0 = WRITE_FAIL Then
                            SDWriteFail = SDWriteFail + 1
                            TestResult = "SD_WF"
                        ElseIf rv0 = READ_FAIL Then
                            SDReadFail = SDReadFail + 1
                            TestResult = "SD_RF"
                        ElseIf rv1 = WRITE_FAIL Then
                            CFWriteFail = CFWriteFail + 1
                            TestResult = "CF_WF"
                        ElseIf rv1 = READ_FAIL Then
                            CFReadFail = CFReadFail + 1
                            TestResult = "CF_RF"
                        ElseIf rv2 = WRITE_FAIL Then
                            XDWriteFail = XDWriteFail + 1
                            TestResult = "XD_WF"
                        ElseIf rv2 = READ_FAIL Then
                            XDReadFail = XDReadFail + 1
                            TestResult = "XD_RF"
                         ElseIf rv3 = WRITE_FAIL Then
                            MSWriteFail = MSWriteFail + 1
                            TestResult = "MS_WF"
                        ElseIf rv3 = READ_FAIL Then
                            MSReadFail = MSReadFail + 1
                            TestResult = "MS_RF"
                        ElseIf rv3 * rv2 * rv1 * rv0 = PASS Then
                             TestResult = "PASS"
                        Else
                            TestResult = "Bin2"
                          
                        End If
                
               ' If rv2 * rv3 * rv1 = 0 Then
                '    MsgBox "rturn error"
                'End If
                  
                End If
           
            Case "AU6331"
                LBA = LBA + 1
                
                
                TestResult = ""
                ChipName = ""
                
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(0, rv0, 1)
                ClosePipe
                rv1 = CBWTest_New(1, rv0, "vid_058f")
                Call LabelMenu(3, rv1, rv0)
                ClosePipe
                
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv1, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                
                        
                    If rv0 = UNKNOW Then
                       UnknowDeviceFail = UnknowDeviceFail + 1
                       TestResult = "UNKNOW"
                    ElseIf rv0 = WRITE_FAIL Then
                        SDWriteFail = SDWriteFail + 1
                        TestResult = "SD_WF"
                    ElseIf rv0 = READ_FAIL Then
                        SDReadFail = SDReadFail + 1
                        TestResult = "SD_RF"
                    ElseIf rv1 = WRITE_FAIL Then
                        MSWriteFail = MSWriteFail + 1
                        TestResult = "MS_WF"
                    ElseIf rv1 = READ_FAIL Then
                        MSReadFail = MSReadFail + 1
                        TestResult = "MS_RF"
                    ElseIf rv1 * rv0 = PASS Then
                         TestResult = "PASS"
                    Else
                        TestResult = "Bin2"
                    End If
                        
          Case "AU6367"
                LBA = LBA + 1
                
                
                TestResult = ""
                ChipName = ""
                 
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(2, rv0, 1)
                ClosePipe
                rv1 = CBWTest_New(1, rv0, "vid_058f")
                Call LabelMenu(0, rv1, rv0)
                ClosePipe
               
                Print rv0, " \\UFD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv1, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                   
                    If rv0 = UNKNOW Then
                       UnknowDeviceFail = UnknowDeviceFail + 1
                       TestResult = "UNKNOW"
                    ElseIf rv0 = WRITE_FAIL Then
                        XDWriteFail = XDWriteFail + 1
                        TestResult = "XD_WF"
                    ElseIf rv0 = READ_FAIL Then
                        XDReadFail = XDReadFail + 1
                        TestResult = "XD_RF"
                    ElseIf rv1 = WRITE_FAIL Then
                        SDWriteFail = SDWriteFail + 1
                        TestResult = "SD_WF"
                    ElseIf rv1 = READ_FAIL Then
                        SDReadFail = SDReadFail + 1
                        TestResult = "SD_RF"
                    ElseIf rv1 * rv0 = PASS Then
                         TestResult = "PASS"
                    Else
                        TestResult = "Bin2"
                    End If
                    
            Case "AU6367F"
             
                LBA = LBA + 1
                TestResult = ""
                ChipName = ""
                 
                rv0 = 0
                rv1 = 0
                rv4 = 0
                rv5 = 0
                
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(2, rv0, 1)
                ClosePipe
                rv1 = CBWTest_New(1, rv0, "vid_058f")
                Call LabelMenu(0, rv1, rv0)
                ClosePipe
                rv4 = CBWTest_New_8_Sector(0, rv1, FailPosition, 20)
                LBA = OldLba
                Call LabelMenu(2, rv4, rv1)
                ClosePipe
                rv5 = CBWTest_New_8_Sector(1, rv4, FailPosition, 20)
                LBA = OldLba
                Call LabelMenu(0, rv5, rv4)
                ClosePipe
                
                
                Print rv0, " \\UFD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv1, " \\SD  :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv4, " \\UFD Stress :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv5, " \\SD  Stress :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                Print "FailPosition="; FailPosition
              
                   
                    If rv0 = UNKNOW Then
                       UnknowDeviceFail = UnknowDeviceFail + 1
                       TestResult = "UNKNOW"
                    ElseIf rv0 = WRITE_FAIL Or rv4 = WRITE_FAIL Then
                        XDWriteFail = XDWriteFail + 1
                        TestResult = "XD_WF"
                    ElseIf rv0 = READ_FAIL Or rv4 = READ_FAIL Then
                        XDReadFail = XDReadFail + 1
                        TestResult = "XD_RF"
                    ElseIf rv1 = WRITE_FAIL Or rv5 = WRITE_FAIL Then
                        SDWriteFail = SDWriteFail + 1
                        TestResult = "SD_WF"
                    ElseIf rv1 = READ_FAIL Or rv5 = READ_FAIL Then
                        SDReadFail = SDReadFail + 1
                        TestResult = "SD_RF"
                    ElseIf rv0 * rv1 * rv4 * rv5 = PASS Then
                         TestResult = "PASS"
                    Else
                        TestResult = "Bin2"
                    End If
                    
        Case "AU33NC_F"
            
                LBA = LBA + 1
                OldLba = LBA
                
                '//////////////////////////////////////////////////
                '
                '   no card insert
                '
                '/////////////////////////////////////////////////
            
            
            Print LBA
            
                ClosePipe
                rv0 = CBWTest_New_no_card(0, 1, "vid_058f")
                'Print "a1"
            Call LabelMenu(0, rv0, 1)
                ClosePipe
                rv1 = CBWTest_New_no_card(1, rv0, "vid_058f")
                '  Print "a2"
            Call LabelMenu(3, rv1, rv0)
                ClosePipe
            
            
            
            If rv0 = UNKNOW Then
                    UnknowDeviceFail = UnknowDeviceFail + 1
                    TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv1 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv1 * rv0 = PASS Then
                    TestResult = "PASS"
                Else
                    TestResult = "Bin2"
            End If
            
            Print "Test Result"; TestResult
            
            MSComm1.OutBufferCount = 0
            
            MSComm1.Output = TestResult   ' send out test result
            
            
            Print rv0, " \\SD :0 Unknow device, 1 pass ,2 card change bit fail"
            Print rv1, " \\MS :0 Unknow device, 1 pass ,2 card change bit fail"
            
            
            If TestResult = "PASS" Then
            
                TestResult = ""
                ChipName = ""
                Do
                
                    Call MsecDelay(0.1)
                    DoEvents
                    buf = MSComm1.Input
                    ChipName = ChipName & buf
                
                Loop Until InStr(1, ChipName, "PASS") <> 0
            
            
                '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                '
                '  R/W test
                '
                '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                
                
                'initial return value
                
                
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                rv4 = 0
                rv5 = 0
                
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                
                
                
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(0, rv0, 1)
                ClosePipe
                rv1 = CBWTest_New(1, rv0, "vid_058f")
                Call LabelMenu(3, rv1, rv0)
                ClosePipe
                rv4 = CBWTest_New_8_Sector(0, rv1, FailPosition, 20)
                LBA = OldLba
                Call LabelMenu(0, rv4, rv1)
                ClosePipe
                rv5 = CBWTest_New_8_Sector(1, rv4, FailPosition, 20)
                LBA = OldLba
                Call LabelMenu(1, rv5, rv4)
                ClosePipe
                
                
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv1, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv4, " \\SD Stress :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv5, " \\MS Stress:0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                Print "FailPosition="; FailPosition
                
                
                If rv0 = UNKNOW Then
                    UnknowDeviceFail = UnknowDeviceFail + 1
                    TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Or rv4 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Or rv4 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Or rv5 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv1 = READ_FAIL Or rv5 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Or rv6 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Or rv6 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                ElseIf rv3 = WRITE_FAIL Or rv7 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Or rv7 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv5 * rv4 * rv1 * rv0 = PASS Then
                    TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                End If
            
            End If
            
          Case "AU6333F", "AU6331F"
          
                LBA = LBA + 1
                TestResult = ""
                ChipName = ""
                
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                rv4 = 0
                rv5 = 0
                rv6 = 0
                rv7 = 0
                
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                
                Print "LBA="; LBA
                
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(0, rv0, 1)
                ClosePipe
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                 
                rv1 = CBWTest_New(1, rv0, "vid_058f")
                Call LabelMenu(3, rv1, rv0)
                ClosePipe
                Print rv1, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                
                Print "LBA="; LBA
                rv4 = CBWTest_New_8_Sector(0, rv1, FailPosition, 20)
                LBA = OldLba
                Call LabelMenu(0, rv4, rv1)
                ClosePipe
                Print rv4, " \\SD stress :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                
                Print "LBA="; LBA
                rv5 = CBWTest_New_8_Sector(1, rv4, FailPosition, 20)
                LBA = OldLba
                Call LabelMenu(3, rv5, rv4)
                ClosePipe
                Print rv5, " \\CF stress :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                
                
                
                        
                    If rv0 = UNKNOW Then
                       UnknowDeviceFail = UnknowDeviceFail + 1
                       TestResult = "UNKNOW"
                    ElseIf rv0 = WRITE_FAIL Or rv4 = WRITE_FAIL Then
                        SDWriteFail = SDWriteFail + 1
                        TestResult = "SD_WF"
                    ElseIf rv0 = READ_FAIL Or rv4 = READ_FAIL Then
                        SDReadFail = SDReadFail + 1
                        TestResult = "SD_RF"
                    ElseIf rv1 = WRITE_FAIL Or rv5 = WRITE_FAIL Then
                        MSWriteFail = MSWriteFail + 1
                        TestResult = "MS_WF"
                    ElseIf rv1 = READ_FAIL Or rv5 = READ_FAIL Then
                        MSReadFail = MSReadFail + 1
                        TestResult = "MS_RF"
                    ElseIf rv0 * rv1 * rv4 * rv5 = PASS Then
                         TestResult = "PASS"
                    Else
                        TestResult = "Bin2"
                    End If
                    
                    
          Case "AU6331A1"
         
         
                'GPIO control setting
            
                 
                    If PCI7248InitFinish = 0 Then
                      PCI7248Exist
                    End If
                    
                    
                
                     
                    CardResult = DO_WritePort(card, Channel_P1A, &HE)
                    Call MsecDelay(1#)
                   
                 
            
                  
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                rv4 = 0
                rv5 = 0
                rv6 = 0
                rv7 = 0
                
                LBA = LBA + 1
                
                
                '//////////////////////////////////////////////////
                '
                '   no card insert
                '
                '/////////////////////////////////////////////////
                
                
                Print LBA
                
                ClosePipe
                rv0 = CBWTest_New_no_card(0, 1, "vid_058f")
                 
                Call LabelMenu(0, rv0, 1)
              
                ClosePipe
                
                
                
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
               
                ElseIf rv0 = PASS Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                End If
                
                Print "Test Result"; TestResult
                       
             
                 
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 card change bit fail"
              
                 
                If TestResult = "PASS" Then
                     TestResult = ""
                    
                        CardResult = DO_WritePort(card, Channel_P1A, &H0)
                        Call MsecDelay(1#)
           
                    
                 
                 '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                 '
                 '  R/W test
                 '
                 '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                 
                
                'initial return value
                
                
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                
                
                
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(0, rv0, 1)
                ClosePipe
               
                
                 If rv0 = 1 Then
                                  CardResult = DO_ReadPort(card, Channel_P1B, LightOFF)
                                 If LightOFF <> 248 Then
                                   UsbSpeedTestResult = GPO_FAIL
                                    rv0 = 2
                                 End If
                 End If
                
                
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                 
                Print "LBA="; LBA
                
                
                'If rv0 = 1 And rv1 = 1 And rv2 = 1 And rv3 = 1 Then
                   ' TestResult = "PASS"
                'End If
                
                        
                        If rv0 = UNKNOW Then
                           UnknowDeviceFail = UnknowDeviceFail + 1
                           TestResult = "UNKNOW"
                        ElseIf rv0 = WRITE_FAIL Then
                            SDWriteFail = SDWriteFail + 1
                            TestResult = "SD_WF"
                        ElseIf rv0 = READ_FAIL Then
                            SDReadFail = SDReadFail + 1
                            TestResult = "SD_RF"
                        
                        ElseIf rv0 = PASS Then
                             TestResult = "PASS"
                        Else
                            TestResult = "Bin2"
                        End If
                
               ' If rv2 * rv3 * rv1 = 0 Then
                '    MsgBox "rturn error"
                'End If
                  
                End If
                    
         Case "AU6333NC", "AU6331NC", "AU6333A1", "AU6333BL", "AU6333EL"
         
         
                'GPIO control setting
            
                If ChipName = "AU6333A1" Or ChipName = "AU6333BL" Or ChipName = "AU6333EL" Then
                    If PCI7248InitFinish = 0 Then
                      PCI7248Exist
                    End If
                    If ChipName = "AU6333A1" Or ChipName = "AU6333BL" Then
                     CardResult = DO_WritePort(card, Channel_P1A, &H0)
                     Call MsecDelay(0.2)
                    CardResult = DO_WritePort(card, Channel_P1A, &H6)
                    Call MsecDelay(1#)
                    End If
                    
                    If ChipName = "AU6333EL" Then
                     CardResult = DO_WritePort(card, Channel_P1A, &H9)
                     Call MsecDelay(0.2)
                    CardResult = DO_WritePort(card, Channel_P1A, &HE)
                    Call MsecDelay(1#)
                    End If
                 End If
            
                  
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                rv4 = 0
                rv5 = 0
                rv6 = 0
                rv7 = 0
                
                LBA = LBA + 1
                
                
                '//////////////////////////////////////////////////
                '
                '   no card insert
                '
                '/////////////////////////////////////////////////
                
                
                Print LBA
                
                ClosePipe
                rv0 = CBWTest_New_no_card(0, 1, "vid_058f")
                'Print "a1"
                Call LabelMenu(0, rv0, 1)
                ClosePipe
                rv1 = CBWTest_New_no_card(1, rv0, "vid_058f")
               '  Print "a2"
                Call LabelMenu(3, rv1, rv0)
                ClosePipe
                
                
                
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv1 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv1 * rv0 = PASS Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                End If
                
                Print "Test Result"; TestResult
                       
               If ChipName = "AU6333A1" Or ChipName = "AU6333BL" Or ChipName = "AU6333EL" Then
              
                    TestResult = "PASS"
               Else
                    MSComm1.OutBufferCount = 0
                    MSComm1.Output = TestResult   ' send out test result
                  
               End If
            
                 
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 card change bit fail"
                Print rv1, " \\MS :0 Unknow device, 1 pass ,2 card change bit fail"
                 
                 
                If TestResult = "PASS" Then
                     TestResult = ""
                     
                     If ChipName <> "AU6333A1" And ChipName <> "AU6333BL" And ChipName <> "AU6333EL" Then
                        ChipName = ""
                        Do
                           Call MsecDelay(0.1)
                              DoEvents
                              buf = MSComm1.Input
                              ChipName = ChipName & buf
                     
                        Loop Until InStr(1, ChipName, "PASS") <> 0
                        
                     Else
                     
                        CardResult = DO_WritePort(card, Channel_P1A, &H0)
                        Call MsecDelay(1#)
           
                     End If
                 
                 '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                 '
                 '  R/W test
                 '
                 '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                 
                
                'initial return value
                
                
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                
                
                
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(0, rv0, 1)
                ClosePipe
                rv1 = CBWTest_New(1, rv0, "vid_058f")
                Call LabelMenu(3, rv1, rv0)
                ClosePipe
                
                
                 If rv1 = 1 Then
                                  CardResult = DO_ReadPort(card, Channel_P1B, LightOFF)
                                 If LightOFF <> 240 Then
                                   UsbSpeedTestResult = GPO_FAIL
                                    rv1 = 2
                                 End If
                 End If
                
                
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv1, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                
                
                'If rv0 = 1 And rv1 = 1 And rv2 = 1 And rv3 = 1 Then
                   ' TestResult = "PASS"
                'End If
                
                        
                        If rv0 = UNKNOW Then
                           UnknowDeviceFail = UnknowDeviceFail + 1
                           TestResult = "UNKNOW"
                        ElseIf rv0 = WRITE_FAIL Then
                            SDWriteFail = SDWriteFail + 1
                            TestResult = "SD_WF"
                        ElseIf rv0 = READ_FAIL Then
                            SDReadFail = SDReadFail + 1
                            TestResult = "SD_RF"
                        ElseIf rv1 = WRITE_FAIL Then
                            MSWriteFail = MSWriteFail + 1
                            TestResult = "MS_WF"
                        ElseIf rv1 = READ_FAIL Then
                            MSReadFail = MSReadFail + 1
                            TestResult = "MS_RF"
                        ElseIf rv1 * rv0 = PASS Then
                             TestResult = "PASS"
                        Else
                            TestResult = "Bin2"
                        End If
                
               ' If rv2 * rv3 * rv1 = 0 Then
                '    MsgBox "rturn error"
                'End If
                  
                End If
         Case "AU6333SD"
                  
                     
                LBA = LBA + 1
                
                
                '//////////////////////////////////////////////////
                '
                '   no card insert
                '
                '/////////////////////////////////////////////////
                
                
                Print LBA
                
                ClosePipe
                rv0 = CBWTest_New_no_card(0, 1, "vid_058f")
                'Print "a1"
                Call LabelMenu(0, rv0, 1)
                ClosePipe
               
                
                
                
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv0 = PASS Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                End If
                
                Print "Test Result"; TestResult
                       
               
              
               MSComm1.OutBufferCount = 0
               
               MSComm1.Output = TestResult   ' send out test result
            
                 
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 card change bit fail"
                
                 
                 
                If TestResult = "PASS" Then
                  
                     TestResult = ""
                      ChipName = ""
                        Do
                     
                              Call MsecDelay(0.1)
                              DoEvents
                              buf = MSComm1.Input
                              ChipName = ChipName & buf
                     
                        Loop Until InStr(1, ChipName, "PASS") <> 0
                 
                 
                 '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                 '
                 '  R/W test
                 '
                 '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                 
                
                'initial return value
                
                
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                
                
                
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(0, rv0, 1)
                ClosePipe
                
                
                
                
                
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print " <<<<<<<<<<<<<<<<<<------------------>>>>>>>>>>>>>>>>>>>>>>"
                Print "LBA="; LBA
                
                
                'If rv0 = 1 And rv1 = 1 And rv2 = 1 And rv3 = 1 Then
                   ' TestResult = "PASS"
                'End If
                
                        
                        If rv0 = UNKNOW Then
                           UnknowDeviceFail = UnknowDeviceFail + 1
                           TestResult = "UNKNOW"
                        ElseIf rv0 = WRITE_FAIL Then
                            SDWriteFail = SDWriteFail + 1
                            TestResult = "SD_WF"
                        ElseIf rv0 = READ_FAIL Then
                            SDReadFail = SDReadFail + 1
                            TestResult = "SD_RF"
                        
                        ElseIf rv0 = PASS Then
                             TestResult = "PASS"
                        Else
                            TestResult = "Bin2"
                        End If
                
               ' If rv2 * rv3 * rv1 = 0 Then
                '    MsgBox "rturn error"
                'End If
                End If
                
            Case "AU33SD_F"
                  
                     
                LBA = LBA + 1
                
                OldLba = LBA
                '//////////////////////////////////////////////////
                '
                '   no card insert
                '
                '/////////////////////////////////////////////////
                
                
                Print LBA
                
                ClosePipe
                rv0 = CBWTest_New_no_card(0, 1, "vid_058f")
                'Print "a1"
                Call LabelMenu(0, rv0, 1)
                ClosePipe
               
                
                
                
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv0 = PASS Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                End If
                
                Print "Test Result"; TestResult
                       
               
              
               MSComm1.OutBufferCount = 0
               
               MSComm1.Output = TestResult   ' send out test result
            
                 
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 card change bit fail"
                
                 
                 
                If TestResult = "PASS" Then
                  
                     TestResult = ""
                      ChipName = ""
                        Do
                     
                              Call MsecDelay(0.1)
                              DoEvents
                              buf = MSComm1.Input
                              ChipName = ChipName & buf
                     
                        Loop Until InStr(1, ChipName, "PASS") <> 0
                 
                 
                     '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                     '
                     '  R/W test
                     '
                     '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                     
                    
                    'initial return value
                    
                    
                    rv0 = 0
                    rv1 = 0
                    rv2 = 0
                    rv3 = 0
                    rv4 = 0
                    Label3.BackColor = RGB(255, 255, 255)
                    Label4.BackColor = RGB(255, 255, 255)
                    Label5.BackColor = RGB(255, 255, 255)
                    Label6.BackColor = RGB(255, 255, 255)
                    Label7.BackColor = RGB(255, 255, 255)
                    Label8.BackColor = RGB(255, 255, 255)
                    
                    
                    
                    ClosePipe
                    rv0 = CBWTest_New(0, 1, "vid_058f")
                    Call LabelMenu(0, rv0, 1)
                    ClosePipe
                    
                    rv4 = CBWTest_New_8_Sector(0, rv0, FailPosition, 20)
                    LBA = OldLba
                    Call LabelMenu(0, rv4, rv0)
                    ClosePipe
                    
                    
                    
                    
                    Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                    Print " <<<<<<<<<<<<<<<<<<------------------>>>>>>>>>>>>>>>>>>>>>>"
                    Print rv4, " \\SD Stress:0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                    Print "LBA="; LBA
                    Print "FailPosition="; FailPosition
                    
                    
                    'If rv0 = 1 And rv1 = 1 And rv2 = 1 And rv3 = 1 Then
                       ' TestResult = "PASS"
                    'End If
                
                        
                    If rv0 = UNKNOW Then
                       UnknowDeviceFail = UnknowDeviceFail + 1
                       TestResult = "UNKNOW"
                    ElseIf rv0 = WRITE_FAIL Or rv4 = WRITE_FAIL Then
                        SDWriteFail = SDWriteFail + 1
                        TestResult = "SD_WF"
                    ElseIf rv0 = READ_FAIL Or rv4 = READ_FAIL Then
                        SDReadFail = SDReadFail + 1
                        TestResult = "SD_RF"
                    ElseIf rv1 = WRITE_FAIL Or rv5 = WRITE_FAIL Then
                        CFWriteFail = CFWriteFail + 1
                        TestResult = "CF_WF"
                    ElseIf rv1 = READ_FAIL Or rv5 = READ_FAIL Then
                        CFReadFail = CFReadFail + 1
                        TestResult = "CF_RF"
                    ElseIf rv2 = WRITE_FAIL Or rv6 = WRITE_FAIL Then
                        XDWriteFail = XDWriteFail + 1
                        TestResult = "XD_WF"
                    ElseIf rv2 = READ_FAIL Or rv6 = READ_FAIL Then
                        XDReadFail = XDReadFail + 1
                        TestResult = "XD_RF"
                    ElseIf rv3 = WRITE_FAIL Or rv7 = WRITE_FAIL Then
                        MSWriteFail = MSWriteFail + 1
                        TestResult = "MS_WF"
                    ElseIf rv3 = READ_FAIL Or rv7 = READ_FAIL Then
                        MSReadFail = MSReadFail + 1
                        TestResult = "MS_RF"
                    ElseIf rv4 * rv0 = PASS Then
                         TestResult = "PASS"
                    Else
                        TestResult = "Bin2"
                    End If
                
                End If
                
         Case "AU6366SD", "AU6331SD", "AU6332SD", "AU6332CF", "AU6371CF"
         
         
                 rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
         
               If ChipName = "AU6332CF" Or ChipName = "AU6371CF" Then
         
                    If PCI7248InitFinish = 0 Then
                      PCI7248Exist
                    End If
                
                   result = DIO_PortConfig(card, Channel_P1B, OUTPUT_PORT)
                    CardResult = DO_WritePort(card, Channel_P1B, &H0)
           
                    result = DIO_PortConfig(card, Channel_P1B, INPUT_PORT)
                    
                    If ChipName = "AU6371CF" Then
                       'bit0: ENA
                       'bit1: SDCDN
                       'bin2: Reader mode
                       'bin3:
                       'bin4,5,6,7: DATA
                       
                    
                       CardResult = DO_WritePort(card, Channel_P1A, &HE)   '
                    Else
                        CardResult = DO_WritePort(card, Channel_P1A, &H3E)  ' 1111 1110
                        
                    End If
                   
              
                     Call MsecDelay(1.4)
      
                    ClosePipe
                    rv0 = CBWTest_New_no_card(0, 1, "vid_058f")
                'Print "a1"
                   Call LabelMenu(0, rv0, 1)
                   ClosePipe
                   Print rv0; " no card test"
                   
                   If rv0 = 1 Then  ' no card test fail
                   
                      If ChipName = "AU6371CF" Then
                         CardResult = DO_WritePort(card, Channel_P1A, &HC)  ' 1111 1110
                        Call MsecDelay(0.02)
                      
                      Else
                        CardResult = DO_WritePort(card, Channel_P1A, &H0)  ' 1111 1110
                        Call MsecDelay(0.02)
                      End If
                      
                      
                   End If
               End If
               
               
               
                
                '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                '
                '  R/W test
                '
                '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                
                'initial return value
                
                
                
             
                
                If ChipName = "AU6332CF" Or ChipName = "AU6371CF" Then
                
                      ClosePipe
                     rv1 = CBWTest_New(0, rv0, "vid_058f")
                    
                     ClosePipe
                      Print rv1, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                    
                    Print "LBA="; LBA
                    
                    
                     CardResult = DO_ReadPort(card, Channel_P1B, LightOFF)  ' 1111 1110
                       
                       If ChipName = "AU6371CF" Then
                       
                            If LightOFF <> 224 And LightOFF <> 254 Then
                               rv1 = 3
                            End If
                            Call LabelMenu(1, rv1, rv0)
                            If rv1 <> 1 And rv0 = 1 Then
                                   Label9.Caption = "SD card Fail or GPO FAIL  "
                            End If
                              
                            rv2 = 4
                            If rv1 = 1 Then
                            
                                '  PullDown Test
                                '1. shutdown power, Bus switch Enable, unable reader mode
                                
                                CardResult = DO_WritePort(card, Channel_P1A, &H1)
                                Call MsecDelay(0.3)
                                CardResult = DO_WritePort(card, Channel_P1A, &H0)
                                Call MsecDelay(0.3)
                                CardResult = DO_ReadPort(card, Channel_P1B, LightOFF)
                                rv2 = 1
                                If LightOFF <> 225 And LightOFF <> 224 Then
                                        rv2 = 2
                                End If
                                
                                If rv2 = 1 Then
                                    CardResult = DO_WritePort(card, Channel_P1A, &HF0)
                                    Call MsecDelay(0.3)
                                    CardResult = DO_ReadPort(card, Channel_P1B, LightOFF)
                                    If LightOFF <> 255 And LightOFF <> 254 Then
                                            rv2 = 2
                                    End If
                                End If
                            End If
                             Call LabelMenu(2, rv2, rv1)
                            If rv2 <> 1 And rv2 <> 4 Then
                                   Label9.Caption = "TriState Test Fail "
                            End If
                             
                              
                            
                            
                       End If
                       
                       
                         If ChipName = "AU6332CF" Then
                            If LightOFF <> 252 Then
                               rv1 = 3
                            End If
                            
                            Call LabelMenu(1, rv1, rv0)
                            If rv1 <> 1 Then
                               Label9.Caption = "SD card Fail or GPO FAIL"
                            End If
                            
                       End If
                       
                  
                    
                   
                Else
                
                      ClosePipe
                    rv0 = CBWTest_New(0, 1, "vid_058f")
                    Call LabelMenu(0, rv0, 1)
                    ClosePipe
                     Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                    
                    Print "LBA="; LBA
                
                   
                     
                End If
                LBA = LBA + 1
               
                
                If rv0 = UNKNOW Then
                    UnknowDeviceFail = UnknowDeviceFail + 1
                    TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                 ElseIf rv1 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv1 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                 ElseIf rv2 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                    
                ElseIf rv0 = PASS Then
                    If ChipName = "AU6332CF" Then
                      If rv1 = 1 Then
                        TestResult = "PASS"
                      Else
                        TestResult = "Bin2"
                      End If
                    Else
                      TestResult = "PASS"
                    End If
                        
                    If ChipName = "AU6371CF" Then
                      If rv1 * rv2 = 1 Then
                        TestResult = "PASS"
                      Else
                        TestResult = "Bin2"
                      End If
                    Else
                      TestResult = "PASS"
                    End If
                        
                        
                Else
                    TestResult = "Bin2"
                End If
                
                If ChipName = "AU6332CF" Or ChipName = "AU6371CF" Then
                
                CardResult = DO_WritePort(card, Channel_P1A, &H1)
                End If
        Case "AU6331MS"
            
                LBA = LBA + 1
                TestResult = ""
                ChipName = ""
                
                '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                '
                '  R/W test
                '
                '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                
                'initial return value
                
                    rv0 = 0
                    rv1 = 0
                    rv2 = 0
                    rv3 = 0
                    
                    Label3.BackColor = RGB(255, 255, 255)
                    Label4.BackColor = RGB(255, 255, 255)
                    Label5.BackColor = RGB(255, 255, 255)
                    Label6.BackColor = RGB(255, 255, 255)
                    Label7.BackColor = RGB(255, 255, 255)
                    Label8.BackColor = RGB(255, 255, 255)
                
                ClosePipe
                    rv0 = CBWTest_New(0, 1, "vid_058f")
                    Call LabelMenu(3, rv0, 1)
                ClosePipe
                
                Print rv0, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print " <<<<<<<<<<<<<<<<<<------------------>>>>>>>>>>>>>>>>>>>>>>"
                Print "LBA="; LBA
                
                If rv0 = UNKNOW Then
                    UnknowDeviceFail = UnknowDeviceFail + 1
                    TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv0 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv0 = PASS Then
                    TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                End If
                
            Case "AU6366CF", "AU6390"
            
                LBA = LBA + 1
                TestResult = ""
                ChipName = ""
                
                '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                '
                '  R/W test
                '
                '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                
                'initial return value
                
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                
                ClosePipe
                    rv0 = CBWTest_New(0, 1, "vid_058f")
                    Call LabelMenu(1, rv0, 1)
                ClosePipe
                
                Print rv0, " \\CF :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print " <<<<<<<<<<<<<<<<<<------------------>>>>>>>>>>>>>>>>>>>>>>"
                Print "LBA="; LBA
                
                If rv0 = UNKNOW Then
                    UnknowDeviceFail = UnknowDeviceFail + 1
                    TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv0 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv0 = PASS Then
                    TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                End If
                
            Case "AU6366XD", "AU6369XD"
  
                LBA = LBA + 1
                TestResult = ""
                ChipName = ""
                
                '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                '
                '  R/W test
                '
                '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                
                'initial return value
                
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(2, rv0, 1)
                ClosePipe
                
                Print rv0, " \\XD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print " <<<<<<<<<<<<<<<<<<------------------>>>>>>>>>>>>>>>>>>>>>>"
                Print "LBA="; LBA
                
                If rv0 = UNKNOW Then
                UnknowDeviceFail = UnknowDeviceFail + 1
                TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                XDWriteFail = XDWriteFail + 1
                TestResult = "XD_WF"
                ElseIf rv0 = READ_FAIL Then
                XDReadFail = XDReadFail + 1
                TestResult = "XD_RF"
                
                ElseIf rv0 = PASS Then
                TestResult = "PASS"
                Else
                TestResult = "Bin2"
                End If
                
            Case "AU6366MS"
       
                LBA = LBA + 1
                TestResult = ""
                ChipName = ""
                
                '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                '
                '  R/W test
                '
                '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                
                'initial return value
                
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(3, rv0, 1)
                ClosePipe
                
                Print rv0, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print " <<<<<<<<<<<<<<<<<<------------------>>>>>>>>>>>>>>>>>>>>>>"
                Print "LBA="; LBA
                
                If rv0 = UNKNOW Then
                UnknowDeviceFail = UnknowDeviceFail + 1
                TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                MSWriteFail = MSWriteFail + 1
                TestResult = "MS_WF"
                ElseIf rv0 = READ_FAIL Then
                MSReadFail = MSReadFail + 1
                TestResult = "MS_RF"
                
                ElseIf rv0 = PASS Then
                TestResult = "PASS"
                Else
                TestResult = "Bin2"
                End If
                
            Case "AU6368_S"
                        
                LBA = LBA + 1
                ClosePipe
                rv3 = CBWTest_New(3, 1, "vid_058f")
                'rv3 = CBWTest(3, 1)
                Call LabelMenu(3, rv3, 1)
                ClosePipe
                               
                If rv3 = UNKNOW Then 'If rv3 = UNKNOW_DEVICE Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv3 = PASS Then 'Arch define 940410
                   TestResult = "PASS"
                ElseIf rv3 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                Else
                    TestResult = "Bin2"
                End If
                        
                                
                Print rv3, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
               
          
               
               
                
             Case "AU6368A", "AU6368A1", "AU6376", "AU6370BL"
            
                 
               
                ' open power
                
            '    PowerSet (1) ' for 3.3V , 2.5 V
                
            
                'GPIO control setting
                If ChipName = "AU6370BL" Then
                
                ChipName = "AU6376"
                
                End If
                
            
                If PCI7248InitFinish = 0 Then
                  PCI7248Exist
                End If
                
                   result = DIO_PortConfig(card, Channel_P1B, OUTPUT_PORT)
            
                    CardResult = DO_WritePort(card, Channel_P1B, &H0)
                    
                 If ChipName = "AU6368A" Then
                    CardResult = DO_WritePort(card, Channel_P1A, &H7F)  ' 0111 1111
                    result = DIO_PortConfig(card, Channel_P1B, INPUT_PORT)
                  End If
                   If ChipName = "AU6368A1" Or ChipName = "AU6376" Then
                    result = DIO_PortConfig(card, Channel_P1B, INPUT_PORT)
                    CardResult = DO_WritePort(card, Channel_P1A, &H3E)  ' 1111 1110
                   
                  End If
                  
                Call MsecDelay(2)
               
               LBA = LBA + 1
                
                
                '//////////////////////////////////////////////////
                '
                '   no card insert
                '
                '/////////////////////////////////////////////////
                
                
                Print LBA
                
                ClosePipe
                 rv0 = CBWTest_New_no_card(0, 1, "vid_058f")
                'Print "a1"
                Call LabelMenu(0, rv0, 1)
                ClosePipe
                rv1 = CBWTest_New_no_card(1, rv0, "vid_058f")
               '  Print "a2"
                Call LabelMenu(1, rv1, rv0)
                ClosePipe
                
               rv2 = CBWTest_New_no_card(2, rv1, "vid_058f")
               '  Print "a3"
                Call LabelMenu(2, rv2, rv1)
                ClosePipe
                 rv3 = CBWTest_New_no_card(3, rv2, "vid_058f")
                ' Print "a4"
                ClosePipe
                Call LabelMenu(3, rv3, rv2)
                
        
                
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv1 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                 ElseIf rv3 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv3 * rv2 * rv1 * rv0 = PASS Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                  
                End If
                
                Print "Test Result"; TestResult
                       
       
                 
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 card change bit fail"
                Print rv1, " \\CF :0 Unknow device, 1 pass ,2 card change bit fail"
                Print rv2, " \\XD :0 Unknow device, 1 pass ,2 card change bit fail"
                Print rv3, " \\MS :0 Unknow device, 1 pass ,2 card change bit fail"
                 
                If TestResult = "PASS" Then
                  
                   If ChipName = "AU6368A" Then
                    CardResult = DO_WritePort(card, Channel_P1A, &H64)  ' 0110 0100
                   End If
                   
                   If ChipName = "AU6368A1" Then
                    CardResult = DO_WritePort(card, Channel_P1A, &H20)  ' 0010 0000
                   End If
                   
                   If ChipName = "AU6376" Then
                    CardResult = DO_WritePort(card, Channel_P1A, &H10)  ' 0110 0100
                   End If
                   Call MsecDelay(0.1)
                 
                 '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                 '
                 '  R/W test
                 '
                 '\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
                 
                
                'initial return value
                
                
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
               
                Label3.BackColor = RGB(255, 255, 255)
                Label4.BackColor = RGB(255, 255, 255)
                Label5.BackColor = RGB(255, 255, 255)
                Label6.BackColor = RGB(255, 255, 255)
                Label7.BackColor = RGB(255, 255, 255)
                Label8.BackColor = RGB(255, 255, 255)
                
                ClosePipe
                 rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(0, rv0, 1)
                ClosePipe
                 rv1 = CBWTest_New(1, rv0, "vid_058f")
                Call LabelMenu(1, rv1, rv0)
                ClosePipe
              
                rv2 = CBWTest_New(2, rv1, "vid_058f")
                Call LabelMenu(2, rv2, rv1)
                ClosePipe
       
                rv3 = CBWTest_New(3, rv2, "vid_058f")
                ClosePipe
                 Call LabelMenu(3, rv3, rv2)
                 
                 If ChipName = "AU6368A1" Then
                 Call MsecDelay(0.1)
                  rv4 = 1
                  CardResult = DO_ReadPort(card, Channel_P1B, LightOFF)
                                 If LightOFF <> 192 Then
                                   UsbSpeedTestResult = GPO_FAIL
                                  rv4 = 2
                                 End If
                     Call LabelMenu(3, rv4, rv3)
                     
                       CardResult = DO_ReadPort(card, Channel_P1B, LightOFF)
                                 
                 End If
                 
                  If ChipName = "AU6376" Then
                  Call MsecDelay(0.1)
                  rv4 = 1
                  CardResult = DO_ReadPort(card, Channel_P1B, LightOFF)
                                 If LightOFF <> 252 Then
                                   UsbSpeedTestResult = GPO_FAIL
                                  rv4 = 2
                                 End If
                     Call LabelMenu(3, rv4, rv3)
                     
                        
                 End If
                 
                If ChipName = "AU6368A" Then
                    If rv3 = 1 Then
                           CardResult = DO_WritePort(card, Channel_P1A, &H74)  ' 0111 0100
                           Call MsecDelay(0.1)
                           CardResult = DO_WritePort(card, Channel_P1A, &H54)  ' 0101 0100
                           Call MsecDelay(0.1)
                           rv4 = CBWTest_New(3, rv3, "vid_058f")
                             ClosePipe
                           If rv4 = 1 Then
                                  CardResult = DO_ReadPort(card, Channel_P1B, LightOFF)
                                 If LightOFF <> 132 Then
                                   UsbSpeedTestResult = GPO_FAIL
                                    rv4 = 2
                                 End If
                             End If
                         Else
                         rv4 = 4
                         End If
                         Call LabelMenu(3, rv4, rv3)
                 End If
                
                
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv1, " \\CF :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv2, " \\XD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv3, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv4, " \\MSPro :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                
              
                        
                        If rv0 = UNKNOW Then
                           UnknowDeviceFail = UnknowDeviceFail + 1
                           TestResult = "UNKNOW"
                        ElseIf rv0 = WRITE_FAIL Then
                            SDWriteFail = SDWriteFail + 1
                            TestResult = "SD_WF"
                        ElseIf rv0 = READ_FAIL Then
                            SDReadFail = SDReadFail + 1
                            TestResult = "SD_RF"
                        ElseIf rv1 = WRITE_FAIL Then
                            CFWriteFail = CFWriteFail + 1
                            TestResult = "CF_WF"
                        ElseIf rv1 = READ_FAIL Then
                            CFReadFail = CFReadFail + 1
                            TestResult = "CF_RF"
                        ElseIf rv2 = WRITE_FAIL Then
                            XDWriteFail = XDWriteFail + 1
                            TestResult = "XD_WF"
                        ElseIf rv2 = READ_FAIL Then
                            XDReadFail = XDReadFail + 1
                            TestResult = "XD_RF"
                         ElseIf rv3 = WRITE_FAIL Or rv4 = WRITE_FAIL Then
                            MSWriteFail = MSWriteFail + 1
                            TestResult = "MS_WF"
                        ElseIf rv3 = READ_FAIL Or rv4 = READ_FAIL Then
                            MSReadFail = MSReadFail + 1
                            TestResult = "MS_RF"
                        ElseIf rv4 * rv3 * rv2 * rv1 * rv0 = PASS Then
                             TestResult = "PASS"
                        Else
                            TestResult = "Bin2"
                          
                        End If
                
               
                  
                End If
                CardResult = DO_WritePort(card, Channel_P1A, &H1)
                  result = DIO_PortConfig(card, Channel_P1B, OUTPUT_PORT)
            
                    CardResult = DO_WritePort(card, Channel_P1B, &H0)
                    
               
            Case "AU6363", "AU9368_1", "AU6368", "AU6375"
            
                 
                LBA = LBA + 1
                
            
               
                
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(0, rv0, 1)
                ClosePipe
                rv1 = CBWTest_New(1, rv0, "vid_058f")
                Call LabelMenu(1, rv1, rv0)
                ClosePipe
                rv2 = CBWTest_New(2, rv1, "vid_058f")
                Call LabelMenu(2, rv2, rv1)
                ClosePipe
                rv3 = CBWTest_New(3, rv2, "vid_058f")
                Call LabelMenu(3, rv3, rv2)
                ClosePipe
                
                
                
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv1, " \\CF :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv2, " \\XD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv3, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                
                
                'If rv0 = 1 And rv1 = 1 And rv2 = 1 And rv3 = 1 Then
                   ' TestResult = "PASS"
                'End If
                
                
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv1 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                 ElseIf rv3 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv3 * rv2 * rv1 * rv0 = PASS Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                  
                End If
                
               ' If rv2 * rv3 * rv1 = 0 Then
                '    MsgBox "rturn error"
                'End If
                
                
                
                
            Case "AU6369S2", "AU6373S2"
            
            
                LBA = LBA + 1
                ClosePipe
                rv3 = CBWTest_New(3, 1, "vid_058f")
                'rv0 = CBWTest(0, 1)
                
                Call LabelMenu(3, rv3, 1)
                ClosePipe
                rv0 = CBWTest_New(0, rv3, "vid_058f")
                'rv3 = CBWTest(3, rv0)
                Call LabelMenu(0, rv0, rv3)
                'rv3 = CBWTest(3, 1)    'arch change 940415
                'Call LabelMenu(3, rv3, 1) 'arch change 940415
                ClosePipe
                'rv0 = CBWTest(0, rv3) 'arch change 940415
                'Call LabelMenu(0, rv0, rv3) 'arch change 940415
                             
                
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv3, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                
                
                If rv3 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv1 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                ElseIf rv3 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv0 * rv3 = PASS Then
                     TestResult = "PASS"
                Else
                      TestResult = "Bin2"
                     
                End If
                
                
                If rv0 = 0 Then
                    MsgBox "return error"
                
                End If
                
                
                 Case "AU6334"
            
            
                LBA = LBA + 1
                ClosePipe
                
                rv1 = CBWTest_New(1, 1, "vid_058f")
                Call LabelMenu(1, rv1, 1) 'arch change 940415
  
                ClosePipe
                rv0 = CBWTest_New(0, rv1, "vid_058f")
                Call LabelMenu(0, rv0, rv1) 'arch change 940415
                ClosePipe
                rv2 = CBWTest_New(2, rv0, "vid_058f")
                Call LabelMenu(2, rv2, rv0) 'arch change 940415
                ClosePipe
                
                
                
                Print rv0, " \\MMC:0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv1, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv2, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                
                
              If rv1 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv1 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                 ElseIf rv3 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv2 * rv0 * rv1 = PASS Then
                     TestResult = "PASS"
                Else
                     TestResult = "Bin2"
                     
                End If
                 
                 If rv0 * rv2 = 0 Then
                    MsgBox "return error"
                 End If
                
            Case "AU6369S3"
            
            
                LBA = LBA + 1
                ClosePipe
                
                   rv3 = CBWTest_New(3, 1, "vid_058f")
                    Call LabelMenu(3, rv3, 1) 'arch change 940415
  
                ClosePipe
                rv0 = CBWTest_New(0, rv3, "vid_058f")
                Call LabelMenu(0, rv0, rv3) 'arch change 940415
                ClosePipe
                rv2 = CBWTest_New(2, rv0, "vid_058f")
                Call LabelMenu(2, rv2, rv0) 'arch change 940415
                ClosePipe
                
                
                
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv2, " \\XD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv3, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                
                
              If rv3 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv1 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                 ElseIf rv3 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv2 * rv0 * rv3 = PASS Then
                     TestResult = "PASS"
                Else
                     TestResult = "Bin2"
                     
                End If
                 
                 If rv0 * rv2 = 0 Then
                    MsgBox "return error"
                 End If
                 
            Case "AU63693F"
                rv0 = 0
                rv1 = 0
                rv2 = 0
                rv3 = 0
                rv4 = 0
                rv5 = 0
                rv6 = 0
                rv7 = 0
            
                LBA = LBA + 1
                ClosePipe
                rv3 = CBWTest_New(3, 1, "vid_058f")
                Call LabelMenu(3, rv3, 1)
                ClosePipe
                
                rv0 = CBWTest_New(0, rv3, "vid_058f")
                Call LabelMenu(0, rv0, rv3)
                ClosePipe
                
                rv2 = CBWTest_New(2, rv0, "vid_058f")
                Call LabelMenu(2, rv2, rv0)
                ClosePipe
                
                LBA = OldLba
                rv7 = CBWTest_New_8_Sector(3, rv2, FailPosition, 20)
                Call LabelMenu(3, rv7, rv2)
                ClosePipe
                
                LBA = OldLba
                rv4 = CBWTest_New_8_Sector(0, rv7, FailPosition, 20)
                Call LabelMenu(0, rv4, rv7)
                ClosePipe
                
                LBA = OldLba
                rv6 = CBWTest_New_8_Sector(2, rv4, FailPosition, 20)
                Call LabelMenu(2, rv6, rv4)
                ClosePipe
                
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv2, " \\XD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv3, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                
                Print rv4, " \\SD stress :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv6, " \\MS stress :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv7, " \\MS stress :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                
        
                If rv3 = UNKNOW Then
                    UnknowDeviceFail = UnknowDeviceFail + 1
                    TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Or rv4 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Or rv4 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv2 = WRITE_FAIL Or rv6 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Or rv6 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                ElseIf rv3 = WRITE_FAIL Or rv7 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Or rv7 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv0 * rv2 * rv3 * rv4 * rv6 * rv7 = PASS Then
                    TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                End If
     
                 
            Case "AU63692F"
                
               
                LBA = LBA + 1
                 OldLba = LBA
                ClosePipe
                      
                rv3 = CBWTest_New(3, 1, "vid_058f")
                
                
                Call LabelMenu(3, rv3, 1)
                ClosePipe
                rv0 = CBWTest_New(0, rv3, "vid_058f")
             
                Call LabelMenu(0, rv0, rv3)
              
                ClosePipe
               
                LBA = OldLba
                rv7 = CBWTest_New_8_Sector(3, rv0, FailPosition, 20)
                LBA = OldLba
                Call LabelMenu(3, rv7, rv0)
                ClosePipe
                rv4 = CBWTest_New_8_Sector(0, rv7, FailPosition, 20)
                 Call LabelMenu(0, rv4, rv7)
                ClosePipe
                
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv3, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv4, " \\SD stress :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv7, " \\MS stress :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                Print "FailPosition="; FailPosition
                
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Or rv4 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Or rv4 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Or rv5 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv1 = READ_FAIL Or rv5 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Or rv6 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Or rv6 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                ElseIf rv3 = WRITE_FAIL Or rv7 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Or rv7 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv7 * rv4 * rv3 * rv0 = PASS Then
                     TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                     
                End If
                     
                 
                 
         
                
                
            
            Case "AU6330", "AU6385", "AU6386", "AU6386_D", "AU6385_1", "AU6385_2", "AU9386", "AU6388", "AU6389", "AU6980", "AU6980AN"
            
            '//*LabelMenu(SlotNo As Byte, TestResult As Byte, PreSlotStatus As Byte)
                
                   If ChipName = "AU6980AN" Then
                    If PCI7248InitFinish = 0 Then
                      PCI7248Exist
                    End If
                
                   result = DIO_PortConfig(card, Channel_P1B, OUTPUT_PORT)
            
                    CardResult = DO_WritePort(card, Channel_P1B, &H0)
                    
                    CardResult = DO_WritePort(card, Channel_P1A, &H1)  ' 1111 1110
                    Call MsecDelay(0.03)
                    result = DIO_PortConfig(card, Channel_P1B, INPUT_PORT)
                    CardResult = DO_WritePort(card, Channel_P1A, &H0)  ' 1111 1110
                    Call MsecDelay(1.2)
                   End If
                
                  
                
                
                LBA = LBA + 1
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(0, rv0, 1)
                ClosePipe
               ' If rv0 = 1 Then
               '     TestResult = "PASS"
               ' End If
               
                 If rv0 = 1 And ChipName = "AU6980AN" Then
                 rv1 = 1
                     CardResult = DO_ReadPort(card, Channel_P1B, LightON)
                     If LightON <> 254 Then
                        rv1 = 2
                     End If
                 End If
               
                Print rv0, " \\ : 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                If ChipName = "AU6980AN" Then
                   Print rv1, " \\ : 1 GPO pass ,2 : GPO fail"
                   Call LabelMenu(2, rv1, rv0)
                   If rv1 = 2 Then
                   Label9.Caption = "GPO Fail"
                   End If
                End If
                Print "LBA="; LBA
            
            
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv0 = PASS Then
                     TestResult = "PASS"
                     If ChipName = "AU6980AN" Then
                        If rv0 * rv1 = 1 Then
                         TestResult = "PASS"
                        Else
                          TestResult = "Bin3"
                      End If
                    End If
                Else
                      TestResult = "Bin2"
                End If
            
            Case "AU6388F", "AU6386DF", "AU6389F", "AU6980F"
                
                '//*LabelMenu(SlotNo As Byte, TestResult As Byte, PreSlotStatus As Byte)
                
                LBA = LBA + 1
                OldLba = LBA
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(0, rv0, 1)
                ClosePipe
                
                LBA = OldLba
                ClosePipe
                rv4 = CBWTest_New_8_Sector(0, rv0, FailPosition, 20)
                Call LabelMenu(0, rv4, rv0)
                ClosePipe
                
                
                
                Print rv0, " Flash \\ : 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv4, " Flash stress\\ : 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                Print "FailPosition="; FailPosition
                
                If rv0 = UNKNOW Then
                    UnknowDeviceFail = UnknowDeviceFail + 1
                    TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Or rv4 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Or rv4 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv4 * rv0 = PASS Then
                    TestResult = "PASS"
                Else
                    TestResult = "Bin2"
                End If
                
            Case "AU9368"
            
                LBA = LBA + 1
                OldLba = LBA
                ClosePipe
                rv0 = CBWTest_New(0, 1, "vid_058f")
                Call LabelMenu(0, rv0, 1)
                '//*LabelMenu(SlotNo As Byte, TestResult As Byte, PreSlotStatus As Byte)
                ClosePipe
                rv1 = CBWTest_New(1, rv0, "vid_058f")
                Call LabelMenu(1, rv1, rv0)
                ClosePipe
                rv2 = CBWTest_New(2, rv1, "vid_058f")
                Call LabelMenu(2, rv2, rv1)
                ClosePipe
                rv3 = CBWTest_New(3, rv2, "vid_058f")
                Call LabelMenu(3, rv3, rv2)
                ClosePipe
                rv4 = CBWTest_New_8_Sector(2, rv3, FailPosition, 64)
                LBA = OldLba
                Call LabelMenu(2, rv4, rv3)
                ClosePipe
                rv5 = CBWTest_New_8_Sector(3, rv4, FailPosition, 64)
                LBA = OldLba
                Call LabelMenu(3, rv5, rv4)
                ClosePipe
                Print rv0, " \\SD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv1, " \\CF :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv2, " \\XD :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv3, " \\MS :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv4, " \\XD stress :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print rv5, " \\MS stress :0 Unknow device, 1 pass ,2 write fail, 3 read fail, 4 preious slot fail"
                Print "LBA="; LBA
                Print "FailPosition="; FailPosition
                
                
                If rv0 = UNKNOW Then
                   UnknowDeviceFail = UnknowDeviceFail + 1
                   TestResult = "UNKNOW"
                ElseIf rv0 = WRITE_FAIL Then
                    SDWriteFail = SDWriteFail + 1
                    TestResult = "SD_WF"
                ElseIf rv0 = READ_FAIL Then
                    SDReadFail = SDReadFail + 1
                    TestResult = "SD_RF"
                ElseIf rv1 = WRITE_FAIL Then
                    CFWriteFail = CFWriteFail + 1
                    TestResult = "CF_WF"
                ElseIf rv1 = READ_FAIL Then
                    CFReadFail = CFReadFail + 1
                    TestResult = "CF_RF"
                ElseIf rv2 = WRITE_FAIL Or rv4 = WRITE_FAIL Then
                    XDWriteFail = XDWriteFail + 1
                    TestResult = "XD_WF"
                ElseIf rv2 = READ_FAIL Or rv4 = READ_FAIL Then
                    XDReadFail = XDReadFail + 1
                    TestResult = "XD_RF"
                ElseIf rv3 = WRITE_FAIL Or rv5 = WRITE_FAIL Then
                    MSWriteFail = MSWriteFail + 1
                    TestResult = "MS_WF"
                ElseIf rv3 = READ_FAIL Or rv5 = READ_FAIL Then
                    MSReadFail = MSReadFail + 1
                    TestResult = "MS_RF"
                ElseIf rv5 * rv4 * rv3 * rv2 * rv2 * rv0 = PASS Then
                     TestResult = "PASS"
                End If
                
             '    If rv5 * rv4 * rv3 * rv2 * rv1 = 0 Then
             '       MsgBox "return error"
            '    End If
                
                
                 
           
                
             Case "AU9520"
                PreviousStatus = 0
                TestResultadd = "FAIL"
                TestResultSmartCard = "FAIL"
                ArchTest = False
                
                Cls
                ' txtmsg.Text = ""
                
                strReaderName = VenderString & " " & ProductString & " 0"   'slot 0
                udtReaderStates(0).szReader = strReaderName & vbNullChar
                txtmsg.Text = udtReaderStates(0).szReader
                
                Print "Start to test slot0 !"
                Call StartTest
                
                If ArchTest = True Then
                    Print "slot0 test ok!"
                    
                    strReaderName = VenderString & " " & ProductString & " 1"   'slot 1
                    udtReaderStates(0).szReader = strReaderName & vbNullChar
                    txtmsg.Text = udtReaderStates(0).szReader
                    
                    Print "Start to test slot1 !"
                    Call StartTest
                    Print "slot1 test ok!"
                Else
                    Print "slot1 not test !"
                End If
                
                'If TestResultSmartCard = "PASS" Then
               
                '    TestResult = "PASS"
                'Else
                  '  TestResult = "FAIL"
                'End If
                
                If ArchTest = True Then      'Arch define 940410
                    If TestResultSmartCard = "PASS" Then
                        TestResult = "PASS"
                    Else
                        TestResult = "Bin3"
                    End If
                Else
                    TestResult = "Bin2"
                End If
                
                
           ' Case "AU9720"
            
               ' Dim trans1 As Integer
               ' Dim trans2 As Integer
                
                  '  Text1.Text = ""
                   ' Text2.Text = ""
                'Cls
                   ' MSComm2.PortOpen = False
                   ' MSComm3.PortOpen = False
               ' Call MsecDelay(0.1)
                   ' MSComm2.PortOpen = True
                   ' MSComm3.PortOpen = True
                'Call MsecDelay(0.1)
                
                    'MSComm2.Output = "ArchTestFirst"
                
               ' Call MsecDelay(0.03)
                
                  '  Text1.Text = MSComm3.Input
                
               ' If Text1.Text = "ArchTestFirst" Then
                  '  trans1 = 1
                'Else
                  '  trans1 = 0
               ' End If
                
                   ' MSComm3.Output = "ArchTestSecond"
                
               ' Call MsecDelay(0.03)
                
                   ' Text2.Text = MSComm2.Input
                
               ' If Text2.Text = "ArchTestSecond" Then
                  '  trans2 = 1
               ' Else
                '    trans2 = 0
               ' End If
                
               ' If trans1 = 1 And trans2 = 1 Then
                    ' AU9720Test = 1
                 '   TestResult = "PASS"
               ' End If
                
            Case Else
            
                Label1.Caption = "Comm Err!!"
                
                Print "Comm Err!!"
                MsgBox "Comm err!1"
                
            
        End Select
        
            
                      
      Print "Previous TestTime:"; Timer - oldtime
      'MsgBox Timer - oldtime
            
      'If TestResult = "PASS" Then
         
        ' Label2 = "PASS!"
         
        ' Label8.BackColor = RGB(0, 255, 0)
         'goodchip = goodchip + 1
      'Else
    
         'Label2 = "fail!"
         
         'Label8.BackColor = RGB(255, 0, 0)
         'failchip = failchip + 1
      'End If
        If TestResult = "PASS" Then  'arch change 940411
        
            Label2 = "PASS!"
            Label8.BackColor = RGB(0, 255, 0)
            goodchip = goodchip + 1
            
        ElseIf TestResult = "Bin2" Or TestResult = "UNKNOW" Then
        
            failchipBin2 = failchipBin2 + 1
            Label2 = "fail!"
            Label8.BackColor = RGB(255, 0, 0)
            failchip = failchip + 1
            
        ElseIf TestResult = "Bin3" Or TestResult = "SD_WF" Or TestResult = "SD_RF" Or TestResult = "CF_WF" Or TestResult = "CF_RF" Then
        
            failchipBin3 = failchipBin3 + 1
            Label2 = "SDfail!"
            Label8.BackColor = RGB(255, 0, 0)
            failchip = failchip + 1
            
        ElseIf TestResult = "Bin4" Or TestResult = "XD_WF" Or TestResult = "XD_RF" Then
        
            failchipBin4 = failchipBin4 + 1
            Label2 = "XD fail!"
            Label8.BackColor = RGB(255, 0, 0)
            failchip = failchip + 1
            
        ElseIf TestResult = "Bin5" Or TestResult = "MS_WF" Or TestResult = "MS_RF" Then
        
            failchipBin5 = failchipBin5 + 1
            Label2 = "MS fail!        "
            Label8.BackColor = RGB(255, 0, 0)
            failchip = failchip + 1
            
         
            
        Else
        
            Label2 = "fail!"
            Label8.BackColor = RGB(255, 0, 0)
            failchip = failchip + 1
            
        End If
  
    MSComm1.Output = TestResult
    Call MsecDelay(0.1) 'arch add
    Print "TestResulr :"; TestResult
     
    Text3.Text = goodchip
    Text4.Text = failchip
    Text5.Text = failchipBin2 'arch add 940411
    Text6.Text = failchipBin3 'arch add 940411
    Text7.Text = failchipBin4 'arch add 940411
    Text8.Text = failchipBin5 'arch add 940411
    
    '\\\\\\\\\\\\\\\\\
    ' Software Bin Counter
    '\\\\\\\\\\\\\\\\\
    
    Text9.Text = UnknowDeviceFail
    Text13.Text = SDWriteFail
    Text14.Text = SDReadFail
    Text15.Text = CFWriteFail
    Text16.Text = CFReadFail
    
    Text17.Text = XDWriteFail
    Text18.Text = XDReadFail
    
    Text21.Text = MSWriteFail
    Text22.Text = MSReadFail
  
    
    MSComm1.InBufferCount = 0
    MSComm1.InputLen = 0
'========================

   ' Do
       'MSComm1.Output = "Ready"
        
        'Print TesterReadyCounter
       ' DoEvents
        'Call MsecDelay(0.1) ' comm time
      ' Endmsg = MSComm1.Input
        fnScsi2usb2K_KillEXE ' clear removable device message box
        
   ' Loop Until InStr(1, Endmsg, "testend") <> 0
       
    ' Endmsg = ""
     
Loop While AllenTest = 0


End Sub




'Private Sub cmdAT45D041_Click()
'fmAT45D041_1.Show vbModal
'End Sub


'Private Sub cmdClose_Click()
'bReadyToClose = True
'Unload fmMain
'End Sub











'Private Sub cmdStartTest_Click()
  '  cmdStartTest.Enabled = False
  '  cmdStopTest.Enabled = True
  '  cmdClose.Enabled = False

  '  Call StartTest
'End Sub

'Private Sub cmdStopTest_Click()
'bStop = True
'cmdStartTest.Enabled = True
'cmdStopTest.Enabled = False
'cmdClose.Enabled = True

'End Sub




Public Sub Form_Unload(Cancel As Integer)
    Dim lngResult As Long
   
    If (bReadyToClose = False) Then
        Cancel = True
        Exit Sub
    End If
    
    'Scarddisconnect will cold reset the card and then power down the card.
    'if the EEPROM card presents, the function will take several seconds to cold reset it 3 times(because of time out).
    'for save time to close the program, this function can be deleted from the code, and the pc/sc subsystem will
    ' automatically do the function after the program is terminated.
    lngResult = SCardDisconnect(lngCard, SCARD_LEAVE_CARD) 'disconnect the connection with the reader
    lngResult = SCardReleaseContext(lngContext) ' release the connection with the resource manager
End Sub

'Public Sub Form_KeyUp(KeyCode As Integer, Shift As Integer)
 '   Select Case Chr(KeyCode)
  '      Case "R", "r"
'
 '           If cmdStartTest.Enabled = True Then Call cmdStartTest_Click

  '      Case "S", "s"
   '         If cmdStopTest.Enabled = True Then Call cmdStopTest_Click

   '     Case "X", "x"
    '        If cmdClose.Enabled = True Then Call cmdClose_Click

   ' End Select
'End Sub
'Public Sub Form_Keydown(KeyCode As Integer, Shift As Integer)
 '   Select Case Chr(KeyCode)
  '      Case "R", "r"
            
   '         If cmdStartTest.Enabled = True Then cmdStartTest.SetFocus
        
    '    Case "S", "s"
     '       If cmdStopTest.Enabled = True Then cmdStopTest.SetFocus
            
      '  Case "X", "x"
       '     If cmdClose.Enabled = True Then cmdClose.SetFocus
            
   ' End Select

'End Sub





Function CBWTest_New_ALPS(Lun As Byte, PreSlotStatus As Byte, Vid_PID As String) As Byte
Dim i As Integer
Dim WriteTest As Integer
Dim TmpString As String
Dim TmpInteger As Integer
Dim TimerCounter As Integer
Dim OldTimer
Dim CBWDataTransferLength As Long

   CBWDataTransferLength = 1024
 
'   For i = 0 To CBWDataTransferLength - 1
    
'         ReadData(i) = 0

'   Next

    If PreSlotStatus <> 1 Then
        CBWTest_New_ALPS = 4
        Exit Function
    End If
    '========================================
   
    CBWTest_New_ALPS = 0
  '   If Lba > 25 * 1024 Then
  '       Lba = 0
  '   End If
    '========================================
    
     TmpString = ""
    If ReaderExist = 0 Then
        Do
            DoEvents
            Call MsecDelay(0.1)
            TimerCounter = TimerCounter + 1
            TmpString = GetDeviceName(Vid_PID)
        Loop While TmpString = "" And TimerCounter < 10
    End If
    '=======================================
    If ReaderExist = 0 And TmpString <> "" Then
      ReaderExist = 1
    End If
    '=======================================
    If ReaderExist = 0 And TmpString = "" Then
      CBWTest_New_ALPS = 0   ' no readerExist
      ReaderExist = 0
      Exit Function
    End If
    '=======================================
    If OpenPipe = 0 Then
      CBWTest_New_ALPS = 2   ' Write fail
      Exit Function
    End If
    '======================================
    
      TmpInteger = TestUnitSpeed(Lun)
    
    If TmpInteger = 0 Then
        
       CBWTest_New_ALPS = 2   ' usb 2.0 high speed fail
       UsbSpeedTestResult = 2
       Exit Function
    End If
    TmpInteger = 0
    
    
    
    TmpInteger = TestUnitReady(Lun)
    If TmpInteger = 0 Then
        TmpInteger = RequestSense(Lun)
        
        If TmpInteger = 0 Then
        
           CBWTest_New_ALPS = 2  'Write fail
           Exit Function
        End If
        
    End If
    '======================================
   
    TmpInteger = Read_Data(LBA, Lun, CBWDataTransferLength)
      
    If TmpInteger = 0 Then
        CBWTest_New_ALPS = 2  'write fail
        Exit Function
    End If
    
      
    TmpInteger = Write_Data(LBA, Lun, CBWDataTransferLength)
     
    If TmpInteger = 0 Then
        CBWTest_New_ALPS = 2  'write fail
        Exit Function
    End If
    
    
    ' For ALPS  Issue
    TmpInteger = Read_Data(LBA + CLng(80000), Lun, CBWDataTransferLength)
    
    
    TmpInteger = Read_Data(LBA, Lun, CBWDataTransferLength)
     
    If TmpInteger = 0 Then
        CBWTest_New_ALPS = 3    'Read fail
        Exit Function
    End If
     
    For i = 0 To CBWDataTransferLength - 1
    
        If ReadData(i) <> Pattern(i) Then
          CBWTest_New_ALPS = 3    'Read fail
          Exit Function
        End If
    
    Next
    
    CBWTest_New_ALPS = 1
        
    
    End Function

Public Function AU6610Test() As Integer
On Error Resume Next
AU6610Test = Test

End Function

















Private Sub MP3_Rec_Click()

Print "begin record Mp3"
Dim i As Integer

                RecordMode = 1

                If PCI7248InitFinish = 0 Then
                  PCI7248Exist
                End If
              
               
             
                CardResult = DO_WritePort(card, Channel_P1A, &H8F)
                             
                 If CardResult <> 0 Then
                       MsgBox "Power off fail"
                       End
                  End If
                            ' mp3==================================================
                  Call MsecDelay(0.5)
                             
                  CardResult = DO_WritePort(card, Channel_P1A, &H9F)   ' MP3 Power Off
                               
                  Call MsecDelay(4)    'power on time and DAC initial time
                             
                             
                  CardResult = DO_WritePort(card, Channel_P1A, &H8F)   ' MP3 Power Off
                            
                           '  Call MsecDelay(3)    'play
                    
                     If CardResult <> 0 Then
                       MsgBox "Power on fail"
                       End
                    End If
                             
               
                   i = AU3130Test
              
                 
                    Open App.Path & "\MP3.txt" For Output As #4

                     For i = 0 To 100
                        Print #4, gnBuffer(i)
                     Next i
                  

                    Close #4

                    MsgBox "Recode MP3 ok"
End Sub

Private Sub Rec_MP31_Click()
Print "begin record Mp31"
Dim i As Integer

                RecordMode = 1

                If PCI7248InitFinish = 0 Then
                  PCI7248Exist
                End If
              
               
             
                CardResult = DO_WritePort(card, Channel_P1A, &H8F)
                             
                 If CardResult <> 0 Then
                       MsgBox "Power off fail"
                       End
                  End If
                            ' mp3==================================================
                  Call MsecDelay(0.5)
                             
                  CardResult = DO_WritePort(card, Channel_P1A, &H9F)   ' MP3 Power Off
                               
                  Call MsecDelay(4)    'power on time and DAC initial time
                             
                             
                  CardResult = DO_WritePort(card, Channel_P1A, &H8F)   ' MP3 Power Off
                            
                           '  Call MsecDelay(3)    'play
                    
                     If CardResult <> 0 Then
                       MsgBox "Power on fail"
                       End
                    End If
                             
               
                   i = AU3130Test
              
                 
                    Open App.Path & "\MP31.txt" For Output As #4

                     For i = 0 To 100
                        Print #4, gnBuffer(i)
                     Next i
                  

                    Close #4

                    MsgBox "Recode MP31 ok"
End Sub

Private Sub Rec_MP32_Click()
Print "begin record Mp32"
Dim i As Integer

                RecordMode = 1

                If PCI7248InitFinish = 0 Then
                  PCI7248Exist
                End If
              
               
             
                CardResult = DO_WritePort(card, Channel_P1A, &H8F)
                             
                 If CardResult <> 0 Then
                       MsgBox "Power off fail"
                       End
                  End If
                            ' mp3==================================================
                  Call MsecDelay(0.5)
                             
                  CardResult = DO_WritePort(card, Channel_P1A, &H9F)   ' MP3 Power Off
                               
                  Call MsecDelay(4)    'power on time and DAC initial time
                             
                             
                  CardResult = DO_WritePort(card, Channel_P1A, &H8F)   ' MP3 Power Off
                            
                           '  Call MsecDelay(3)    'play
                    
                     If CardResult <> 0 Then
                       MsgBox "Power on fail"
                       End
                    End If
                             
               
                   i = AU3130Test
              
                 
                    Open App.Path & "\MP32.txt" For Output As #4

                     For i = 0 To 100
                        Print #4, gnBuffer(i)
                     Next i
                  

                    Close #4

                    MsgBox "Recode MP32 ok"
End Sub

Private Sub Rec_Mp33_Click()
Print "begin record Mp33"
Dim i As Integer

                RecordMode = 1

                If PCI7248InitFinish = 0 Then
                  PCI7248Exist
                End If
              
               
             
                CardResult = DO_WritePort(card, Channel_P1A, &H8F)
                             
                 If CardResult <> 0 Then
                       MsgBox "Power off fail"
                       End
                  End If
                            ' mp3==================================================
                  Call MsecDelay(0.5)
                             
                  CardResult = DO_WritePort(card, Channel_P1A, &H9F)   ' MP3 Power Off
                               
                  Call MsecDelay(4)    'power on time and DAC initial time
                             
                             
                  CardResult = DO_WritePort(card, Channel_P1A, &H8F)   ' MP3 Power Off
                            
                           '  Call MsecDelay(3)    'play
                    
                     If CardResult <> 0 Then
                       MsgBox "Power on fail"
                       End
                    End If
                             
               
                   i = AU3130Test
              
                 
                    Open App.Path & "\MP33.txt" For Output As #4

                     For i = 0 To 100
                        Print #4, gnBuffer(i)
                     Next i
                  

                    Close #4

                    MsgBox "Recode MP33 ok"
End Sub

Private Sub Rec_Mp34_Click()
Print "begin record Mp34"
Dim i As Integer

                RecordMode = 1

                If PCI7248InitFinish = 0 Then
                  PCI7248Exist
                End If
              
               
             
                CardResult = DO_WritePort(card, Channel_P1A, &H8F)
                             
                 If CardResult <> 0 Then
                       MsgBox "Power off fail"
                       End
                  End If
                            ' mp3==================================================
                  Call MsecDelay(0.5)
                             
                  CardResult = DO_WritePort(card, Channel_P1A, &H9F)   ' MP3 Power Off
                               
                  Call MsecDelay(4)    'power on time and DAC initial time
                             
                             
                  CardResult = DO_WritePort(card, Channel_P1A, &H8F)   ' MP3 Power Off
                            
                           '  Call MsecDelay(3)    'play
                    
                     If CardResult <> 0 Then
                       MsgBox "Power on fail"
                       End
                    End If
                             
               
                   i = AU3130Test
              
                 
                    Open App.Path & "\MP34.txt" For Output As #4

                     For i = 0 To 100
                        Print #4, gnBuffer(i)
                     Next i
                  

                    Close #4

                    MsgBox "Recode MP34 ok"
End Sub
